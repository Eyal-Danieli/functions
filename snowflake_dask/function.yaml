kind: job
metadata:
  name: snowflake-dask
  tag: ''
  hash: c71a0f026e7bf0011affce526ddcfa93cc83d715
  project: snowflake-dask
  labels:
    author: xingsheng
  categories:
  - data-prep
  credentials:
    access_key: ec09bfc8-1cb4-466d-9049-852081973ce3
spec:
  command: ''
  args: []
  image: .mlrun/func-snowflake-dask-snowflake-dask:latest
  build:
    functionSourceCode: IiIiU25vd2ZsYWtlIERhc2sgLSBJbmdlc3QgU25vd2ZsYWtlIGRhdGEgd2l0aCBEYXNrIiIiCmltcG9ydCB3YXJuaW5ncwppbXBvcnQgbWxydW4KZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmltcG9ydCBzbm93Zmxha2UuY29ubmVjdG9yIGFzIHNub3cKZnJvbSBkYXNrLmRpc3RyaWJ1dGVkIGltcG9ydCBDbGllbnQKZnJvbSBkYXNrLmRhdGFmcmFtZSBpbXBvcnQgZnJvbV9kZWxheWVkCmZyb20gZGFzayBpbXBvcnQgZGVsYXllZApmcm9tIGRhc2sgaW1wb3J0IGRhdGFmcmFtZSBhcyBkZApmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQuYmFja2VuZHMgaW1wb3J0IGRlZmF1bHRfYmFja2VuZApmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQucHJpbWl0aXZlcyBpbXBvcnQgc2VyaWFsaXphdGlvbgoKd2FybmluZ3MuZmlsdGVyd2FybmluZ3MoImlnbm9yZSIpCgpAZGVsYXllZApkZWYgbG9hZChiYXRjaCk6CgogICAgIiIiQSBkZWxheWVkIGxvYWQgb25lIGJhdGNoLiIiIgoKICAgIHRyeToKICAgICAgICBwcmludCgiQkFUQ0hJTkciKQogICAgICAgIGRmXyA9IGJhdGNoLnRvX3BhbmRhcygpCiAgICAgICAgcmV0dXJuIGRmXwogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiRmFpbGVkIG9uIHtiYXRjaH0gZm9yIHtlfSIpCiAgICAgICAgcmFpc2UKCmRlZiBsb2FkX3Jlc3VsdHMoY29udGV4dDogTUxDbGllbnRDdHgsCiAgICAgICAgICAgICAgICAgZGFza19jbGllbnQ6IHN0ciwKICAgICAgICAgICAgICAgICBjb25uZWN0aW9uX2luZm86IHN0ciwKICAgICAgICAgICAgICAgICBxdWVyeTogc3RyLAogICAgICAgICAgICAgICAgIHBhcnF1ZXRfb3V0X2RpciA9IE5vbmUsCiAgICAgICAgICAgICAgICAgcHVibGlzaF9uYW1lID0gTm9uZQogICAgICAgICAgICAgICAgKSAtPiBOb25lOgoKICAgICIiIlNub3dmbGFrZSBEYXNrIC0gSW5nZXN0IFNub3dmbGFrZSBkYXRhIHdpdGggRGFzawoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBkYXNrX2NsaWVudDogICAgICAgZGFzayBjbHVzdGVyIGZ1bmN0aW9uIG5hbWUKICAgIDpwYXJhbSBjb25uZWN0aW9uX2luZm86ICAgU25vd2ZsYWtlIGRhdGFiYXNlIGNvbm5lY3Rpb24gaW5mbyAodGhpcyB3aWxsIGJlIGluIGEgc2VjcmV0IGxhdGVyKQogICAgOnBhcmFtIHF1ZXJ5OiAgICAgICAgICAgICBxdWVyeSB0byBmb3IgU25vd2ZsYWtlCiAgICA6cGFyYW0gcGFycXVldF9vdXRfZGlyOiAgIGRpcmVjdG9yeSBwYXRoIGZvciB0aGUgb3V0cHV0IHBhcnF1ZXQgZmlsZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGRlZmF1bHQgTm9uZSwgbm90IHdyaXRlIG91dCkKICAgIDpwYXJhbSBwdWJsaXNoX25hbWU6ICAgICAgbmFtZSBvZiB0aGUgZGFzayBkYXRhZnJhbWUgdG8gcHVibGlzaCB0byB0aGUgZGFzayBjbHVzdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChkZWZhdWx0IE5vbmUsIG5vdCBwdWJsaXNoKQoKICAgICIiIgogICAgY29udGV4dCA9IG1scnVuLmdldF9vcl9jcmVhdGVfY3R4KCdzbmF3Zmxha2UtZGFzay1jbHVzdGVyJykKICAgIHNmX3Bhc3N3b3JkID0gY29udGV4dC5nZXRfc2VjcmV0KCdzZlBhc3N3b3JkJykKICAgIHBrX3BhdGggPSAgY29udGV4dC5nZXRfc2VjcmV0KCdwa1BhdGgnKQogICAgcGtfcGFzc3dvcmQgPSAgY29udGV4dC5nZXRfc2VjcmV0KCdwa1Bhc3N3b3JkJykKCiAgICBpZiBwa19wYXRoIGFuZCBwa19wYXNzd29yZDoKICAgICAgICB3aXRoIG9wZW4ocGtfcGF0aCwgInJiIikgYXMga2V5OgogICAgICAgICAgICBwX2tleT0gc2VyaWFsaXphdGlvbi5sb2FkX3BlbV9wcml2YXRlX2tleSgKICAgICAgICAgICAgICAgIGtleS5yZWFkKCksCiAgICAgICAgICAgICAgICBwYXNzd29yZD1zdHIocGtfcGFzc3dvcmQpLmVuY29kZSgpLAogICAgICAgICAgICAgICAgYmFja2VuZD1kZWZhdWx0X2JhY2tlbmQoKQogICAgICAgICAgICApCiAgICAgICAgcGtiID0gcF9rZXkucHJpdmF0ZV9ieXRlcygKICAgICAgICAgICAgZW5jb2Rpbmc9c2VyaWFsaXphdGlvbi5FbmNvZGluZy5ERVIsCiAgICAgICAgICAgIGZvcm1hdD1zZXJpYWxpemF0aW9uLlByaXZhdGVGb3JtYXQuUEtDUzgKICAgICAgICAgICAgLGVuY3J5cHRpb25fYWxnb3JpdGhtPXNlcmlhbGl6YXRpb24uTm9FbmNyeXB0aW9uKCkKICAgICAgICApCiAgICAgICAgY29ubmVjdGlvbl9pbmZvLnBvcCgncGFzc3dvcmQnLCAnTm8gcGFzc3dvcmQgZm91bmQnKQogICAgICAgIGNvbm5lY3Rpb25faW5mb1sncHJpdmF0ZV9rZXknXSA9IHBrYgogICAgZWxpZiBzZl9wYXNzd29yZDoKICAgICAgICBjb25uZWN0aW9uX2luZm9bJ3Bhc3N3b3JkJ10gPSBzZl9wYXNzd29yZAogICAgZWxzZToKICAgICAgICByYWlzZSBFeGNlcHRpb24oIlxuUGxlYXNlIHNldCB1cCB0aGUgc2VjcmV0IGZvciBTbm93Zmxha2UgaW4geW91ciBwcm9qZWN0IVxuIikKCiAgICAjIHNldHVwIGRhc2sgY2xpZW50IGZyb20gdGhlIE1MUnVuIGRhc2sgY2x1c3RlciBmdW5jdGlvbgogICAgaWYgZGFza19jbGllbnQ6CiAgICAgICAgY2xpZW50ID0gbWxydW4uaW1wb3J0X2Z1bmN0aW9uKGRhc2tfY2xpZW50KS5jbGllbnQKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYnRXhpc3RpbmcgZGFzayBjbGllbnQgPT09ID4+PiB7Y2xpZW50fVxuJykKICAgIGVsc2U6CiAgICAgICAgY2xpZW50ID0gQ2xpZW50KCkKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYnXG5OZXdseSBjcmVhdGVkIGRhc2sgY2xpZW50ID09PSA+Pj4ge2NsaWVudH1cbicpCgogICAgY29ubiA9IHNub3cuY29ubmVjdCgqKmNvbm5lY3Rpb25faW5mbykKICAgIGN1ciA9IGNvbm4uY3Vyc29yKCkKICAgIGN1ci5leGVjdXRlKHF1ZXJ5KQogICAgYmF0Y2hlcyA9IGN1ci5nZXRfcmVzdWx0X2JhdGNoZXMoKQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ2JhdGNoZXMgbGVuID09PSB7bGVuKGJhdGNoZXMpfVxuJykKCiAgICBkZnMgPSBbXQogICAgZm9yIGJhdGNoIGluIGJhdGNoZXM6CiAgICAgICAgaWYgYmF0Y2gucm93Y291bnQgPiAwOgogICAgICAgICAgICBkZiA9IGxvYWQoYmF0Y2gpCiAgICAgICAgICAgIGRmcy5hcHBlbmQoZGYpCiAgICBkZGYgPSBmcm9tX2RlbGF5ZWQoZGZzKQoKICAgICMgbWF0ZXJpYWxpemUgdGhlIHF1ZXJ5IHJlc3VsdHMgc2V0IGZvciBzb21lIHNhbXBsZSBjb21wdXRlCgogICAgZGRmX2Rlc2NyaWJlID0gZGRmLmRlc2NyaWJlKCkuY29tcHV0ZSgpCgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ3F1ZXJ5ICA9PT0gPj4+IHtxdWVyeX1cbicpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYnZGRmICA9PT0gPj4+IHtkZGZ9XG4nKQogICAgY29udGV4dC5sb2dfcmVzdWx0KCdudW1iZXIgb2Ygcm93cycsIGxlbihkZGYuaW5kZXgpKQogICAgY29udGV4dC5sb2dfZGF0YXNldCgiZGRmX2Rlc2NyaWJlIiwgZGY9ZGRmX2Rlc2NyaWJlKQoKICAgIGlmIHB1Ymxpc2hfbmFtZToKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoJ2RhdGFfc2V0X25hbWUnLCBwdWJsaXNoX25hbWUpCiAgICAgICAgaWYgbm90IGNsaWVudC5saXN0X2RhdGFzZXRzKCk6CiAgICAgICAgICAgIGRkZi5wZXJzaXN0KG5hbWUgPSBwdWJsaXNoX25hbWUpCiAgICAgICAgICAgIGNsaWVudC5wdWJsaXNoX2RhdGFzZXQocHVibGlzaF9uYW1lPWRkZikKCiAgICBpZiBwYXJxdWV0X291dF9kaXI6CiAgICAgICAgZGQudG9fcGFycXVldChkZj1kZGYsIHBhdGg9cGFycXVldF9vdXRfZGlyKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdCgncGFycXVldCBkaXJlY3RvcnknLCBwYXJxdWV0X291dF9kaXIpCg==
    base_image: mlrun/mlrun
    commands:
    - python -m pip install bokeh snowflake-connector-python[pandas] mlrun~=0.9.1
    code_origin: https://github.com/xsqian/functions.git#0aed165954181421dd0437ecd39298124b4236f2:snowflake_dask.py
    origin_filename: snowflake_dask.py
  entry_points:
    load:
      name: load
      doc: A delayed load one batch.
      parameters:
      - name: batch
        default: ''
      outputs:
      - default: ''
      lineno: 15
    load_results:
      name: load_results
      doc: Snowflake Dask - Ingest Snowflake data with Dask
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
        default: ''
      - name: dask_client
        type: str
        doc: dask cluster function name
        default: ''
      - name: connection_info
        type: str
        doc: Snowflake database connection info (this will be in a secret later)
        default: ''
      - name: query
        type: str
        doc: query to for Snowflake
        default: ''
      - name: parquet_out_dir
        doc: directory path for the output parquet files (default None, not write
          out)
        default: null
      - name: publish_name
        doc: name of the dask dataframe to publish to the dask cluster (default None,
          not publish)
        default: null
      outputs:
      - default: ''
      lineno: 28
  description: Snowflake Dask - Ingest snowflake data in parallel with Dask cluster
  default_handler: load_results
  disable_auto_mount: false
  env:
  - name: V3IO_API
    value: ''
  - name: V3IO_USERNAME
    value: ''
  - name: V3IO_ACCESS_KEY
    value: ''
  - name: V3IO_FRAMESD
    value: ''
  priority_class_name: igz-workload-medium
  preemption_mode: prevent
  affinity: null
  tolerations: null
verbose: false
