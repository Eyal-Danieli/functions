kind: job
metadata:
  name: batch-inference
  tag: ''
  hash: 6388746bab1e608a9501eaeedac0d904d1566459
  project: ''
  labels:
    author: guyl
  categories:
  - Utils
  - Data Analysis
  - Monitoring
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAyMyBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKCgpmcm9tIHR5cGluZyBpbXBvcnQgQW55LCBEaWN0LCBMaXN0LCBVbmlvbgoKaW1wb3J0IG1scnVuCgp0cnk6CiAgICBpbXBvcnQgbWxydW4ubW9kZWxfbW9uaXRvcmluZy5hcGkKZXhjZXB0IE1vZHVsZU5vdEZvdW5kRXJyb3I6CiAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5Ob3RGb3VuZEVycm9yKAogICAgICAgIGYiUGxlYXNlIHVwZGF0ZSB5b3VyIGBtbHJ1bmAgdmVyc2lvbiB0byA+PTEuNS4wIG9yIHVzZSBhbiAiCiAgICAgICAgZiJvbGRlciB2ZXJzaW9uIG9mIHRoZSBiYXRjaCBpbmZlcmVuY2UgZnVuY3Rpb24uIgogICAgKQoKCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgcGFuZGFzIGFzIHBkCmZyb20gbWxydW4uZnJhbWV3b3Jrcy5hdXRvX21scnVuIGltcG9ydCBBdXRvTUxSdW4KCiMgQSB1bmlvbiBvZiBhbGwgc3VwcG9ydGVkIGRhdGFzZXQgdHlwZXM6CkRhdGFzZXRUeXBlID0gVW5pb25bCiAgICBtbHJ1bi5EYXRhSXRlbSwgbGlzdCwgZGljdCwgcGQuRGF0YUZyYW1lLCBwZC5TZXJpZXMsIG5wLm5kYXJyYXksIEFueQpdCgoKZGVmIF9wcmVwYXJlX3Jlc3VsdF9zZXQoCiAgICB4OiBwZC5EYXRhRnJhbWUsIGxhYmVsX2NvbHVtbnM6IExpc3Rbc3RyXSwgeV9wcmVkOiBucC5uZGFycmF5CikgLT4gcGQuRGF0YUZyYW1lOgogICAgIiIiCiAgICBTZXQgZGVmYXVsdCBsYWJlbCBjb2x1bW4gbmFtZXMgYW5kIHZhbGlkYXRlIGdpdmVuIG5hbWVzIHRvIHByZXBhcmUgdGhlIHJlc3VsdCBzZXQgLSBhIGNvbmNhdGVuYXRpb24gb2YgdGhlIGlucHV0cwogICAgKHgpIGFuZCB0aGUgbW9kZWwgcHJlZGljdGlvbnMgKHlfcHJlZCkuCgogICAgOnBhcmFtIHg6ICAgICAgICAgICAgIFRoZSBpbnB1dHMuCiAgICA6cGFyYW0gbGFiZWxfY29sdW1uczogQSBsaXN0IG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIHRoZSB0YXJnZXQgY29sdW1uIG5hbWVzIHRvIGFkZCB0byB0aGUgcHJlZGljdGlvbnMuIERlZmF1bHQgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgYmUgdXNlZCBpbiBjYXNlIHRoZSBsaXN0IGlzIGVtcHR5IChwcmVkaWN0ZWRfbGFiZWxfe2l9KS4KICAgIDpwYXJhbSB5X3ByZWQ6ICAgICAgICBUaGUgbW9kZWwgcHJlZGljdGlvbnMgb24gdGhlIGlucHV0cy4KCiAgICA6cmV0dXJuczogVGhlIHJlc3VsdCBzZXQuCgogICAgcmFpc2VzIE1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3I6IElmIHRoZSBsYWJlbHMgY29sdW1ucyBhbW91bnQgZG8gbm90IG1hdGNoIHRoZSBvdXRwdXRzIG9yIGlmIG9uZSBvZiB0aGUgbGFiZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uIGFscmVhZHkgZXhpc3RzIGluIHRoZSBkYXRhc2V0LgogICAgIiIiCiAgICAjIFByZXBhcmUgZGVmYXVsdCB0YXJnZXQgY29sdW1ucyBuYW1lcyBpZiBub3QgcHJvdmlkZWQ6CiAgICBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ID0gMSBpZiBsZW4oeV9wcmVkLnNoYXBlKSA9PSAxIGVsc2UgeV9wcmVkLnNoYXBlWzFdCiAgICBpZiBsZW4obGFiZWxfY29sdW1ucykgPT0gMDoKICAgICAgICAjIEFkZCBkZWZhdWx0IGxhYmVsIGNvbHVtbiBuYW1lczoKICAgICAgICBpZiBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ID09IDE6CiAgICAgICAgICAgIGxhYmVsX2NvbHVtbnMgPSBbInByZWRpY3RlZF9sYWJlbCJdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbGFiZWxfY29sdW1ucyA9IFsKICAgICAgICAgICAgICAgIGYicHJlZGljdGVkX2xhYmVsX3tpfSIgZm9yIGkgaW4gcmFuZ2UocHJlZGljdGlvbl9jb2x1bW5zX2Ftb3VudCkKICAgICAgICAgICAgXQoKICAgICMgVmFsaWRhdGUgdGhlIGxhYmVsIGNvbHVtbnM6CiAgICBpZiBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ICE9IGxlbihsYWJlbF9jb2x1bW5zKToKICAgICAgICAjIE5vIGVxdWFsaXR5IGJldHdlZW4gcHJvdmlkZWQgbGFiZWwgY29sdW1uIG5hbWVzIGFuZCBvdXRwdXRzIGFtb3VudDoKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJUaGUgbnVtYmVyIG9mIHByZWRpY3RlZCBsYWJlbHM6IHtwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50fSAiCiAgICAgICAgICAgIGYiaXMgbm90IGVxdWFsIHRvIHRoZSBnaXZlbiBsYWJlbCBjb2x1bW5zOiB7bGVuKGxhYmVsX2NvbHVtbnMpfSIKICAgICAgICApCiAgICBjb21tb25fbGFiZWxzID0gc2V0KGxhYmVsX2NvbHVtbnMpICYgc2V0KHguY29sdW1ucy50b2xpc3QoKSkKICAgIGlmIGNvbW1vbl9sYWJlbHM6CiAgICAgICAgIyBMYWJlbCBjb2x1bW4gZXhpc3QgaW4gdGhlIG9yaWdpbmFsIGlucHV0czoKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJUaGUgbGFiZWxzOiB7Y29tbW9uX2xhYmVsc30gYXJlIGFscmVhZHkgZXhpc3RlZCBpbiB0aGUgZ2l2ZW4gZGF0YXNldC4iCiAgICAgICAgKQoKICAgIHJldHVybiBwZC5jb25jYXQoCiAgICAgICAgW3gsIHBkLkRhdGFGcmFtZSh5X3ByZWQsIGNvbHVtbnM9bGFiZWxfY29sdW1ucywgaW5kZXg9eC5pbmRleCldLCBheGlzPTEKICAgICkKCgpkZWYgaW5mZXIoCiAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCwKICAgIG1vZGVsX3BhdGg6IHN0ciwKICAgIGRhdGFzZXQ6IERhdGFzZXRUeXBlLAogICAgbW9kZWxfbmFtZTogc3RyID0gImJhdGNoLWluZmVyZW5jZS1tb2RlbCIsCiAgICBkcm9wX2NvbHVtbnM6IFVuaW9uW3N0ciwgTGlzdFtzdHJdLCBpbnQsIExpc3RbaW50XV0gPSBOb25lLAogICAgbGFiZWxfY29sdW1uczogVW5pb25bc3RyLCBMaXN0W3N0cl1dID0gTm9uZSwKICAgIGxvZ19yZXN1bHRfc2V0OiBib29sID0gVHJ1ZSwKICAgIHJlc3VsdF9zZXRfbmFtZTogc3RyID0gInByZWRpY3Rpb24iLAogICAgYmF0Y2hfaWQ6IHN0ciA9IE5vbmUsCiAgICBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzOiBib29sID0gTm9uZSwKICAgIHNhbXBsZV9zZXQ6IERhdGFzZXRUeXBlID0gTm9uZSwKICAgIGRyaWZ0X3RocmVzaG9sZDogZmxvYXQgPSAwLjcsCiAgICBwb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQ6IGZsb2F0ID0gMC41LAogICAgaW5mX2NhcHBpbmc6IGZsb2F0ID0gMTAuMCwKICAgIGFydGlmYWN0c190YWc6IHN0ciA9ICIiLAogICAgZW5kcG9pbnRfaWQ6IHN0ciA9ICIiLAogICAgdHJpZ2dlcl9tb25pdG9yaW5nX2pvYjogYm9vbCA9IEZhbHNlLAogICAgYmF0Y2hfaW1hZ2Vfam9iOiBzdHIgPSAibWxydW4vbWxydW4iLAogICAgKipwcmVkaWN0X2t3YXJnczogRGljdFtzdHIsIEFueV0sCik6CiAgICAiIiIKICAgIFBlcmZvcm0gYSBwcmVkaWN0aW9uIG9uIGEgZ2l2ZW4gZGF0YXNldCB3aXRoIHRoZSBnaXZlbiBtb2RlbC4gQ2FuIHBlcmZvcm0gZHJpZnQgYW5hbHlzaXMgYmV0d2VlbiB0aGUgc2FtcGxlIHNldAogICAgc3RhdGlzdGljcyBzdG9yZWQgaW4gdGhlIG1vZGVsIHRvIHRoZSBjdXJyZW50IGlucHV0IGRhdGEuIFRoZSBkcmlmdCBydWxlIGlzIHRoZSB2YWx1ZSBwZXItZmVhdHVyZSBtZWFuIG9mIHRoZSBUVkQKICAgIGFuZCBIZWxsaW5nZXIgc2NvcmVzIGFjY29yZGluZyB0byB0aGUgdGhyZXNob2xkcyBjb25maWd1cmVzIGhlcmUuIFdoZW4gcGVyZm9ybWluZyBkcmlmdCBhbmFseXNpcywgdGhpcyBmdW5jdGlvbgogICAgZWl0aGVyIGNyZWF0ZXMgb3IgdXBkYXRlIGFuIGV4aXN0aW5nIG1vZGVsIGVuZHBvaW50IHJlY29yZCAoZGVwZW5kcyBvbiB0aGUgcHJvdmlkZWQgYGVuZHBvaW50X2lkYCkuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICAgICAgICAgTUxSdW4gY29udGV4dC4KICAgIDpwYXJhbSBtb2RlbF9wYXRoOiAgICAgICAgICAgICAgIFRoZSBtb2RlbCBTdG9yZSBwYXRoLgogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgICAgICAgICAgICAgVGhlIGRhdGFzZXQgdG8gaW5mZXIgdGhyb3VnaCB0aGUgbW9kZWwuIENhbiBiZSBwYXNzZWQgaW4gYGlucHV0c2AgYXMgZWl0aGVyIGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERhdGFzZXQgYXJ0aWZhY3QgLyBGZWF0dXJlIHZlY3RvciBVUkkuIE9yLCBpbiBgcGFyYW1ldGVyc2AgYXMgYSBsaXN0LCBkaWN0aW9uYXJ5IG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1weSBhcnJheS4KICAgIDpwYXJhbSBtb2RlbF9uYW1lOiAgICAgICAgICAgICAgIElmIGEgbmV3IG1vZGVsIGVuZHBvaW50IGlzIGdlbmVyYXRlZCwgdGhlIG1vZGVsIG5hbWUgd2lsbCBiZSBwcmVzZW50ZWQgdW5kZXIgdGhpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kcG9pbnQuCiAgICA6cGFyYW0gZHJvcF9jb2x1bW5zOiAgICAgICAgICAgICBBIHN0cmluZyAvIGludGVnZXIgb3IgYSBsaXN0IG9mIHN0cmluZ3MgLyBpbnRlZ2VycyB0aGF0IHJlcHJlc2VudCB0aGUgY29sdW1uIG5hbWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvIGluZGljZXMgdG8gZHJvcC4gV2hlbiB0aGUgZGF0YXNldCBpcyBhIGxpc3Qgb3IgYSBudW1weSBhcnJheSB0aGlzIHBhcmFtZXRlciBtdXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZSByZXByZXNlbnRlZCBieSBpbnRlZ2Vycy4KICAgIDpwYXJhbSBsYWJlbF9jb2x1bW5zOiAgICAgICAgICAgIFRoZSB0YXJnZXQgbGFiZWwocykgb2YgdGhlIGNvbHVtbihzKSBpbiB0aGUgZGF0YXNldCBmb3IgUmVncmVzc2lvbiBvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2xhc3NpZmljYXRpb24gdGFza3MuIFRoZSBsYWJlbCBjb2x1bW4gY2FuIGJlIGFjY2Vzc2VkIGZyb20gdGhlIG1vZGVsIG9iamVjdCwgb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBmZWF0dXJlIHZlY3RvciBwcm92aWRlZCBpZiBhdmFpbGFibGUuCiAgICA6cGFyYW0gbG9nX3Jlc3VsdF9zZXQ6ICAgICAgICAgICBXaGV0aGVyIHRvIGxvZyB0aGUgcmVzdWx0IHNldCAtIGEgRGF0YUZyYW1lIG9mIHRoZSBnaXZlbiBpbnB1dHMgY29uY2F0ZW5hdGVkIHdpdGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBwcmVkaWN0aW9ucy4gRGVmYXVsdGVkIHRvIFRydWUuCiAgICA6cGFyYW0gcmVzdWx0X3NldF9uYW1lOiAgICAgICAgICBUaGUgZGIga2V5IHRvIHNldCBuYW1lIG9mIHRoZSBwcmVkaWN0aW9uIHJlc3VsdCBhbmQgdGhlIGZpbGVuYW1lLiBEZWZhdWx0ZWQgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwcmVkaWN0aW9uJy4KICAgIDpwYXJhbSBiYXRjaF9pZDogICAgICAgICAgICAgICAgIFRoZSBJRCBvZiB0aGUgZ2l2ZW4gYmF0Y2ggKGluZmVyZW5jZSBkYXRhc2V0KS4gSWYgYE5vbmVgLCBpdCB3aWxsIGJlIGdlbmVyYXRlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFdpbGwgYmUgbG9nZ2VkIGFzIGEgcmVzdWx0IG9mIHRoZSBydW4uCiAgICA6cGFyYW0gcGVyZm9ybV9kcmlmdF9hbmFseXNpczogICBXaGV0aGVyIHRvIHBlcmZvcm0gZHJpZnQgYW5hbHlzaXMgYmV0d2VlbiB0aGUgc2FtcGxlIHNldCBvZiB0aGUgbW9kZWwgb2JqZWN0IHRvIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXNldCBnaXZlbi4gQnkgZGVmYXVsdCwgTm9uZSwgd2hpY2ggbWVhbnMgaXQgd2lsbCBwZXJmb3JtIGRyaWZ0IGFuYWx5c2lzIGlmIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwgaGFzIGEgc2FtcGxlIHNldCBzdGF0aXN0aWNzLiBQZXJmb3JtaW5nIGRyaWZ0IGFuYWx5c2lzIGlzIGVxdWFsIHRvIGVuYWJsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9uaXRvcmluZyBvbiB0aGUgcHJvdmlkZWQgbW9kZWwgZW5kcG9pbnQuIFBsZWFzZSBub3RlIHRoYXQgaW4gb3JkZXIgdG8gdHJpZ2dlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIGRyaWZ0IGFuYWx5c2lzIGpvYiwgeW91IG5lZWQgdG8gc2V0IGB0cmlnZ2VyX21vbml0b3Jpbmdfam9iPVRydWVgLiBPdGhlcndpc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgZHJpZnQgYW5hbHlzaXMgd2lsbCBiZSB0cmlnZ2VyZWQgb25seSBhcyBwYXJ0IHRoZSBzY2hlZHVsZWQgbW9uaXRvcmluZyBqb2IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChpZiBleGlzdCBpbiB0aGUgY3VycmVudCBwcm9qZWN0KSBvciBpZiB0cmlnZ2VyZWQgbWFudWFsbHkgYnkgdGhlIHVzZXIuCiAgICA6cGFyYW0gc2FtcGxlX3NldDogICAgICAgICAgICAgICBBIHNhbXBsZSBkYXRhc2V0IHRvIGdpdmUgdG8gY29tcGFyZSB0aGUgaW5wdXRzIGluIHRoZSBkcmlmdCBhbmFseXNpcy4gVGhlIGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob3NlbiBzYW1wbGUgc2V0IHdpbGwgYWx3YXlzIGJlIHRoZSBvbmUgd2hvIGlzIHNldCBpbiB0aGUgbW9kZWwgYXJ0aWZhY3QgaXRzZWxmLgogICAgOnBhcmFtIGRyaWZ0X3RocmVzaG9sZDogICAgICAgICAgVGhlIHRocmVzaG9sZCBvZiB3aGljaCB0byBtYXJrIGRyaWZ0cy4gRGVmYXVsdGVkIHRvIDAuNy4KICAgIDpwYXJhbSBwb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQ6IFRoZSB0aHJlc2hvbGQgb2Ygd2hpY2ggdG8gbWFyayBwb3NzaWJsZSBkcmlmdHMuIERlZmF1bHRlZCB0byAwLjUuCiAgICA6cGFyYW0gaW5mX2NhcHBpbmc6ICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gc2V0IGZvciB3aGVuIGl0IHJlYWNoZWQgaW5maW5pdHkuIERlZmF1bHRlZCB0byAxMC4wLgogICAgOnBhcmFtIGFydGlmYWN0c190YWc6ICAgICAgICAgICAgVGFnIHRvIHVzZSBmb3IgYWxsIHRoZSBhcnRpZmFjdHMgcmVzdWx0ZWQgZnJvbSB0aGUgZnVuY3Rpb24uCiAgICA6cGFyYW0gZW5kcG9pbnRfaWQ6ICAgICAgICAgICAgICBNb2RlbCBlbmRwb2ludCB1bmlxdWUgSUQuIElmIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXMgd2FzIHNldCwgdGhlIGVuZHBvaW50X2lkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGJlIHVzZWQgZWl0aGVyIHRvIHVwZGF0ZSBhbiBleGlzdGluZyBtb2RlbCBlbmRwb2ludCBvciBnZW5lcmF0ZSBhIG5ldwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwgZW5kcG9pbnQgcmVjb3JkLgogICAgOnBhcmFtIHRyaWdnZXJfbW9uaXRvcmluZ19qb2I6ICAgV2hldGhlciB0byB0cmlnZ2VyIHRoZSBiYXRjaCBkcmlmdCBhbmFseXNpcyBhZnRlciB0aGUgaW5mZXIgam9iLgogICAgOnBhcmFtIGJhdGNoX2ltYWdlX2pvYjogICAgICAgICAgVGhlIGltYWdlIHRoYXQgd2lsbCBiZSB1c2VkIGZvciB0aGUgbW9uaXRvcmluZyBiYXRjaCBqb2IgYW5hbHlzaXMuIEJ5IGRlZmF1bHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgaW1hZ2UgaXMgbWxydW4vbWxydW4uCiAgICAiIiIKICAgICMgTG9hZGluZyB0aGUgbW9kZWw6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiTG9hZGluZyBtb2RlbC4uLiIpCiAgICBtb2RlbF9oYW5kbGVyID0gQXV0b01MUnVuLmxvYWRfbW9kZWwobW9kZWxfcGF0aD1tb2RlbF9wYXRoLCBjb250ZXh0PWNvbnRleHQpCiAgICBpZiBsYWJlbF9jb2x1bW5zIGlzIE5vbmU6CiAgICAgICAgbGFiZWxfY29sdW1ucyA9IFsKICAgICAgICAgICAgb3V0cHV0Lm5hbWUgZm9yIG91dHB1dCBpbiBtb2RlbF9oYW5kbGVyLl9tb2RlbF9hcnRpZmFjdC5zcGVjLm91dHB1dHMKICAgICAgICBdCgogICAgIyBHZXQgZGF0YXNldCBieSBvYmplY3QsIFVSTCBvciBieSBGZWF0dXJlVmVjdG9yOgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkxvYWRpbmcgZGF0YS4uLiIpCiAgICB4LCBsYWJlbF9jb2x1bW5zID0gbWxydW4ubW9kZWxfbW9uaXRvcmluZy5hcGkucmVhZF9kYXRhc2V0X2FzX2RhdGFmcmFtZSgKICAgICAgICBkYXRhc2V0PWRhdGFzZXQsCiAgICAgICAgbGFiZWxfY29sdW1ucz1sYWJlbF9jb2x1bW5zLAogICAgICAgIGRyb3BfY29sdW1ucz1kcm9wX2NvbHVtbnMsCiAgICApCgogICAgIyBQcmVkaWN0OgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkNhbGN1bGF0aW5nIHByZWRpY3Rpb24uLi4iKQogICAgeV9wcmVkID0gbW9kZWxfaGFuZGxlci5tb2RlbC5wcmVkaWN0KHgsICoqcHJlZGljdF9rd2FyZ3MpCgogICAgIyBQcmVwYXJlIHRoZSByZXN1bHQgc2V0OgogICAgcmVzdWx0X3NldCA9IF9wcmVwYXJlX3Jlc3VsdF9zZXQoeD14LCBsYWJlbF9jb2x1bW5zPWxhYmVsX2NvbHVtbnMsIHlfcHJlZD15X3ByZWQpCgogICAgIyBDaGVjayBmb3IgbG9nZ2luZyB0aGUgcmVzdWx0IHNldDoKICAgIGlmIGxvZ19yZXN1bHRfc2V0OgogICAgICAgIG1scnVuLm1vZGVsX21vbml0b3JpbmcuYXBpLmxvZ19yZXN1bHQoCiAgICAgICAgICAgIGNvbnRleHQ9Y29udGV4dCwKICAgICAgICAgICAgcmVzdWx0X3NldF9uYW1lPXJlc3VsdF9zZXRfbmFtZSwKICAgICAgICAgICAgcmVzdWx0X3NldD1yZXN1bHRfc2V0LAogICAgICAgICAgICBhcnRpZmFjdHNfdGFnPWFydGlmYWN0c190YWcsCiAgICAgICAgICAgIGJhdGNoX2lkPWJhdGNoX2lkLAogICAgICAgICkKCiAgICAjIENoZWNrIGZvciBwZXJmb3JtaW5nIGRyaWZ0IGFuYWx5c2lzCiAgICBpZiAoCiAgICAgICAgcGVyZm9ybV9kcmlmdF9hbmFseXNpcyBpcyBOb25lCiAgICAgICAgYW5kIG1vZGVsX2hhbmRsZXIuX21vZGVsX2FydGlmYWN0LnNwZWMuZmVhdHVyZV9zdGF0cyBpcyBub3QgTm9uZQogICAgKToKICAgICAgICBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzID0gVHJ1ZQogICAgaWYgcGVyZm9ybV9kcmlmdF9hbmFseXNpczoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJQZXJmb3JtaW5nIGRyaWZ0IGFuYWx5c2lzLi4uIikKICAgICAgICAjIEdldCB0aGUgc2FtcGxlIHNldCBzdGF0aXN0aWNzIChlaXRoZXIgZnJvbSB0aGUgc2FtcGxlIHNldCBvciBmcm9tIHRoZSBzdGF0aXN0aWNzIGxvZ2dlZCB3aXRoIHRoZSBtb2RlbCkKICAgICAgICBzYW1wbGVfc2V0X3N0YXRpc3RpY3MgPSBtbHJ1bi5tb2RlbF9tb25pdG9yaW5nLmFwaS5nZXRfc2FtcGxlX3NldF9zdGF0aXN0aWNzKAogICAgICAgICAgICBzYW1wbGVfc2V0PXNhbXBsZV9zZXQsCiAgICAgICAgICAgIG1vZGVsX2FydGlmYWN0X2ZlYXR1cmVfc3RhdHM9bW9kZWxfaGFuZGxlci5fbW9kZWxfYXJ0aWZhY3Quc3BlYy5mZWF0dXJlX3N0YXRzLAogICAgICAgICkKICAgICAgICBtbHJ1bi5tb2RlbF9tb25pdG9yaW5nLmFwaS5nZXRfb3JfY3JlYXRlX21vZGVsX2VuZHBvaW50KAogICAgICAgICAgICBwcm9qZWN0PWNvbnRleHQucHJvamVjdCwKICAgICAgICAgICAgY29udGV4dD1jb250ZXh0LAogICAgICAgICAgICBlbmRwb2ludF9pZD1lbmRwb2ludF9pZCwKICAgICAgICAgICAgbW9kZWxfcGF0aD1tb2RlbF9wYXRoLAogICAgICAgICAgICBtb2RlbF9uYW1lPW1vZGVsX25hbWUsCiAgICAgICAgICAgIGRmX3RvX3RhcmdldD1yZXN1bHRfc2V0LmNvcHkoKSwKICAgICAgICAgICAgc2FtcGxlX3NldF9zdGF0aXN0aWNzPXNhbXBsZV9zZXRfc3RhdGlzdGljcywKICAgICAgICAgICAgZHJpZnRfdGhyZXNob2xkPWRyaWZ0X3RocmVzaG9sZCwKICAgICAgICAgICAgcG9zc2libGVfZHJpZnRfdGhyZXNob2xkPXBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZCwKICAgICAgICAgICAgaW5mX2NhcHBpbmc9aW5mX2NhcHBpbmcsCiAgICAgICAgICAgIGFydGlmYWN0c190YWc9YXJ0aWZhY3RzX3RhZywKICAgICAgICAgICAgdHJpZ2dlcl9tb25pdG9yaW5nX2pvYj10cmlnZ2VyX21vbml0b3Jpbmdfam9iLAogICAgICAgICAgICBkZWZhdWx0X2JhdGNoX2ltYWdlPWJhdGNoX2ltYWdlX2pvYiwKICAgICAgICApCg==
    commands: []
    code_origin: https://github.com/mlrun/functions.git#137dc89feaa164f94f9075c0a7489762137bd8ca:/Users/Eyal_Danieli/PycharmProjects/functions/batch_inference/batch_inference.py
    origin_filename: /Users/Eyal_Danieli/PycharmProjects/functions/batch_inference/batch_inference.py
    with_mlrun: false
    auto_build: false
    requirements: []
  entry_points:
    infer:
      name: infer
      doc: 'Perform a prediction on a given dataset with the given model. Can perform
        drift analysis between the sample set

        statistics stored in the model to the current input data. The drift rule is
        the value per-feature mean of the TVD

        and Hellinger scores according to the thresholds configures here. When performing
        drift analysis, this function

        either creates or update an existing model endpoint record (depends on the
        provided `endpoint_id`).'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
        default: ''
      - name: model_path
        type: str
        doc: The model Store path.
        default: ''
      - name: dataset
        type: DatasetType
        doc: The dataset to infer through the model. Can be passed in `inputs` as
          either a Dataset artifact / Feature vector URI. Or, in `parameters` as a
          list, dictionary or numpy array.
        default: ''
      - name: model_name
        type: str
        doc: If a new model endpoint is generated, the model name will be presented
          under this endpoint.
        default: batch-inference-model
      - name: drop_columns
        type: Union[str, List[str], int, List[int]]
        doc: A string / integer or a list of strings / integers that represent the
          column names / indices to drop. When the dataset is a list or a numpy array
          this parameter must be represented by integers.
        default: null
      - name: label_columns
        type: Union[str, List[str]]
        doc: The target label(s) of the column(s) in the dataset for Regression or
          Classification tasks. The label column can be accessed from the model object,
          or the feature vector provided if available.
        default: null
      - name: log_result_set
        type: bool
        doc: Whether to log the result set - a DataFrame of the given inputs concatenated
          with the predictions. Defaulted to True.
        default: true
      - name: result_set_name
        type: str
        doc: The db key to set name of the prediction result and the filename. Defaulted
          to 'prediction'.
        default: prediction
      - name: batch_id
        type: str
        doc: The ID of the given batch (inference dataset). If `None`, it will be
          generated. Will be logged as a result of the run.
        default: null
      - name: perform_drift_analysis
        type: bool
        doc: Whether to perform drift analysis between the sample set of the model
          object to the dataset given. By default, None, which means it will perform
          drift analysis if the model has a sample set statistics. Performing drift
          analysis is equal to enable monitoring on the provided model endpoint. Please
          note that in order to trigger the drift analysis job, you need to set `trigger_monitoring_job=True`.
          Otherwise, the drift analysis will be triggered only as part the scheduled
          monitoring job (if exist in the current project) or if triggered manually
          by the user.
        default: null
      - name: sample_set
        type: DatasetType
        doc: A sample dataset to give to compare the inputs in the drift analysis.
          The default chosen sample set will always be the one who is set in the model
          artifact itself.
        default: null
      - name: drift_threshold
        type: float
        doc: The threshold of which to mark drifts. Defaulted to 0.7.
        default: 0.7
      - name: possible_drift_threshold
        type: float
        doc: The threshold of which to mark possible drifts. Defaulted to 0.5.
        default: 0.5
      - name: inf_capping
        type: float
        doc: The value to set for when it reached infinity. Defaulted to 10.0.
        default: 10.0
      - name: artifacts_tag
        type: str
        doc: Tag to use for all the artifacts resulted from the function.
        default: ''
      - name: endpoint_id
        type: str
        doc: Model endpoint unique ID. If perform_drift_analysis was set, the endpoint_id
          will be used either to update an existing model endpoint or generate a new
          model endpoint record.
        default: ''
      - name: trigger_monitoring_job
        type: bool
        doc: Whether to trigger the batch drift analysis after the infer job.
        default: false
      - name: batch_image_job
        type: str
        doc: The image that will be used for the monitoring batch job analysis. By
          default, the image is mlrun/mlrun.
        default: mlrun/mlrun
      outputs:
      - default: ''
      lineno: 87
  description: Batch inference (also knows as prediction) for the common ML frameworks
    (SciKit-Learn, XGBoost and LightGBM) while performing data drift analysis.
  default_handler: infer
  disable_auto_mount: false
  allow_empty_resources: true
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
