kind: job
metadata:
  name: question-answering
  tag: ''
  hash: 6e2ec4caae94fa11a49c835ce6ad92029068ce65
  project: ''
  labels:
    author: yonish
  categories:
  - machine-learning
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAyMyBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMAojCiMgVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQojIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsCiMgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiMgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAojIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgppbXBvcnQgbG9nZ2luZwppbXBvcnQgb3BlcmF0b3IKaW1wb3J0IHBhdGhsaWIKZnJvbSBmdW5jdG9vbHMgaW1wb3J0IHJlZHVjZSwgd3JhcHMKZnJvbSB0eXBpbmcgaW1wb3J0IEFueSwgRGljdCwgTGlzdCwgVHVwbGUsIFVuaW9uCgppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCB0cmFuc2Zvcm1lcnMKZnJvbSB0cWRtIGltcG9ydCB0cWRtCgojIEdldCB0aGUgZ2xvYmFsIGxvZ2dlcjoKX0xPR0dFUiA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKCkKCgpkZWYgX2NoZWNrX21scnVuX2FuZF9vcGVuX21waSgpIC0+IFR1cGxlWyJtbHJ1bi5NTENsaWVudEN0eCIsICJtcGk0cHkuTVBJLkludHJhY29tbSJdOgogICAgZ2xvYmFsIF9MT0dHRVIKCiAgICBpc19tcGkgPSBGYWxzZQogICAgdHJ5OgogICAgICAgIGltcG9ydCBtbHJ1bgoKICAgICAgICBjb250ZXh0ID0gbWxydW4uZ2V0X29yX2NyZWF0ZV9jdHgobmFtZT0ibWxydW4iKQogICAgICAgIF9MT0dHRVIgPSBjb250ZXh0LmxvZ2dlcgogICAgICAgIGlzX21waSA9IGNvbnRleHQubGFiZWxzLmdldCgia2luZCIsICJqb2IiKSA9PSAibXBpam9iIgoKICAgICAgICBpZiBpc19tcGk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZyb20gbXBpNHB5IGltcG9ydCBNUEkKCiAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dCwgTVBJLkNPTU1fV09STEQKICAgICAgICAgICAgZXhjZXB0IE1vZHVsZU5vdEZvdW5kRXJyb3IgYXMgbXBpNHB5X25vdF9mb3VuZDoKICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmVycm9yKAogICAgICAgICAgICAgICAgICAgICJUbyBkaXN0cmlidXRlIHRoZSBmdW5jdGlvbiB1c2luZyBNTFJ1bidzICdtcGlqb2InIHlvdSBuZWVkIHRvIGhhdmUgYG1waTRweWAgcGFja2FnZSBpbiB5b3VyICIKICAgICAgICAgICAgICAgICAgICAiaW50ZXJwcmV0ZXIuIFBsZWFzZSBydW4gYHBpcCBpbnN0YWxsIG1waTRweWAgYW5kIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvcGVuLW1waS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICByYWlzZSBtcGk0cHlfbm90X2ZvdW5kCiAgICBleGNlcHQgTW9kdWxlTm90Rm91bmRFcnJvciBhcyBtb2R1bGVfbm90X2ZvdW5kOgogICAgICAgIGlmIGlzX21waToKICAgICAgICAgICAgcmFpc2UgbW9kdWxlX25vdF9mb3VuZAogICAgcmV0dXJuIE5vbmUsIE5vbmUKCgpkZWYgb3Blbl9tcGlfaGFuZGxlcigKICAgIHdvcmtlcl9pbnB1dHM6IExpc3Rbc3RyXSwgcm9vdF93b3JrZXJfaW5wdXRzOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUKKToKICAgIGdsb2JhbCBfTE9HR0VSCgogICAgIyBDaGVjayBmb3IgTUxSdW4gYW5kIE9wZW5NUEkgYXZhaWxhYmlsaXR5OgogICAgY29udGV4dCwgY29tbSA9IF9jaGVja19tbHJ1bl9hbmRfb3Blbl9tcGkoKQoKICAgIGRlZiBkZWNvcmF0b3IoaGFuZGxlcik6CiAgICAgICAgaWYgY29tbSBpcyBOb25lIG9yIGNvbW0uR2V0X3NpemUoKSA9PSAxOgogICAgICAgICAgICByZXR1cm4gaGFuZGxlcgoKICAgICAgICBAd3JhcHMoaGFuZGxlcikKICAgICAgICBkZWYgd3JhcHBlcigqKmt3YXJncyk6CiAgICAgICAgICAgICMgR2V0IHRoZSBvcGVuIG1waSBlbnZpcm9ubWVudCBwcm9wZXJ0aWVzOgogICAgICAgICAgICBzaXplID0gY29tbS5HZXRfc2l6ZSgpCiAgICAgICAgICAgIHJhbmsgPSBjb21tLkdldF9yYW5rKCkKCiAgICAgICAgICAgICMgR2l2ZSB0aGUgY29ycmVjdCBjaHVuayBvZiB0aGUgd29ya2VycyBpbnB1dHM6CiAgICAgICAgICAgIGZvciB3b3JrZXJfaW5wdXQgaW4gd29ya2VyX2lucHV0czoKICAgICAgICAgICAgICAgIGlucHV0X2FyZ3VtZW50ID0ga3dhcmdzW3dvcmtlcl9pbnB1dF0KICAgICAgICAgICAgICAgIGlmIGlucHV0X2FyZ3VtZW50IGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoaW5wdXRfYXJndW1lbnQsIHN0cik6CiAgICAgICAgICAgICAgICAgICAgaW5wdXRfYXJndW1lbnQgPSBfZ2V0X3RleHRfZmlsZXMoCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFfcGF0aD1wYXRobGliLlBhdGgoaW5wdXRfYXJndW1lbnQpLmFic29sdXRlKCkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBpZiBsZW4oaW5wdXRfYXJndW1lbnQpIDwgc2l6ZToKICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICBmIkNhbm5vdCBzcGxpdCB0aGUgaW5wdXQgJ3t3b3JrZXJfaW5wdXR9JyBvZiBsZW5ndGgge2xlbihpbnB1dF9hcmd1bWVudCl9IHRvIHtzaXplfSB3b3JrZXJzLiAiCiAgICAgICAgICAgICAgICAgICAgICAgIGYiUGxlYXNlIHJlZHVjZSB0aGUgYW1vdW50IG9mIHdvcmtlcnMgZm9yIHRoaXMgaW5wdXQuIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGV2ZW5fY2h1bmtfc2l6ZSA9IGxlbihpbnB1dF9hcmd1bWVudCkgLy8gc2l6ZQogICAgICAgICAgICAgICAgY2h1bmtfc3RhcnQgPSByYW5rICogZXZlbl9jaHVua19zaXplCiAgICAgICAgICAgICAgICBjaHVua19lbmQgPSAoCiAgICAgICAgICAgICAgICAgICAgKHJhbmsgKyAxKSAqIGV2ZW5fY2h1bmtfc2l6ZQogICAgICAgICAgICAgICAgICAgIGlmIHJhbmsgKyAxIDwgc2l6ZQogICAgICAgICAgICAgICAgICAgIGVsc2UgbGVuKGlucHV0X2FyZ3VtZW50KQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygKICAgICAgICAgICAgICAgICAgICBmIlJhbmsgI3tyYW5rfTogUHJvY2Vzc2luZyBpbnB1dCBjaHVuayBvZiAne3dvcmtlcl9pbnB1dH0nICIKICAgICAgICAgICAgICAgICAgICBmImZyb20gaW5kZXgge2NodW5rX3N0YXJ0fSB0byB7Y2h1bmtfZW5kfS4iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGlucHV0X2FyZ3VtZW50LCBsaXN0KToKICAgICAgICAgICAgICAgICAgICBpbnB1dF9hcmd1bWVudCA9IGlucHV0X2FyZ3VtZW50W2NodW5rX3N0YXJ0OmNodW5rX2VuZF0KICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShpbnB1dF9hcmd1bWVudCwgcGQuRGF0YUZyYW1lKToKICAgICAgICAgICAgICAgICAgICBpbnB1dF9hcmd1bWVudCA9IGlucHV0X2FyZ3VtZW50Lmlsb2NbY2h1bmtfc3RhcnQ6Y2h1bmtfZW5kOiwgOl0KICAgICAgICAgICAgICAgIGt3YXJnc1t3b3JrZXJfaW5wdXRdID0gaW5wdXRfYXJndW1lbnQKCiAgICAgICAgICAgICMgU2V0IHRoZSByb290IHdvcmtlciBvbmx5IGFyZ3VtZW50czoKICAgICAgICAgICAgaWYgcmFuayA9PSAwIGFuZCByb290X3dvcmtlcl9pbnB1dHM6CiAgICAgICAgICAgICAgICBrd2FyZ3MudXBkYXRlKHJvb3Rfd29ya2VyX2lucHV0cykKCiAgICAgICAgICAgICMgUnVuIHRoZSB3b3JrZXI6CiAgICAgICAgICAgIG91dHB1dCA9IGhhbmRsZXIoKiprd2FyZ3MpCgogICAgICAgICAgICAjIFNlbmQgdGhlIG91dHB1dCB0byB0aGUgcm9vdCByYW5rIChyYW5rICMwKToKICAgICAgICAgICAgb3V0cHV0ID0gY29tbS5nYXRoZXIob3V0cHV0LCByb290PTApCiAgICAgICAgICAgIGlmIHJhbmsgPT0gMDoKICAgICAgICAgICAgICAgICMgSm9pbiB0aGUgb3V0cHV0czoKICAgICAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oIkNvbGxlY3RpbmcgZGF0YSBmcm9tIHdvcmtlcnMgdG8gcm9vdCB3b3JrZXIuIikKICAgICAgICAgICAgICAgIGRhdGFmcmFtZSA9IHBkLmNvbmNhdChvYmpzPVtkZiBmb3IgZGYsIF8gaW4gb3V0cHV0XSwgYXhpcz0wKQogICAgICAgICAgICAgICAgZXJyb3JzX2RpY3Rpb25hcnkgPSByZWR1Y2Uob3BlcmF0b3IuaW9yLCBbZXJyIGZvciBfLCBlcnIgaW4gb3V0cHV0XSwge30pCiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YWZyYW1lLCBlcnJvcnNfZGljdGlvbmFyeQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICByZXR1cm4gd3JhcHBlcgoKICAgIHJldHVybiBkZWNvcmF0b3IKCgpAb3Blbl9tcGlfaGFuZGxlcih3b3JrZXJfaW5wdXRzPVsiZGF0YV9wYXRoIl0sIHJvb3Rfd29ya2VyX2lucHV0cz17InZlcmJvc2UiOiBUcnVlfSkKZGVmIGFuc3dlcl9xdWVzdGlvbnMoCiAgICBkYXRhX3BhdGg6IFVuaW9uW3N0ciwgTGlzdFtzdHJdXSwKICAgIG1vZGVsX25hbWU6IHN0ciwKICAgIHF1ZXN0aW9uczogTGlzdFtzdHJdLAogICAgZGV2aWNlX21hcDogVW5pb25bc3RyLCBkaWN0XSA9IE5vbmUsCiAgICBtb2RlbF9rd2FyZ3M6IGRpY3QgPSBOb25lLAogICAgYXV0b19ncHRxX2V4bGxhbWFfbWF4X2lucHV0X2xlbmd0aDogaW50ID0gTm9uZSwKICAgIHRva2VuaXplcl9uYW1lOiBzdHIgPSBOb25lLAogICAgdG9rZW5pemVyX2t3YXJnczogZGljdCA9IE5vbmUsCiAgICB0ZXh0X3dyYXBwZXI6IHN0ciA9ICIiLAogICAgcXVlc3Rpb25zX3dyYXBwZXI6IHN0ciA9ICIiLAogICAgZ2VuZXJhdGlvbl9jb25maWc6IGRpY3QgPSBOb25lLAogICAgYmF0Y2hfc2l6ZTogaW50ID0gMSwKICAgIHF1ZXN0aW9uc19jb2x1bW5zOiBMaXN0W3N0cl0gPSBOb25lLAogICAgdmVyYm9zZTogYm9vbCA9IEZhbHNlLAopIC0+IFR1cGxlW3BkLkRhdGFGcmFtZSwgZGljdF06CiAgICAiIiIKICAgIEFuc3dlciBxdWVzdGlvbnMgd2l0aCBhIGNvbnRleHQgdG8gdGhlIGdpdmVuIHRleHQgZmlsZXMgY29udGVudHMgYnkgYSBwcmV0cmFpbmVkIExMTSBtb2RlbC4gRWFjaCB0ZXh0IGZpbGUgd2lsbCBoYXZlCiAgICB0aGUgZm9sbG93aW5nIHByb21wdCBidWlsdDoKCiAgICBzdGFydCBvZiBgdGV4dF93cmFwcGVyYAogICAgPHRleHQgZmlsZSBjb250ZW50PgogICAgZW5kIG9mIGB0ZXh0X3dyYXBwZXJgCgogICAgc3RhcnQgb2YgYHF1ZXN0aW9uc193cmFwcGVyYAogICAgMS4gPHF1ZXN0aW9uc1swXT4KICAgIDIuIDxxdWVzdGlvbnNbMV0+CiAgICAuLi4KICAgIG4uIDxxdWVzdGlvbnNbbi0xXT4KICAgIGVuZCBvZiBgcXVlc3Rpb25zX3dyYXBwZXJgCgogICAgOnBhcmFtIGRhdGFfcGF0aDogICAgICAgICAgICAgICAgICAgICAgICAgIEEgcGF0aCB0byBhIGRpcmVjdG9yeSBvZiB0ZXh0IGZpbGVzIG9yIGEgcGF0aCB0byBhIHRleHQgZmlsZSB0byBhc2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVzdGlvbnMgYWJvdXQuCiAgICA6cGFyYW0gbW9kZWxfbmFtZTogICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHByZS10cmFpbmVkIG1vZGVsIG5hbWUgZnJvbSB0aGUgaHVnZ2luZ2ZhY2UgaHViIHRvIHVzZSBmb3IgYXNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlc3Rpb25zLgogICAgOnBhcmFtIHF1ZXN0aW9uczogICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBxdWVzdGlvbnMgdG8gYXNrLgogICAgOnBhcmFtIGRldmljZV9tYXA6ICAgICAgICAgICAgICAgICAgICAgICAgIEEgbWFwIHRvIHVzZSBmb3IgbG9hZGluZyB0aGUgbW9kZWwgb24gbXVsdGlwbGUgZGV2aWNlcy4KICAgIDpwYXJhbSBtb2RlbF9rd2FyZ3M6ICAgICAgICAgICAgICAgICAgICAgICBLZXl3b3JkIGFyZ3VtZW50cyB0byBwYXNzIGZvciBsb2FkaW5nIHRoZSBtb2RlbCB1c2luZyBIdWdnaW5nRmFjZSdzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYHRyYW5zZm9ybWVycy5BdXRvTW9kZWxGb3JDYXVzYWxMTS5mcm9tX3ByZXRyYWluZWRgIGZ1bmN0aW9uLgogICAgOnBhcmFtIGF1dG9fZ3B0cV9leGxsYW1hX21heF9pbnB1dF9sZW5ndGg6IEZvciBBdXRvR1BUUSBtb2RlbHMgdG8gc2V0IGFuZCBleHRlbmQgdGhlIG1vZGVsJ3MgaW5wdXQgYnVmZmVyIHNpemUuCiAgICA6cGFyYW0gdG9rZW5pemVyX25hbWU6ICAgICAgICAgICAgICAgICAgICAgVGhlIHRva2VuaXplciBuYW1lIGZyb20gdGhlIGh1Z2dpbmdmYWNlIGh1YiB0byB1c2UuIElmIG5vdCBnaXZlbiwgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwgbmFtZSB3aWxsIGJlIHVzZWQuCiAgICA6cGFyYW0gdG9rZW5pemVyX2t3YXJnczogICAgICAgICAgICAgICAgICAgS2V5d29yZCBhcmd1bWVudHMgdG8gcGFzcyBmb3IgbG9hZGluZyB0aGUgdG9rZW5pemVyIHVzaW5nIEh1Z2dpbmdGYWNlJ3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgdHJhbnNmb3JtZXJzLkF1dG9Ub2tlbml6ZXIuZnJvbV9wcmV0cmFpbmVkYCBmdW5jdGlvbi4KICAgIDpwYXJhbSB0ZXh0X3dyYXBwZXI6ICAgICAgICAgICAgICAgICAgICAgICBBIHdyYXBwZXIgZm9yIHRoZSBmaWxlJ3MgdGV4dC4gV2lsbCBiZSBhZGRlZCBhdCB0aGUgc3RhcnQgb2YgdGhlIHByb21wdC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNdXN0IGhhdmUgYSBwbGFjZWhvbGRlciAoJ3t9JykgZm9yIHRoZSB0ZXh0IG9mIHRoZSBmaWxlLgogICAgOnBhcmFtIHF1ZXN0aW9uc193cmFwcGVyOiAgICAgICAgICAgICAgICAgIEEgd3JhcHBlciBmb3IgdGhlIHF1ZXN0aW9ucyByZWNlaXZlZC4gV2lsbCBiZSBhZGRlZCBhZnRlciB0aGUgdGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyYXBwZXIgaW4gdGhlIHByb21wdCB0ZW1wbGF0ZS4gTXVzdCBoYXZlIGEgcGxhY2Vob2xkZXIgKCd7fScpIGZvciB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBxdWVzdGlvbnMuCiAgICA6cGFyYW0gZ2VuZXJhdGlvbl9jb25maWc6ICAgICAgICAgICAgICAgICAgSHVnZ2luZ0ZhY2UncyBgR2VuZXJhdGlvbkNvbmZpZ2Aga2V5d29yZCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgZ2VuZXJhdGVgIG1ldGhvZC4KICAgIDpwYXJhbSBiYXRjaF9zaXplOiAgICAgICAgICAgICAgICAgICAgICAgICBCYXRjaCBzaXplIGZvciBpbmZlcmVuY2UuCiAgICA6cGFyYW0gcXVlc3Rpb25zX2NvbHVtbnM6ICAgICAgICAgICAgICAgICAgQ29sdW1ucyB0byB1c2UgZm9yIHRoZSBkYXRhZnJhbWUgcmV0dXJuZWQuCiAgICA6cGFyYW0gdmVyYm9zZTogICAgICAgICAgICAgICAgICAgICAgICAgICAgV2hldGhlciB0byBwcmVzZW50IGxvZ3Mgb2YgYSBwcm9ncmVzcyBiYXIgYW5kIGVycm9ycy4gRGVmYXVsdDogVHJ1ZS4KCgogICAgOnJldHVybnM6IEEgdHVwbGUgb2Y6CgogICAgICAgICAgICAgICogQSBkYXRhZnJhbWUgZGF0YXNldCBvZiB0aGUgcXVlc3Rpb25zIGFuc3dlcnMuCiAgICAgICAgICAgICAgKiBBIGRpY3Rpb25hcnkgb2YgZXJyb3JlZCBmaWxlcyB0aGF0IHdlcmUgbm90IGluZmVycmVkIG9yIHdlcmUgbm90IGFuc3dlcmVkIHByb3Blcmx5LgogICAgIiIiCiAgICBnbG9iYWwgX0xPR0dFUgoKICAgICMgR2V0IHRoZSBpbnB1dCB0ZXh0IGZpbGVzIHRvIHF1ZXN0aW9uOgogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oIkNvbGxlY3RpbmcgdGV4dCBmaWxlcy4iKQogICAgaWYgaXNpbnN0YW5jZShkYXRhX3BhdGgsIHN0cik6CiAgICAgICAgZGF0YV9wYXRoID0gcGF0aGxpYi5QYXRoKGRhdGFfcGF0aCkuYWJzb2x1dGUoKQogICAgICAgIHRleHRfZmlsZXMgPSBfZ2V0X3RleHRfZmlsZXMoZGF0YV9wYXRoPWRhdGFfcGF0aCkKICAgIGVsc2U6CiAgICAgICAgdGV4dF9maWxlcyA9IGRhdGFfcGF0aAogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oZiJDb2xsZWN0ZWQge2xlbih0ZXh0X2ZpbGVzKX0gdGV4dCBmaWxlcy4iKQoKICAgICMgR2V0IHRoZSBwcm9tcHQgdGVtcGxhdGU6CiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbygiQ3JlYXRpbmcgcHJvbXB0IHRlbXBsYXRlLiIpCiAgICBwcm9tcHRfdGVtcGxhdGUgPSBfZ2V0X3Byb21wdF90ZW1wbGF0ZSgKICAgICAgICB0ZXh0X3dyYXBwZXI9dGV4dF93cmFwcGVyLAogICAgICAgIHF1ZXN0aW9uc193cmFwcGVyPXF1ZXN0aW9uc193cmFwcGVyLAogICAgICAgIHF1ZXN0aW9ucz1xdWVzdGlvbnMsCiAgICApCiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbyhmIlByb21wdCB0ZW1wbGF0ZSBjcmVhdGVkOlxuXG57cHJvbXB0X3RlbXBsYXRlfVxuIikKCiAgICAjIEdldCB0aGUgcXVlc3Rpb25zIGNvbHVtbnM6CiAgICBxdWVzdGlvbnNfY29sdW1ucyA9IHF1ZXN0aW9uc19jb2x1bW5zIG9yIFsKICAgICAgICBmInF7aX0iIGZvciBpIGluIHJhbmdlKDEsIGxlbihxdWVzdGlvbnMpICsgMSkKICAgIF0KICAgIGlmIGxlbihxdWVzdGlvbnNfY29sdW1ucykgIT0gbGVuKHF1ZXN0aW9ucyk6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgZiJUaGUgcHJvdmlkZWQgcXVlc3Rpb25zIGNvbHVtbnMgbGVuZ3RoICh7bGVuKHF1ZXN0aW9uc19jb2x1bW5zKX0pICIKICAgICAgICAgICAgZiJkb2VzIG5vdCBtYXRjaCB0aGUgcXVlc3Rpb25zIGFtb3VudCAoe2xlbihxdWVzdGlvbnMpfSkiCiAgICAgICAgKQoKICAgICMgTG9hZCB0aGUgZ2VuZXJhdGlvbiBjb25maWc6CiAgICBpZiB2ZXJib3NlOgogICAgICAgIF9MT0dHRVIuaW5mbygiTG9hZGluZyBnZW5lcmF0aW9uIGNvbmZpZ3VyYXRpb24uIikKICAgIGdlbmVyYXRpb25fY29uZmlnID0gdHJhbnNmb3JtZXJzLkdlbmVyYXRpb25Db25maWcoKiooZ2VuZXJhdGlvbl9jb25maWcgb3Ige30pKQogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oZiJHZW5lcmF0aW9uIGNvbmZpZ3VyYXRpb24gbG9hZGVkOiB7Z2VuZXJhdGlvbl9jb25maWd9IikKCiAgICAjIExvYWQgdGhlIG1vZGVsIGFuZCB0b2tlbml6ZXIgaW50byBhIHBpcGVsaW5lIG9iamVjdDoKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKGYiTG9hZGluZyBtb2RlbCAne21vZGVsX25hbWV9Jy4iKQogICAgZ2VuZXJhdGlvbl9waXBlbGluZSA9IF9nZXRfZ2VuZXJhdGlvbl9waXBlbGluZSgKICAgICAgICBtb2RlbF9uYW1lPW1vZGVsX25hbWUsCiAgICAgICAgZGV2aWNlX21hcD1kZXZpY2VfbWFwLAogICAgICAgIHRva2VuaXplcl9uYW1lPXRva2VuaXplcl9uYW1lIG9yIG1vZGVsX25hbWUsCiAgICAgICAgbW9kZWxfa3dhcmdzPW1vZGVsX2t3YXJncyBvciB7fSwKICAgICAgICB0b2tlbml6ZXJfa3dhcmdzPXRva2VuaXplcl9rd2FyZ3Mgb3Ige30sCiAgICAgICAgYXV0b19ncHRxX2V4bGxhbWFfbWF4X2lucHV0X2xlbmd0aD1hdXRvX2dwdHFfZXhsbGFtYV9tYXhfaW5wdXRfbGVuZ3RoLAogICAgICAgIGJhdGNoX3NpemU9YmF0Y2hfc2l6ZSwKICAgICkKICAgIGlmIHZlcmJvc2U6CiAgICAgICAgX0xPR0dFUi5pbmZvKCJNb2RlbCBsb2FkZWQuIikKCiAgICAjIFByZXBhcmUgdGhlIHN1Y2Nlc3NlcyBkYXRhZnJhbWUgYW5kIGVycm9ycyBkaWN0aW9uYXJ5IHRvIGJlIHJldHVybmVkOgogICAgc3VjY2Vzc2VzID0gW10KICAgIGVycm9ycyA9IHt9CgogICAgIyBTcGxpdCB0aGUgZmlsZXMgaW50byBiYXRjaGVzOgogICAgZmlsZV9iYXRjaGVzID0gWwogICAgICAgIHRleHRfZmlsZXNbaSA6IGkgKyBiYXRjaF9zaXplXQogICAgICAgIGlmIGkgKyBiYXRjaF9zaXplIDwgbGVuKHRleHRfZmlsZXMpCiAgICAgICAgZWxzZSB0ZXh0X2ZpbGVzW2k6XQogICAgICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbih0ZXh0X2ZpbGVzKSwgYmF0Y2hfc2l6ZSkKICAgIF0KCiAgICAjIEdvIG92ZXIgdGhlIGJhdGNoZXMgb2YgdGV4dCBmaWxlcyBhbmQgcXVlc3Rpb24gdGhlbToKICAgIHF1ZXN0aW9uc19hbW91bnQgPSBsZW4ocXVlc3Rpb25zX2NvbHVtbnMpCiAgICBmb3IgZmlsZV9iYXRjaCBpbiB0cWRtKAogICAgICAgIGZpbGVfYmF0Y2hlcywKICAgICAgICBkZXNjPSJHZW5lcmF0aW5nIGFuc3dlcnMiLAogICAgICAgIHVuaXQ9ZiJmaWxlIChiYXRjaCBvZiB7YmF0Y2hfc2l6ZX0pIiwKICAgICAgICBkaXNhYmxlPW5vdCB2ZXJib3NlLAogICAgKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUmVhZCBiYXRjaCAocmVhZCB0aGUgdGV4dCBmcm9tIHRoZSB0ZXh0IGZpbGVzKToKICAgICAgICAgICAgYmF0Y2hlZF9pbnB1dCA9IF9yZWFkX2ZpbGVfYmF0Y2goCiAgICAgICAgICAgICAgICBmaWxlX2JhdGNoPWZpbGVfYmF0Y2gsIHByb21wdF90ZW1wbGF0ZT1wcm9tcHRfdGVtcGxhdGUKICAgICAgICAgICAgKQogICAgICAgICAgICAjIEluZmVyIGJhdGNoOgogICAgICAgICAgICBiYXRjaGVkX2Fuc3dlcnMgPSBfYW5zd2VyX3F1ZXN0aW9ucygKICAgICAgICAgICAgICAgIHF1ZXN0aW9uc19hbW91bnQ9cXVlc3Rpb25zX2Ftb3VudCwKICAgICAgICAgICAgICAgIGJhdGNoZWRfaW5wdXQ9YmF0Y2hlZF9pbnB1dCwKICAgICAgICAgICAgICAgIGdlbmVyYXRpb25fcGlwZWxpbmU9Z2VuZXJhdGlvbl9waXBlbGluZSwKICAgICAgICAgICAgICAgIGdlbmVyYXRpb25fY29uZmlnPWdlbmVyYXRpb25fY29uZmlnLAogICAgICAgICAgICApCiAgICAgICAgICAgICMgQ29sbGVjdCBpdCB0byB0aGUgc3VjY2Vzc2VzOgogICAgICAgICAgICBzdWNjZXNzZXMgKz0gWwogICAgICAgICAgICAgICAgW2ZpbGUubmFtZSwgKmFuc3dlcnNdCiAgICAgICAgICAgICAgICBmb3IgZmlsZSwgYW5zd2VycyBpbiB6aXAoZmlsZV9iYXRjaCwgYmF0Y2hlZF9hbnN3ZXJzKQogICAgICAgICAgICBdCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleGNlcHRpb246CiAgICAgICAgICAgICMgTm90ZSB0aGUgZXhjZXB0aW9uIGFzIGVycm9yIGluIHRoZSBkaWN0aW9uYXJ5OgogICAgICAgICAgICBiYXRjaF9maWxlX25hbWVzID0gIiwgIi5qb2luKFtmaWxlLm5hbWUgZm9yIGZpbGUgaW4gZmlsZV9iYXRjaF0pCiAgICAgICAgICAgIGlmIHZlcmJvc2U6CiAgICAgICAgICAgICAgICBfTE9HR0VSLndhcm5pbmcoCiAgICAgICAgICAgICAgICAgICAgZiJFcnJvciBpbiBiYXRjaCAne2JhdGNoX2ZpbGVfbmFtZXN9Jzoge3N0cihleGNlcHRpb24pfSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZXJyb3JzW2JhdGNoX2ZpbGVfbmFtZXNdID0gc3RyKGV4Y2VwdGlvbikKICAgICAgICAgICAgY29udGludWUKCiAgICAjIENvbnN0cnVjdCB0aGUgYW5zd2VycyBkYXRhZnJhbWU6CiAgICBjb2x1bW5zID0gWwogICAgICAgICJ0ZXh0X2ZpbGUiLAogICAgICAgICpxdWVzdGlvbnNfY29sdW1ucywKICAgIF0KICAgIHN1Y2Nlc3NlcyA9IHBkLkRhdGFGcmFtZSgKICAgICAgICBzdWNjZXNzZXMsCiAgICAgICAgY29sdW1ucz1jb2x1bW5zLAogICAgKQoKICAgICMgUHJpbnQgdGhlIGhlYWQgb2YgdGhlIHByb2R1Y2VkIGRhdGFmcmFtZSBhbmQgcmV0dXJuOgogICAgaWYgdmVyYm9zZToKICAgICAgICBfTE9HR0VSLmluZm8oCiAgICAgICAgICAgIGYiRG9uZSAoe3N1Y2Nlc3Nlcy5zaGFwZVswXX0ve2xlbih0ZXh0X2ZpbGVzKX0pXG4iCiAgICAgICAgICAgIGYiQW5zd2VycyBzdW1tYXJ5OlxuIgogICAgICAgICAgICBmIntzdWNjZXNzZXMuaGVhZCgpfSIKICAgICAgICApCiAgICByZXR1cm4gc3VjY2Vzc2VzLCBlcnJvcnMKCgpkZWYgX2dldF90ZXh0X2ZpbGVzKAogICAgZGF0YV9wYXRoOiBwYXRobGliLlBhdGgsCikgLT4gTGlzdFtwYXRobGliLlBhdGhdOgogICAgIyBDaGVjayBpZiB0aGUgcGF0aCBpcyBvZiBhIGRpcmVjdG9yeSBvciBhIGZpbGU6CiAgICBpZiBkYXRhX3BhdGguaXNfZGlyKCk6CiAgICAgICAgIyBHZXQgYWxsIGZpbGVzIGluc2lkZSB0aGUgZGlyZWN0b3J5OgogICAgICAgIHRleHRfZmlsZXMgPSBsaXN0KGRhdGFfcGF0aC5nbG9iKCIqLioiKSkKICAgIGVsaWYgZGF0YV9wYXRoLmlzX2ZpbGUoKToKICAgICAgICB0ZXh0X2ZpbGVzID0gW2RhdGFfcGF0aF0KICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigKICAgICAgICAgICAgZiJVbnJlY29nbml6ZWQgZGF0YSBwYXRoLiBUaGUgcGFyYW1ldGVyIGBkYXRhX3BhdGhgIG11c3QgYmUgZWl0aGVyIGEgZGlyZWN0b3J5IHBhdGggb3IgYSBmaWxlIHBhdGguICIKICAgICAgICAgICAgZiJHaXZlbjoge3N0cihkYXRhX3BhdGgpfSAiCiAgICAgICAgKQoKICAgIHJldHVybiB0ZXh0X2ZpbGVzCgoKZGVmIF9nZXRfcHJvbXB0X3RlbXBsYXRlKAogICAgdGV4dF93cmFwcGVyOiBzdHIsCiAgICBxdWVzdGlvbnNfd3JhcHBlcjogc3RyLAogICAgcXVlc3Rpb25zOiBMaXN0W3N0cl0sCikgLT4gc3RyOgogICAgIyBWYWxpZGF0ZSBhbmQgYnVpbGQgdGhlIHRleHQgd3JhcHBlcjoKICAgIHRleHRfd3JhcHBlciA9IHRleHRfd3JhcHBlciBvciAoCiAgICAgICAgIkdpdmVuIHRoZSBmb2xsb3dpbmcgdGV4dDpcbiIgIi0tLS0tXG4iICJ7fVxuIiAiLS0tLS0iCiAgICApCiAgICBpZiB0ZXh0X3dyYXBwZXIuY291bnQoInt9IikgIT0gMToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICAiVGhlIGB0ZXh0X3dyYXBwZXJgIG11c3QgaW5jbHVkZSBvbmUgcGxhY2Vob2xkZXIgJ3t9JyBmb3IgdGhlIHRleHQgb2YgdGhlIGZpbGUgdG8gYmUgYXNrZWQgYWJvdXQuIgogICAgICAgICkKCiAgICAjIFZhbGlkYXRlIGFuZCBidWlsZCB0aGUgcXVlc3Rpb24gd3JhcHBlcjoKICAgIHF1ZXN0aW9uc193cmFwcGVyID0gcXVlc3Rpb25zX3dyYXBwZXIgb3IgIkFuc3dlciB0aGUgcXVlc3Rpb25zOlxuIiAie30iCiAgICBpZiBxdWVzdGlvbnNfd3JhcHBlci5jb3VudCgie30iKSAhPSAxOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICJUaGUgYHF1ZXN0aW9uc193cmFwcGVyYCBtdXN0IGluY2x1ZGUgb25lIHBsYWNlaG9sZGVyICd7fScgZm9yIHRoZSBsaXN0IG9mIHF1ZXN0aW9ucy4iCiAgICAgICAgKQoKICAgICMgVmFsaWRhdGUgYW5kIHBhcnNlIHRoZSBxdWVzdGlvbnM6CiAgICBpZiBsZW4ocXVlc3Rpb25zKSA9PSAwOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIlBsZWFzZSBpbmNsdWRlIGF0IGxlYXN0IG9uZSBxdWVzdGlvbi4iKQogICAgcXVlc3Rpb25zID0gIlxuIi5qb2luKAogICAgICAgIFtmIntpfS4ge3F1ZXN0aW9ufSIgZm9yIGksIHF1ZXN0aW9uIGluIGVudW1lcmF0ZShxdWVzdGlvbnMsIDEpXQogICAgKQoKICAgICMgQ29uc3RydWN0IHRoZSB0ZW1wbGF0ZToKICAgIHJldHVybiBmInt0ZXh0X3dyYXBwZXJ9XG57cXVlc3Rpb25zX3dyYXBwZXIuZm9ybWF0KHF1ZXN0aW9ucyl9XG4iCgoKZGVmIF9nZXRfZ2VuZXJhdGlvbl9waXBlbGluZSgKICAgIG1vZGVsX25hbWU6IHN0ciwKICAgIGRldmljZV9tYXA6IFVuaW9uW3N0ciwgZGljdF0sCiAgICB0b2tlbml6ZXJfbmFtZTogc3RyLAogICAgbW9kZWxfa3dhcmdzOiBkaWN0LAogICAgdG9rZW5pemVyX2t3YXJnczogZGljdCwKICAgIGF1dG9fZ3B0cV9leGxsYW1hX21heF9pbnB1dF9sZW5ndGg6IGludCA9IE5vbmUsCiAgICBiYXRjaF9zaXplOiBpbnQgPSAxLAopOgogICAgIyBMb2FkIHRoZSBtb2RlbDoKICAgIG1vZGVsID0gdHJhbnNmb3JtZXJzLkF1dG9Nb2RlbEZvckNhdXNhbExNLmZyb21fcHJldHJhaW5lZCgKICAgICAgICBtb2RlbF9uYW1lLCBkZXZpY2VfbWFwPWRldmljZV9tYXAsICoqbW9kZWxfa3dhcmdzCiAgICApCgogICAgIyBTZXQgZXhsbGFtYSBtYXggaW5wdXQgbGVuZ3RoIGlmIHByb3ZpZGVkOgogICAgaWYgYXV0b19ncHRxX2V4bGxhbWFfbWF4X2lucHV0X2xlbmd0aDoKICAgICAgICBmcm9tIGF1dG9fZ3B0cSBpbXBvcnQgZXhsbGFtYV9zZXRfbWF4X2lucHV0X2xlbmd0aAoKICAgICAgICBtb2RlbCA9IGV4bGxhbWFfc2V0X21heF9pbnB1dF9sZW5ndGgoCiAgICAgICAgICAgIG1vZGVsPW1vZGVsLCBtYXhfaW5wdXRfbGVuZ3RoPWF1dG9fZ3B0cV9leGxsYW1hX21heF9pbnB1dF9sZW5ndGgKICAgICAgICApCgogICAgIyBMb2FkIHRoZSB0b2tlbml6ZXI6CiAgICB0b2tlbml6ZXIgPSB0cmFuc2Zvcm1lcnMuQXV0b1Rva2VuaXplci5mcm9tX3ByZXRyYWluZWQoCiAgICAgICAgdG9rZW5pemVyX25hbWUsICoqdG9rZW5pemVyX2t3YXJncwogICAgKQoKICAgICMgSW5pdGlhbGl6ZSBhIGdlbmVyYXRpb24gcGlwbGluZSBhbmQgcmV0dXJuOgogICAgcmV0dXJuIHRyYW5zZm9ybWVycy5waXBlbGluZSgKICAgICAgICB0YXNrPSJ0ZXh0LWdlbmVyYXRpb24iLAogICAgICAgIG1vZGVsPW1vZGVsLAogICAgICAgIHRva2VuaXplcj10b2tlbml6ZXIsCiAgICAgICAgYmF0Y2hfc2l6ZT1iYXRjaF9zaXplLAogICAgKQoKCmRlZiBfcmVhZF9maWxlX2JhdGNoKAogICAgZmlsZV9iYXRjaDogTGlzdFtwYXRobGliLlBhdGhdLAogICAgcHJvbXB0X3RlbXBsYXRlOiBzdHIsCikgLT4gTGlzdFtzdHJdOgogICAgYmF0Y2ggPSBbXQogICAgZm9yIGZpbGUgaW4gZmlsZV9iYXRjaDoKICAgICAgICB3aXRoIG9wZW4oZmlsZSwgInIiKSBhcyBmcDoKICAgICAgICAgICAgYmF0Y2guYXBwZW5kKHByb21wdF90ZW1wbGF0ZS5mb3JtYXQoZnAucmVhZCgpKSkKICAgIHJldHVybiBiYXRjaAoKCmRlZiBfZ2V0X2Fuc3dlcnMoZ2VuZXJhdGVkX3RleHQ6IHN0ciwgcXVlc3Rpb25zX2Ftb3VudDogaW50KSAtPiBMaXN0W3N0cl06CiAgICAjIENsZWFyIGFuc3dlciBzdGFydCAocGFydCBiZWZvcmUgbnVtYmVycyk6CiAgICBpZiAiMS4iIG5vdCBpbiBnZW5lcmF0ZWRfdGV4dDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKAogICAgICAgICAgICBmIkFuc3dlciAxLiBpcyBtaXNzaW5nIGZyb20gdGhlIGdlbmVyYXRlZCB0ZXh0OiAne2dlbmVyYXRlZF90ZXh0fSciCiAgICAgICAgKQogICAgdGV4dCA9IGdlbmVyYXRlZF90ZXh0LnNwbGl0KCIxLiIsIDEpWzFdCgogICAgIyBTdGFydCBleHRyYWN0aW5nIHRoZSBhbnN3ZXJzOgogICAgYW5zd2VycyA9IFtdCiAgICBmb3IgaSBpbiByYW5nZSgxLCBxdWVzdGlvbnNfYW1vdW50ICsgMSk6CiAgICAgICAgIyBJZiBpdCdzIHRoZSBsYXN0IGFuc3dlciB0byBsb29rIGZvciwgdGFrZSB0aGUgcmVzdCBvZiB0aGUgdGV4dDoKICAgICAgICBpZiBpID09IHF1ZXN0aW9uc19hbW91bnQ6CiAgICAgICAgICAgIGFuc3dlcl9pID0gdGV4dAogICAgICAgICMgVmVyaWZ5IHRoZXJlIGlzIGEgcXVlc3Rpb24gbnVtYmVyIGluIHRoZSB0ZXh0OgogICAgICAgIGVsaWYgZiJ7aSArIDF9LiIgbm90IGluIHRleHQ6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgICAgICBmIkFuc3dlciB7aSArIDF9LiBpcyBtaXNzaW5nIGZyb20gdGhlIGdlbmVyYXRlZCB0ZXh0OiAne2dlbmVyYXRlZF90ZXh0fSciCiAgICAgICAgICAgICkKICAgICAgICAjIFRha2UgaSdzIGFuc3dlcjoKICAgICAgICBlbHNlOgogICAgICAgICAgICBhbnN3ZXJfaSwgdGV4dCA9IHRleHQuc3BsaXQoZiJ7aSArIDF9LiIsIDEpCiAgICAgICAgIyBDb2xsZWN0IHRoZSBhbnN3ZXIgcmVtb3ZpbmcgcmVkdW5kYW50IHNwYWNlczoKICAgICAgICBhbnN3ZXJzLmFwcGVuZChhbnN3ZXJfaS5zdHJpcCgpKQoKICAgIHJldHVybiBhbnN3ZXJzCgoKZGVmIF9hbnN3ZXJfcXVlc3Rpb25zKAogICAgcXVlc3Rpb25zX2Ftb3VudDogaW50LAogICAgYmF0Y2hlZF9pbnB1dDogTGlzdFtzdHJdLAogICAgZ2VuZXJhdGlvbl9waXBlbGluZTogdHJhbnNmb3JtZXJzLlBpcGVsaW5lLAogICAgZ2VuZXJhdGlvbl9jb25maWc6IHRyYW5zZm9ybWVycy5HZW5lcmF0aW9uQ29uZmlnLAopIC0+IExpc3RbTGlzdFtzdHJdXToKICAgICMgSW5mZXIgdGhyb3VnaCB0aGUgbGxtOgogICAgYmF0Y2hlZF9vdXRwdXQgPSBnZW5lcmF0aW9uX3BpcGVsaW5lKAogICAgICAgIGJhdGNoZWRfaW5wdXQsCiAgICAgICAgZ2VuZXJhdGlvbl9jb25maWc9Z2VuZXJhdGlvbl9jb25maWcsCiAgICAgICAgZW9zX3Rva2VuX2lkPWdlbmVyYXRpb25fcGlwZWxpbmUudG9rZW5pemVyLmVvc190b2tlbl9pZCwKICAgICAgICByZXR1cm5fZnVsbF90ZXh0PUZhbHNlLAogICAgICAgIG51bV9yZXR1cm5fc2VxdWVuY2VzPTEsCiAgICApCgogICAgIyBQcm9jZXNzIHRoZSBvdXRwdXRzIHRvIGdldCB0aGUgYW5zd2VyczoKICAgIGJhdGNoZWRfYW5zd2VycyA9IFtdCiAgICBmb3Igb3V0cHV0IGluIGJhdGNoZWRfb3V0cHV0OgogICAgICAgICMgR2V0IHRoZSBnZW5lcmF0ZWQgYW5zd2VyczoKICAgICAgICBhbnN3ZXJzID0gX2dldF9hbnN3ZXJzKAogICAgICAgICAgICBnZW5lcmF0ZWRfdGV4dD1vdXRwdXRbMF1bImdlbmVyYXRlZF90ZXh0Il0sCiAgICAgICAgICAgIHF1ZXN0aW9uc19hbW91bnQ9cXVlc3Rpb25zX2Ftb3VudCwKICAgICAgICApCiAgICAgICAgIyBDb2xsZWN0IHRoZSBwcm9jZXNzZWQgYW5zd2VyczoKICAgICAgICBiYXRjaGVkX2Fuc3dlcnMuYXBwZW5kKGFuc3dlcnMpCgogICAgcmV0dXJuIGJhdGNoZWRfYW5zd2Vycwo=
    base_image: mlrun/mlrun
    commands: []
    code_origin: ''
    origin_filename: ''
    requirements:
    - transformers
    - torch
    - tqdm
  entry_points:
    open_mpi_handler:
      name: open_mpi_handler
      doc: ''
      parameters:
      - name: worker_inputs
        type: List[str]
      - name: root_worker_inputs
        type: Dict[str, Any]
        default: null
      outputs: []
      lineno: 56
      has_varargs: false
      has_kwargs: false
    decorator:
      name: decorator
      doc: ''
      parameters:
      - name: handler
      outputs: []
      lineno: 64
      has_varargs: false
      has_kwargs: false
    wrapper:
      name: wrapper
      doc: ''
      parameters: []
      outputs: []
      lineno: 69
      has_varargs: false
      has_kwargs: true
    answer_questions:
      name: answer_questions
      doc: 'Answer questions with a context to the given text files contents by a
        pretrained LLM model. Each text file will have

        the following prompt built:


        start of `text_wrapper`

        <text file content>

        end of `text_wrapper`


        start of `questions_wrapper`

        1. <questions[0]>

        2. <questions[1]>

        ...

        n. <questions[n-1]>

        end of `questions_wrapper`'
      parameters:
      - name: data_path
        type: Union[str, List[str]]
        doc: A path to a directory of text files or a path to a text file to ask questions
          about.
      - name: model_name
        type: str
        doc: The pre-trained model name from the huggingface hub to use for asking
          questions.
      - name: questions
        type: List[str]
        doc: The questions to ask.
      - name: device_map
        type: Union[str, dict]
        doc: A map to use for loading the model on multiple devices.
        default: null
      - name: model_kwargs
        type: dict
        doc: Keyword arguments to pass for loading the model using HuggingFace's `transformers.AutoModelForCausalLM.from_pretrained`
          function.
        default: null
      - name: auto_gptq_exllama_max_input_length
        type: int
        doc: For AutoGPTQ models to set and extend the model's input buffer size.
        default: null
      - name: tokenizer_name
        type: str
        doc: The tokenizer name from the huggingface hub to use. If not given, the
          model name will be used.
        default: null
      - name: tokenizer_kwargs
        type: dict
        doc: Keyword arguments to pass for loading the tokenizer using HuggingFace's
          `transformers.AutoTokenizer.from_pretrained` function.
        default: null
      - name: text_wrapper
        type: str
        doc: A wrapper for the file's text. Will be added at the start of the prompt.
          Must have a placeholder ('{}') for the text of the file.
        default: ''
      - name: questions_wrapper
        type: str
        doc: A wrapper for the questions received. Will be added after the text wrapper
          in the prompt template. Must have a placeholder ('{}') for the questions.
        default: ''
      - name: generation_config
        type: dict
        doc: HuggingFace's `GenerationConfig` keyword arguments to pass to the `generate`
          method.
        default: null
      - name: batch_size
        type: int
        doc: Batch size for inference.
        default: 1
      - name: questions_columns
        type: List[str]
        doc: Columns to use for the dataframe returned.
        default: null
      - name: verbose
        type: bool
        doc: 'Whether to present logs of a progress bar and errors. Default: True.'
        default: false
      outputs:
      - doc: 'A tuple of:'
        type: Tuple[pd.DataFrame, dict]
      lineno: 128
      has_varargs: false
      has_kwargs: false
  description: GenAI approach of question answering on a given data
  default_handler: answer_questions
  disable_auto_mount: false
  clone_target_dir: ''
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
