kind: job
metadata:
  name: batch-predict
  tag: ''
  hash: fc5ebbdd9afc791efb505949cb8b0ee191391821
  project: ''
  labels:
    author: guyl
  categories:
  - utils
spec:
  command: ''
  args: []
  image: ''
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKaW1wb3J0IGpzb24KZnJvbSB0eXBpbmcgaW1wb3J0IEFueSwgRGljdCwgTGlzdCwgVHVwbGUsIFVuaW9uCgppbXBvcnQgbWxydW4KaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSBtbHJ1biBpbXBvcnQgZmVhdHVyZV9zdG9yZSBhcyBmcwpmcm9tIG1scnVuLmFwaS5zY2hlbWFzIGltcG9ydCBPYmplY3RLaW5kCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBBcnRpZmFjdApmcm9tIG1scnVuLmRhdGFfdHlwZXMuaW5mZXIgaW1wb3J0IEluZmVyT3B0aW9ucywgZ2V0X2RmX3N0YXRzCmZyb20gbWxydW4uZnJhbWV3b3Jrcy5hdXRvX21scnVuIGltcG9ydCBBdXRvTUxSdW4KZnJvbSBtbHJ1bi5tb2RlbF9tb25pdG9yaW5nLmZlYXR1cmVzX2RyaWZ0X3RhYmxlIGltcG9ydCBGZWF0dXJlc0RyaWZ0VGFibGVQbG90CmZyb20gbWxydW4ubW9kZWxfbW9uaXRvcmluZy5tb2RlbF9tb25pdG9yaW5nX2JhdGNoIGltcG9ydCAoCiAgICBWaXJ0dWFsRHJpZnQsCiAgICBjYWxjdWxhdGVfaW5wdXRzX3N0YXRpc3RpY3MsCikKCkRhdGFzZXRUeXBlID0gVW5pb25bbWxydW4uRGF0YUl0ZW0sIGxpc3QsIGRpY3QsIHBkLkRhdGFGcmFtZSwgcGQuU2VyaWVzLCBucC5uZGFycmF5XQoKCmRlZiBfcmVhZF9kYXRhc2V0X2FzX2RhdGFmcmFtZSgKICAgIGRhdGFzZXQ6IERhdGFzZXRUeXBlLAogICAgbGFiZWxfY29sdW1uczogVW5pb25bc3RyLCBMaXN0W3N0cl1dID0gTm9uZSwKICAgIGRyb3BfY29sdW1uczogVW5pb25bc3RyLCBMaXN0W3N0cl0sIGludCwgTGlzdFtpbnRdXSA9IE5vbmUsCikgLT4gVHVwbGVbcGQuRGF0YUZyYW1lLCBMaXN0W3N0cl1dOgogICAgIiIiCiAgICBQYXJzZSB0aGUgZ2l2ZW4gZGF0YXNldCBpbnRvIGEgRGF0YUZyYW1lIGFuZCBkcm9wIHRoZSBjb2x1bW5zIGFjY29yZGluZ2x5LiBJbiBhZGRpdGlvbiwgdGhlIGxhYmVsIGNvbHVtbnMgd2lsbCBiZQogICAgcGFyc2VkIGFuZCB2YWxpZGF0ZWQgYXMgd2VsbC4KCiAgICA6cGFyYW0gZGF0YXNldDogICAgICAgVGhlIGRhdGFzZXQgdG8gdHJhaW4gdGhlIG1vZGVsIG9uLgogICAgICAgICAgICAgICAgICAgICAgICAgIENhbiBiZSBlaXRoZXIgYSBsaXN0IG9mIGxpc3RzLCBkaWN0LCBVUkkgb3IgYSBGZWF0dXJlVmVjdG9yLgogICAgOnBhcmFtIGxhYmVsX2NvbHVtbnM6IFRoZSB0YXJnZXQgbGFiZWwocykgb2YgdGhlIGNvbHVtbihzKSBpbiB0aGUgZGF0YXNldC4gZm9yIFJlZ3Jlc3Npb24gb3IKICAgICAgICAgICAgICAgICAgICAgICAgICBDbGFzc2lmaWNhdGlvbiB0YXNrcy4KICAgIDpwYXJhbSBkcm9wX2NvbHVtbnM6ICBgYHN0cmBgIC8gYGBpbnRgYCBvciBhIGxpc3Qgb2YgYGBzdHJgYCAvIGBgaW50YGAgdGhhdCByZXByZXNlbnQgdGhlIGNvbHVtbiBuYW1lcyAvIGluZGljZXMgdG8KICAgICAgICAgICAgICAgICAgICAgICAgICBkcm9wLgoKICAgIDpyZXR1cm5zOiBBIHR1cGxlIG9mOgogICAgICAgICAgICAgIFswXSA9IFRoZSBwYXJzZWQgZGF0YXNldCBhcyBhIERhdGFGcmFtZQogICAgICAgICAgICAgIFsxXSA9IExhYmVsIGNvbHVtbnMuCgogICAgcmFpc2VzIE1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3I6IElmIHRoZSBgZHJvcF9jb2x1bW5zYCBhcmUgbm90IG1hdGNoaW5nIHRoZSBkYXRhc2V0IG9yIHVuc3VwcG9ydGVkIGRhdGFzZXQgdHlwZS4KICAgICIiIgogICAgIyBUdXJuIHRoZSBgZHJvcCBsYWJlbHNgIGludG8gYSBsaXN0IGlmIGdpdmVuOgogICAgaWYgZHJvcF9jb2x1bW5zIGlzIG5vdCBOb25lOgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGRyb3BfY29sdW1ucywgbGlzdCk6CiAgICAgICAgICAgIGRyb3BfY29sdW1ucyA9IFtkcm9wX2NvbHVtbnNdCgogICAgIyBDaGVjayBpZiB0aGUgZGF0YXNldCBpcyBpbiBmYWN0IGEgRmVhdHVyZSBWZWN0b3I6CiAgICBpZiBkYXRhc2V0Lm1ldGEgYW5kIGRhdGFzZXQubWV0YS5raW5kID09IE9iamVjdEtpbmQuZmVhdHVyZV92ZWN0b3I6CiAgICAgICAgIyBUcnkgdG8gZ2V0IHRoZSBsYWJlbCBjb2x1bW5zIGlmIG5vdCBwcm92aWRlZDoKICAgICAgICBsYWJlbF9jb2x1bW5zID0gbGFiZWxfY29sdW1ucyBvciBkYXRhc2V0Lm1ldGEuc3RhdHVzLmxhYmVsX2NvbHVtbgogICAgICAgICMgR2V0IHRoZSBmZWF0dXJlcyBhbmQgcGFyc2UgdG8gRGF0YUZyYW1lOgogICAgICAgIGRhdGFzZXQgPSBmcy5nZXRfb2ZmbGluZV9mZWF0dXJlcygKICAgICAgICAgICAgZGF0YXNldC5tZXRhLnVyaSwgZHJvcF9jb2x1bW5zPWRyb3BfY29sdW1ucwogICAgICAgICkudG9fZGF0YWZyYW1lKCkKICAgIGVsc2U6CiAgICAgICAgIyBQYXJzZSB0byBEYXRhRnJhbWUgYWNjb3JkaW5nIHRvIHRoZSBkYXRhc2V0J3MgdHlwZToKICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGFzZXQsIChsaXN0LCBucC5uZGFycmF5KSk6CiAgICAgICAgICAgICMgUGFyc2UgdGhlIGxpc3QgLyBudW1weSBhcnJheSBpbnRvIGEgRGF0YUZyYW1lOgogICAgICAgICAgICBkYXRhc2V0ID0gcGQuRGF0YUZyYW1lKGRhdGFzZXQpCiAgICAgICAgICAgICMgVmFsaWRhdGUgdGhlIGBkcm9wX2NvbHVtbnNgIGlzIGdpdmVuIGFzIGludGVnZXJzOgogICAgICAgICAgICBpZiBkcm9wX2NvbHVtbnMgYW5kIG5vdCBhbGwoaXNpbnN0YW5jZShjb2wsIGludCkgZm9yIGNvbCBpbiBkcm9wX2NvbHVtbnMpOgogICAgICAgICAgICAgICAgcmFpc2UgbWxydW4uZXJyb3JzLk1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3IoCiAgICAgICAgICAgICAgICAgICAgImBkcm9wX2NvbHVtbnNgIG11c3QgYmUgYW4gaW50ZWdlciAvIGxpc3Qgb2YgaW50ZWdlcnMgaWYgcHJvdmlkZWQgYXMgYSBsaXN0LiIKICAgICAgICAgICAgICAgICkKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZGF0YXNldCwgbWxydW4uRGF0YUl0ZW0pOgogICAgICAgICAgICAjIFR1cm4gdGhlIERhdGFJVGVtIHRvIERhdGFGcmFtZToKICAgICAgICAgICAgZGF0YXNldCA9IGRhdGFzZXQuYXNfZGYoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgUGFyc2UgdGhlIG9iamVjdCAoc2hvdWxkIGJlIGEgcGQuRGF0YUZyYW1lIC8gcGQuU2VyaWVzLCBkaWN0aW9uYXJ5KSBpbnRvIGEgRGF0YUZyYW1lOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkYXRhc2V0ID0gcGQuRGF0YUZyYW1lKGRhdGFzZXQpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgICAgICAgICBmIkNvdWxkIG5vdCBwYXJzZSB0aGUgZ2l2ZW4gZGF0YXNldCBvZiB0eXBlIHt0eXBlKGRhdGFzZXQpfSBpbnRvIGEgcGFuZGFzIERhdGFGcmFtZS4gIgogICAgICAgICAgICAgICAgICAgIGYiUmVjZWl2ZWQgdGhlIGZvbGxvd2luZyBlcnJvcjoge2V9IgogICAgICAgICAgICAgICAgKQogICAgICAgICMgRHJvcCBjb2x1bW5zIGlmIG5lZWRlZDoKICAgICAgICBpZiBkcm9wX2NvbHVtbnM6CiAgICAgICAgICAgIGRhdGFzZXQuZHJvcChkcm9wX2NvbHVtbnMsIGF4aXM9MSwgaW5wbGFjZT1UcnVlKQoKICAgICMgVHVybiB0aGUgYGxhYmVsX2NvbHVtbnNgIGludG8gYSBsaXN0IGJ5IGRlZmF1bHQ6CiAgICBpZiBsYWJlbF9jb2x1bW5zIGlzIE5vbmU6CiAgICAgICAgbGFiZWxfY29sdW1ucyA9IFtdCiAgICBlbGlmIGlzaW5zdGFuY2UobGFiZWxfY29sdW1ucywgKHN0ciwgaW50KSk6CiAgICAgICAgbGFiZWxfY29sdW1ucyA9IFtsYWJlbF9jb2x1bW5zXQoKICAgIHJldHVybiBkYXRhc2V0LCBsYWJlbF9jb2x1bW5zCgoKZGVmIF9wcmVwYXJlX3Jlc3VsdF9zZXQoCiAgICB4OiBwZC5EYXRhRnJhbWUsIGxhYmVsX2NvbHVtbnM6IExpc3Rbc3RyXSwgeV9wcmVkOiBucC5uZGFycmF5CikgLT4gcGQuRGF0YUZyYW1lOgogICAgIiIiCiAgICBTZXQgZGVmYXVsdCBsYWJlbCBjb2x1bW4gbmFtZXMgYW5kIHZhbGlkYXRlIGdpdmVuIG5hbWVzIHRvIHByZXBhcmUgdGhlIHJlc3VsdCBzZXQgLSBhIGNvbmNhdGVuYXRpb24gb2YgdGhlIGlucHV0cwogICAgKHgpIGFuZCB0aGUgbW9kZWwgcHJlZGljdGlvbnMgKHlfcHJlZCkuCgogICAgOnBhcmFtIHg6ICAgICAgICAgICAgIFRoZSBpbnB1dHMuCiAgICA6cGFyYW0gbGFiZWxfY29sdW1uczogQSBsaXN0IG9mIHN0cmluZ3MgcmVwcmVzZW50aW5nIHRoZSB0YXJnZXQgY29sdW1uIG5hbWVzIHRvIGFkZCB0byB0aGUgcHJlZGljdGlvbnMuIERlZmF1bHQgbmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgYmUgdXNlZCBpbiBjYXNlIHRoZSBsaXN0IGlzIGVtcHR5IChwcmVkaWN0ZWRfbGFiZWxfe2l9KS4KICAgIDpwYXJhbSB5X3ByZWQ6ICAgICAgICBUaGUgbW9kZWwgcHJlZGljdGlvbnMgb24gdGhlIGlucHV0cy4KCiAgICA6cmV0dXJuczogVGhlIHJlc3VsdCBzZXQuCgogICAgcmFpc2VzIE1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3I6IElmIHRoZSBsYWJlbHMgY29sdW1ucyBhbW91bnQgZG8gbm90IG1hdGNoIHRoZSBvdXRwdXRzIG9yIGlmIG9uZSBvZiB0aGUgbGFiZWwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uIGFscmVhZHkgZXhpc3RzIGluIHRoZSBkYXRhc2V0LgogICAgIiIiCiAgICAjIFByZXBhcmUgZGVmYXVsdCB0YXJnZXQgY29sdW1ucyBuYW1lcyBpZiBub3QgcHJvdmlkZWQ6CiAgICBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ID0gMSBpZiBsZW4oeV9wcmVkLnNoYXBlKSA9PSAxIGVsc2UgeV9wcmVkLnNoYXBlWzFdCiAgICBpZiBsZW4obGFiZWxfY29sdW1ucykgPT0gMDoKICAgICAgICAjIEFkZCBkZWZhdWx0IGxhYmVsIGNvbHVtbiBuYW1lczoKICAgICAgICBpZiBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ID09IDE6CiAgICAgICAgICAgIGxhYmVsX2NvbHVtbnMgPSBbInByZWRpY3RlZF9sYWJlbCJdCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbGFiZWxfY29sdW1ucyA9IFsKICAgICAgICAgICAgICAgIGYicHJlZGljdGVkX2xhYmVsX3tpfSIgZm9yIGkgaW4gcmFuZ2UocHJlZGljdGlvbl9jb2x1bW5zX2Ftb3VudCkKICAgICAgICAgICAgXQoKICAgICMgVmFsaWRhdGUgdGhlIGxhYmVsIGNvbHVtbnM6CiAgICBpZiBwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50ICE9IGxlbihsYWJlbF9jb2x1bW5zKToKICAgICAgICAjIE5vIGVxdWFsaXR5IGJldHdlZW4gcHJvdmlkZWQgbGFiZWwgY29sdW1uIG5hbWVzIGFuZCBvdXRwdXRzIGFtb3VudDoKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJUaGUgbnVtYmVyIG9mIHByZWRpY3RlZCBsYWJlbHM6IHtwcmVkaWN0aW9uX2NvbHVtbnNfYW1vdW50fSAiCiAgICAgICAgICAgIGYiaXMgbm90IGVxdWFsIHRvIHRoZSBnaXZlbiBsYWJlbCBjb2x1bW5zOiB7bGVuKGxhYmVsX2NvbHVtbnMpfSIKICAgICAgICApCiAgICBjb21tb25fbGFiZWxzID0gc2V0KGxhYmVsX2NvbHVtbnMpICYgc2V0KHguY29sdW1ucy50b2xpc3QoKSkKICAgIGlmIGNvbW1vbl9sYWJlbHM6CiAgICAgICAgIyBMYWJlbCBjb2x1bW4gZXhpc3QgaW4gdGhlIG9yaWdpbmFsIGlucHV0czoKICAgICAgICByYWlzZSBtbHJ1bi5lcnJvcnMuTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcigKICAgICAgICAgICAgZiJUaGUgbGFiZWxzOiB7Y29tbW9uX2xhYmVsc30gYXJlIGFscmVhZHkgZXhpc3RlZCBpbiB0aGUgZ2l2ZW4gZGF0YXNldC4iCiAgICAgICAgKQoKICAgIHJldHVybiBwZC5jb25jYXQoW3gsIHBkLkRhdGFGcmFtZSh5X3ByZWQsIGNvbHVtbnM9bGFiZWxfY29sdW1ucyldLCBheGlzPTEpCgoKZGVmIF9nZXRfc2FtcGxlX3NldF9zdGF0aXN0aWNzKAogICAgc2FtcGxlX3NldDogRGF0YXNldFR5cGUgPSBOb25lLCBtb2RlbF9hcnRpZmFjdF9mZWF0dXJlX3N0YXRzOiBkaWN0ID0gTm9uZQopIC0+IGRpY3Q6CiAgICAiIiIKICAgIEdldCB0aGUgc2FtcGxlIHNldCBzdGF0aXN0aWNzIGVpdGhlciBmcm9tIHRoZSBnaXZlbiBzYW1wbGUgc2V0IG9yIHRoZSBzdGF0aXN0aWNzIGxvZ2dlZCB3aXRoIHRoZSBtb2RlbCB3aGlsZQogICAgZmF2b3JpbmcgdGhlIGdpdmVuIHNhbXBsZSBzZXQuCgogICAgOnBhcmFtIHNhbXBsZV9zZXQ6ICAgICAgICAgICAgICAgICAgIEEgc2FtcGxlIGRhdGFzZXQgdG8gZ2l2ZSB0byBjb21wYXJlIHRoZSBpbnB1dHMgaW4gdGhlIGRyaWZ0IGFuYWx5c2lzLgogICAgOnBhcmFtIG1vZGVsX2FydGlmYWN0X2ZlYXR1cmVfc3RhdHM6IFRoZSBgZmVhdHVyZV9zdGF0c2AgYXR0cmlidXRlIGluIHRoZSBzcGVjIG9mIHRoZSBtb2RlbCBhcnRpZmFjdCwgd2hlcmUgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWwgc2FtcGxlIHNldCBzdGF0aXN0aWNzIG9mIHRoZSBtb2RlbCB3YXMgdXNlZC4KCiAgICA6cmV0dXJuczogVGhlIHNhbXBsZSBzZXQgc3RhdGlzdGljcy4KCiAgICByYWlzZXMgTUxSdW5JbnZhbGlkQXJndW1lbnRFcnJvcjogSWYgbm8gc2FtcGxlIHNldCBvciBzdGF0aXN0aWNzIHdlcmUgZ2l2ZW4uCiAgICAiIiIKICAgICMgQ2hlY2sgaWYgYSBzYW1wbGUgc2V0IHdhcyBwcm92aWRlZDoKICAgIGlmIHNhbXBsZV9zZXQgaXMgTm9uZToKICAgICAgICAjIENoZWNrIGlmIHRoZSBtb2RlbCB3YXMgbG9nZ2VkIHdpdGggYSBzYW1wbGUgc2V0OgogICAgICAgIGlmIG1vZGVsX2FydGlmYWN0X2ZlYXR1cmVfc3RhdHMgaXMgTm9uZToKICAgICAgICAgICAgcmFpc2UgbWxydW4uZXJyb3JzLk1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3IoCiAgICAgICAgICAgICAgICAiQ2Fubm90IHBlcmZvcm0gZHJpZnQgYW5hbHlzaXMgYXMgdGhlcmUgaXMgbm8gc2FtcGxlIHNldCB0byBjb21wYXJlIHRvLiBUaGUgbW9kZWwgYXJ0aWZhY3Qgd2FzIG5vdCAiCiAgICAgICAgICAgICAgICAibG9nZ2VkIHdpdGggYSBzYW1wbGUgc2V0IGFuZCBgc2FtcGxlX3NldGAgd2FzIG5vdCBwcm92aWRlZCB0byB0aGUgZnVuY3Rpb24uIgogICAgICAgICAgICApCiAgICAgICAgIyBSZXR1cm4gdGhlIHN0YXRpc3RpY3MgbG9nZ2VkIHdpdGggdGhlIG1vZGVsOgogICAgICAgIHJldHVybiBtb2RlbF9hcnRpZmFjdF9mZWF0dXJlX3N0YXRzCgogICAgIyBUdXJuIHRoZSBEYXRhSXRlbSB0byBEYXRhRnJhbWU6CiAgICBpZiBpc2luc3RhbmNlKHNhbXBsZV9zZXQsIG1scnVuLkRhdGFJdGVtKToKICAgICAgICBzYW1wbGVfc2V0LCBfID0gX3JlYWRfZGF0YXNldF9hc19kYXRhZnJhbWUoZGF0YXNldD1zYW1wbGVfc2V0KQoKICAgICMgUmV0dXJuIHRoZSBzYW1wbGUgc2V0IHN0YXRpc3RpY3M6CiAgICByZXR1cm4gZ2V0X2RmX3N0YXRzKGRmPXNhbXBsZV9zZXQsIG9wdGlvbnM9SW5mZXJPcHRpb25zLkhpc3RvZ3JhbSkKCgpkZWYgX2dldF9kcmlmdF9yZXN1bHQoCiAgICB0dmQ6IGZsb2F0LAogICAgaGVsbGluZ2VyOiBmbG9hdCwKICAgIHRocmVzaG9sZDogZmxvYXQsCikgLT4gVHVwbGVbYm9vbCwgZmxvYXRdOgogICAgIiIiCiAgICBDYWxjdWxhdGUgdGhlIGRyaWZ0IHJlc3VsdCBieSB0aGUgZm9sbG93aW5nIGVxdWF0aW9uOiAodHZkICsgaGVsbGluZ2VyKSAvIDIKCiAgICA6cGFyYW0gdHZkOiAgICAgICBUaGUgZmVhdHVyZSdzIFRWRCB2YWx1ZS4KICAgIDpwYXJhbSBoZWxsaW5nZXI6IFRoZSBmZWF0dXJlJ3MgSGVsbGluZ2VyIHZhbHVlLgogICAgOnBhcmFtIHRocmVzaG9sZDogVGhlIHRocmVzaG9sZCBmcm9tIHdoaWNoIHRoZSB2YWx1ZSBpcyBjb25zaWRlcmVkIGEgZHJpZnQuCgogICAgOnJldHVybnM6IEEgdHVwbGUgb2Y6CiAgICAgICAgICAgICAgWzBdID0gQm9vbGVhbiB2YWx1ZSBhcyB0aGUgZHJpZnQgc3RhdHVzLgogICAgICAgICAgICAgIFsxXSA9IFRoZSByZXN1bHQuCiAgICAiIiIKICAgIHJlc3VsdCA9ICh0dmQgKyBoZWxsaW5nZXIpIC8gMgogICAgaWYgcmVzdWx0ID49IHRocmVzaG9sZDoKICAgICAgICByZXR1cm4gVHJ1ZSwgcmVzdWx0CiAgICByZXR1cm4gRmFsc2UsIHJlc3VsdAoKCmRlZiBfcGVyZm9ybV9kcmlmdF9hbmFseXNpcygKICAgIHNhbXBsZV9zZXRfc3RhdGlzdGljczogZGljdCwKICAgIGlucHV0czogcGQuRGF0YUZyYW1lLAogICAgZHJpZnRfdGhyZXNob2xkOiBmbG9hdCwKICAgIHBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZDogZmxvYXQsCiAgICBpbmZfY2FwcGluZzogZmxvYXQsCikgLT4gVHVwbGVbQXJ0aWZhY3QsIEFydGlmYWN0LCBkaWN0XToKICAgICIiIgogICAgUGVyZm9ybSBkcmlmdCBhbmFseXNpcywgcHJvZHVjaW5nIHRoZSBkcmlmdCB0YWJsZSBhcnRpZmFjdCBmb3IgbG9nZ2luZyBwb3N0IHByZWRpY3Rpb24uCgogICAgOnBhcmFtIHNhbXBsZV9zZXRfc3RhdGlzdGljczogICAgVGhlIHN0YXRpc3RpY3Mgb2YgdGhlIHNhbXBsZSBzZXQgbG9nZ2VkIGFsb25nIGEgbW9kZWwuCiAgICA6cGFyYW0gaW5wdXRzOiAgICAgICAgICAgICAgICAgICBJbnB1dCBkYXRhc2V0IHRvIHBlcmZvcm0gdGhlIGRyaWZ0IGNhbGN1bGF0aW9uIG9uLgogICAgOnBhcmFtIGRyaWZ0X3RocmVzaG9sZDogICAgICAgICAgVGhlIHRocmVzaG9sZCBvZiB3aGljaCB0byBtYXJrIGRyaWZ0cy4KICAgIDpwYXJhbSBwb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQ6IFRoZSB0aHJlc2hvbGQgb2Ygd2hpY2ggdG8gbWFyayBwb3NzaWJsZSBkcmlmdHMuCiAgICA6cGFyYW0gaW5mX2NhcHBpbmc6ICAgICAgICAgICAgICBUaGUgdmFsdWUgdG8gc2V0IGZvciB3aGVuIGl0IHJlYWNoZWQgaW5maW5pdHkuCgogICAgOnJldHVybnM6IEEgdHVwbGUgb2YKICAgICAgICAgICAgICBbMF0gPSBBbiBNTFJ1biBhcnRpZmFjdCBob2xkaW5nIHRoZSBIVE1MIGNvZGUgb2YgdGhlIGRyaWZ0IHRhYmxlIHBsb3QuCiAgICAgICAgICAgICAgWzFdID0gQW4gTUxSdW4gYXJ0aWZhY3QgaG9sZGluZyB0aGUgbWV0cmljIHBlciBmZWF0dXJlIGRpY3Rpb25hcnkuCiAgICAgICAgICAgICAgWzJdID0gUmVzdWx0cyB0byBsb2cgdGhlIGZpbmFsIGFuYWx5c2lzIG91dGNvbWUuCiAgICAiIiIKICAgICMgQ2FsY3VsYXRlIHRoZSBpbnB1dCdzIHN0YXRpc3RpY3M6CiAgICBpbnB1dHNfc3RhdGlzdGljcyA9IGNhbGN1bGF0ZV9pbnB1dHNfc3RhdGlzdGljcygKICAgICAgICBzYW1wbGVfc2V0X3N0YXRpc3RpY3M9c2FtcGxlX3NldF9zdGF0aXN0aWNzLAogICAgICAgIGlucHV0cz1pbnB1dHMsCiAgICApCgogICAgIyBDYWxjdWxhdGUgZHJpZnQ6CiAgICB2aXJ0dWFsX2RyaWZ0ID0gVmlydHVhbERyaWZ0KGluZl9jYXBwaW5nPWluZl9jYXBwaW5nKQogICAgbWV0cmljcyA9IHZpcnR1YWxfZHJpZnQuY29tcHV0ZV9kcmlmdF9mcm9tX2hpc3RvZ3JhbXMoCiAgICAgICAgZmVhdHVyZV9zdGF0cz1zYW1wbGVfc2V0X3N0YXRpc3RpY3MsCiAgICAgICAgY3VycmVudF9zdGF0cz1pbnB1dHNfc3RhdGlzdGljcywKICAgICkKICAgIGRyaWZ0X3Jlc3VsdHMgPSB2aXJ0dWFsX2RyaWZ0LmNoZWNrX2Zvcl9kcmlmdF9wZXJfZmVhdHVyZSgKICAgICAgICBtZXRyaWNzX3Jlc3VsdHNfZGljdGlvbmFyeT1tZXRyaWNzLAogICAgICAgIHBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZD1wb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQsCiAgICAgICAgZHJpZnRfZGV0ZWN0ZWRfdGhyZXNob2xkPWRyaWZ0X3RocmVzaG9sZCwKICAgICkKCiAgICAjIFZhbGlkYXRlIGFsbCBmZWF0dXJlIGNvbHVtbnMgbmFtZWQgdGhlIHNhbWUgYmV0d2VlbiB0aGUgaW5wdXRzIGFuZCBzYW1wbGUgc2V0czoKICAgIHNhbXBsZV9mZWF0dXJlcyA9IHNldCgKICAgICAgICBbCiAgICAgICAgICAgIGZlYXR1cmVfbmFtZQogICAgICAgICAgICBmb3IgZmVhdHVyZV9uYW1lLCBmZWF0dXJlX3N0YXRpc3RpY3MgaW4gc2FtcGxlX3NldF9zdGF0aXN0aWNzLml0ZW1zKCkKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShmZWF0dXJlX3N0YXRpc3RpY3MsIGRpY3QpCiAgICAgICAgXQogICAgKQogICAgaW5wdXRfZmVhdHVyZXMgPSBzZXQoaW5wdXRzLmNvbHVtbnMpCiAgICBpZiBsZW4oc2FtcGxlX2ZlYXR1cmVzICYgaW5wdXRfZmVhdHVyZXMpICE9IGxlbihpbnB1dF9mZWF0dXJlcyk6CiAgICAgICAgcmFpc2UgbWxydW4uZXJyb3JzLk1MUnVuSW52YWxpZEFyZ3VtZW50RXJyb3IoCiAgICAgICAgICAgIGYiTm90IGFsbCBmZWF0dXJlIG5hbWVzIHdlcmUgbWF0Y2hpbmcgYmV0d2VlbiB0aGUgaW5wdXRzIGFuZCB0aGUgc2FtcGxlIHNldCBwcm92aWRlZDogIgogICAgICAgICAgICBmIntpbnB1dF9mZWF0dXJlcyAtIHNhbXBsZV9mZWF0dXJlcyB8IHNhbXBsZV9mZWF0dXJlcyAtIGlucHV0X2ZlYXR1cmVzfSIKICAgICAgICApCgogICAgIyBQbG90OgogICAgaHRtbF9wbG90ID0gRmVhdHVyZXNEcmlmdFRhYmxlUGxvdCgpLnByb2R1Y2UoCiAgICAgICAgZmVhdHVyZXM9bGlzdChpbnB1dF9mZWF0dXJlcyksCiAgICAgICAgc2FtcGxlX3NldF9zdGF0aXN0aWNzPXNhbXBsZV9zZXRfc3RhdGlzdGljcywKICAgICAgICBpbnB1dHNfc3RhdGlzdGljcz1pbnB1dHNfc3RhdGlzdGljcywKICAgICAgICBtZXRyaWNzPW1ldHJpY3MsCiAgICAgICAgZHJpZnRfcmVzdWx0cz1kcmlmdF9yZXN1bHRzLAogICAgKQoKICAgICMgUHJlcGFyZSBtZXRyaWNzIHBlciBmZWF0dXJlIGRpY3Rpb25hcnk6CiAgICBtZXRyaWNzX3Blcl9mZWF0dXJlID0gewogICAgICAgIGZlYXR1cmU6IF9nZXRfZHJpZnRfcmVzdWx0KAogICAgICAgICAgICB0dmQ9bWV0cmljX2RpY3Rpb25hcnlbInR2ZCJdLAogICAgICAgICAgICBoZWxsaW5nZXI9bWV0cmljX2RpY3Rpb25hcnlbImhlbGxpbmdlciJdLAogICAgICAgICAgICB0aHJlc2hvbGQ9ZHJpZnRfdGhyZXNob2xkLAogICAgICAgIClbMV0KICAgICAgICBmb3IgZmVhdHVyZSwgbWV0cmljX2RpY3Rpb25hcnkgaW4gbWV0cmljcy5pdGVtcygpCiAgICAgICAgaWYgaXNpbnN0YW5jZShtZXRyaWNfZGljdGlvbmFyeSwgZGljdCkKICAgIH0KCiAgICAjIENhbGN1bGF0ZSB0aGUgZmluYWwgYW5hbHlzaXMgcmVzdWx0OgogICAgZHJpZnRfc3RhdHVzLCBkcmlmdF9tZXRyaWMgPSBfZ2V0X2RyaWZ0X3Jlc3VsdCgKICAgICAgICB0dmQ9bWV0cmljc1sidHZkX21lYW4iXSwKICAgICAgICBoZWxsaW5nZXI9bWV0cmljc1siaGVsbGluZ2VyX21lYW4iXSwKICAgICAgICB0aHJlc2hvbGQ9ZHJpZnRfdGhyZXNob2xkLAogICAgKQoKICAgIHJldHVybiAoCiAgICAgICAgQXJ0aWZhY3QoYm9keT1odG1sX3Bsb3QsIGZvcm1hdD0iaHRtbCIsIGtleT0iZHJpZnRfdGFibGVfcGxvdCIpLAogICAgICAgIEFydGlmYWN0KAogICAgICAgICAgICBib2R5PWpzb24uZHVtcHMobWV0cmljc19wZXJfZmVhdHVyZSksCiAgICAgICAgICAgIGZvcm1hdD0ianNvbiIsCiAgICAgICAgICAgIGtleT0iZmVhdHVyZXNfZHJpZnRfcmVzdWx0cyIsCiAgICAgICAgKSwKICAgICAgICB7ImRyaWZ0X3N0YXR1cyI6IGRyaWZ0X3N0YXR1cywgImRyaWZ0X21ldHJpYyI6IGRyaWZ0X21ldHJpY30sCiAgICApCgoKZGVmIHByZWRpY3QoCiAgICBjb250ZXh0OiBtbHJ1bi5NTENsaWVudEN0eCwKICAgIG1vZGVsOiBzdHIsCiAgICBkYXRhc2V0OiBEYXRhc2V0VHlwZSwKICAgIGRyb3BfY29sdW1uczogVW5pb25bc3RyLCBMaXN0W3N0cl0sIGludCwgTGlzdFtpbnRdXSA9IE5vbmUsCiAgICBsYWJlbF9jb2x1bW5zOiBVbmlvbltzdHIsIExpc3Rbc3RyXV0gPSBOb25lLAogICAgbG9nX3Jlc3VsdF9zZXQ6IGJvb2wgPSBUcnVlLAogICAgcmVzdWx0X3NldF9uYW1lOiBzdHIgPSAicHJlZGljdGlvbiIsCiAgICBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzOiBib29sID0gTm9uZSwKICAgIHNhbXBsZV9zZXQ6IERhdGFzZXRUeXBlID0gTm9uZSwKICAgIGRyaWZ0X3RocmVzaG9sZDogZmxvYXQgPSAwLjcsCiAgICBwb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQ6IGZsb2F0ID0gMC41LAogICAgaW5mX2NhcHBpbmc6IGZsb2F0ID0gMTAuMCwKICAgIGFydGlmYWN0c190YWc6IHN0ciA9ICIiLAogICAgKipwcmVkaWN0X2t3YXJnczogRGljdFtzdHIsIEFueV0sCik6CiAgICAiIiIKICAgIFBlcmZvcm0gYSBwcmVkaWN0aW9uIG9uIGEgZ2l2ZW4gZGF0YXNldCB3aXRoIHRoZSBnaXZlbiBtb2RlbC4gQ2FuIHBlcmZvcm0gZHJpZnQgYW5hbHlzaXMgYmV0d2VlbiB0aGUgc2FtcGxlIHNldAogICAgc3RhdGlzdGljcyBzdG9yZWQgaW4gdGhlIG1vZGVsIHRvIHRoZSBjdXJyZW50IGlucHV0IGRhdGEuIFRoZSBkcmlmdCBydWxlIGlzIHRoZSB2YWx1ZSBwZXItZmVhdHVyZSBtZWFuIG9mIHRoZSBUVkQKICAgIGFuZCBIZWxsaW5nZXIgc2NvcmVzIGFjY29yZGluZyB0byB0aGUgdGhyZXNob2xkcyBjb25maWd1cmVzIGhlcmUuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICAgICAgICAgTUxSdW4gY29udGV4dC4KICAgIDpwYXJhbSBtb2RlbDogICAgICAgICAgICAgICAgICAgIFRoZSBtb2RlbCBTdG9yZSBwYXRoLgogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgICAgICAgICAgICAgVGhlIGRhdGFzZXQgdG8gaW5mZXIgdGhyb3VnaCB0aGUgbW9kZWwuIENhbiBiZSBwYXNzZWQgaW4gYGlucHV0c2AgYXMgZWl0aGVyIGEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERhdGFzZXQgYXJ0aWZhY3QgLyBGZWF0dXJlIHZlY3RvciBVUkkuIE9yLCBpbiBgcGFyYW1ldGVyc2AgYXMgYSBsaXN0LCBkaWN0aW9uYXJ5IG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBudW1weSBhcnJheS4KICAgIDpwYXJhbSBkcm9wX2NvbHVtbnM6ICAgICAgICAgICAgIEEgc3RyaW5nIC8gaW50ZWdlciBvciBhIGxpc3Qgb2Ygc3RyaW5ncyAvIGludGVnZXJzIHRoYXQgcmVwcmVzZW50IHRoZSBjb2x1bW4gbmFtZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8gaW5kaWNlcyB0byBkcm9wLiBXaGVuIHRoZSBkYXRhc2V0IGlzIGEgbGlzdCBvciBhIG51bXB5IGFycmF5IHRoaXMgcGFyYW1ldGVyIG11c3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlIHJlcHJlc2VudGVkIGJ5IGludGVnZXJzLgogICAgOnBhcmFtIGxhYmVsX2NvbHVtbnM6ICAgICAgICAgICAgVGhlIHRhcmdldCBsYWJlbChzKSBvZiB0aGUgY29sdW1uKHMpIGluIHRoZSBkYXRhc2V0IGZvciBSZWdyZXNzaW9uIG9yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDbGFzc2lmaWNhdGlvbiB0YXNrcy4KICAgIDpwYXJhbSBsb2dfcmVzdWx0X3NldDogICAgICAgICAgIFdoZXRoZXIgdG8gbG9nIHRoZSByZXN1bHQgc2V0IC0gYSBEYXRhRnJhbWUgb2YgdGhlIGdpdmVuIGlucHV0cyBjb25jYXRlbmF0ZWQgd2l0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHByZWRpY3Rpb25zLiBEZWZhdWx0ZWQgdG8gVHJ1ZS4KICAgIDpwYXJhbSByZXN1bHRfc2V0X25hbWU6ICAgICAgICAgIFRoZSBkYiBrZXkgdG8gc2V0IG5hbWUgb2YgdGhlIHByZWRpY3Rpb24gcmVzdWx0IGFuZCB0aGUgZmlsZW5hbWUuIERlZmF1bHRlZCB0bwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3ByZWRpY3Rpb24nLgogICAgOnBhcmFtIHBlcmZvcm1fZHJpZnRfYW5hbHlzaXM6ICAgV2hldGhlciB0byBwZXJmb3JtIGRyaWZ0IGFuYWx5c2lzIGJldHdlZW4gdGhlIHNhbXBsZSBzZXQgb2YgdGhlIG1vZGVsIG9iamVjdCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzZXQgZ2l2ZW4uIEJ5IGRlZmF1bHQsIE5vbmUsIHdoaWNoIG1lYW5zIGl0IHdpbGwgcGVyZm9ybSBkcmlmdCBhbmFseXNpcyBpZiB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsIGhhcyBhIHNhbXBsZSBzZXQgc3RhdGlzdGljcy4gUGVyZm9ybSBkcmlmdCBhbmFseXNpcyB3aWxsIHByb2R1Y2UgYSBkYXRhIGRyaWZ0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWJsZSBhcnRpZmFjdC4KICAgIDpwYXJhbSBzYW1wbGVfc2V0OiAgICAgICAgICAgICAgIEEgc2FtcGxlIGRhdGFzZXQgdG8gZ2l2ZSB0byBjb21wYXJlIHRoZSBpbnB1dHMgaW4gdGhlIGRyaWZ0IGFuYWx5c2lzLiBUaGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvc2VuIHNhbXBsZSBzZXQgd2lsbCBhbHdheXMgYmUgdGhlIG9uZSB3aG8gaXMgc2V0IGluIHRoZSBtb2RlbCBhcnRpZmFjdCBpdHNlbGYuCiAgICA6cGFyYW0gZHJpZnRfdGhyZXNob2xkOiAgICAgICAgICBUaGUgdGhyZXNob2xkIG9mIHdoaWNoIHRvIG1hcmsgZHJpZnRzLiBEZWZhdWx0ZWQgdG8gMC43LgogICAgOnBhcmFtIHBvc3NpYmxlX2RyaWZ0X3RocmVzaG9sZDogVGhlIHRocmVzaG9sZCBvZiB3aGljaCB0byBtYXJrIHBvc3NpYmxlIGRyaWZ0cy4gRGVmYXVsdGVkIHRvIDAuNS4KICAgIDpwYXJhbSBpbmZfY2FwcGluZzogICAgICAgICAgICAgIFRoZSB2YWx1ZSB0byBzZXQgZm9yIHdoZW4gaXQgcmVhY2hlZCBpbmZpbml0eS4gRGVmYXVsdGVkIHRvIDEwLjAuCiAgICA6cGFyYW0gYXJ0aWZhY3RzX3RhZzogICAgICAgICAgICBUYWcgdG8gdXNlIGZvciBhbGwgdGhlIGFydGlmYWN0cyByZXN1bHRlZCBmcm9tIHRoZSBmdW5jdGlvbi4KICAgICIiIgogICAgIyBHZXQgZGF0YXNldCBieSBVUkwgb3IgYnkgRmVhdHVyZVZlY3RvcjoKICAgIHgsIGxhYmVsX2NvbHVtbnMgPSBfcmVhZF9kYXRhc2V0X2FzX2RhdGFmcmFtZSgKICAgICAgICBkYXRhc2V0PWRhdGFzZXQsCiAgICAgICAgbGFiZWxfY29sdW1ucz1sYWJlbF9jb2x1bW5zLAogICAgICAgIGRyb3BfY29sdW1ucz1kcm9wX2NvbHVtbnMsCiAgICApCgogICAgIyBMb2FkaW5nIHRoZSBtb2RlbDoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJMb2FkaW5nIG1vZGVsLi4uIikKICAgIG1vZGVsX2hhbmRsZXIgPSBBdXRvTUxSdW4ubG9hZF9tb2RlbChtb2RlbF9wYXRoPW1vZGVsLCBjb250ZXh0PWNvbnRleHQpCgogICAgIyBQcmVkaWN0OgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmIkNhbGN1bGF0aW5nIHByZWRpY3Rpb24uLi4iKQogICAgeV9wcmVkID0gbW9kZWxfaGFuZGxlci5tb2RlbC5wcmVkaWN0KHgsICoqcHJlZGljdF9rd2FyZ3MpCgogICAgIyBQcmVwYXJlIHRoZSByZXN1bHQgc2V0OgogICAgcmVzdWx0X3NldCA9IF9wcmVwYXJlX3Jlc3VsdF9zZXQoeD14LCBsYWJlbF9jb2x1bW5zPWxhYmVsX2NvbHVtbnMsIHlfcHJlZD15X3ByZWQpCgogICAgIyBDaGVjayBmb3IgbG9nZ2luZyB0aGUgcmVzdWx0IHNldDoKICAgIGlmIGxvZ19yZXN1bHRfc2V0OgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJMb2dnaW5nIHJlc3VsdCBzZXQgKHggfCBwcmVkaWN0aW9uKS4uLiIpCiAgICAgICAgY29udGV4dC5sb2dfZGF0YXNldCgKICAgICAgICAgICAga2V5PXJlc3VsdF9zZXRfbmFtZSwKICAgICAgICAgICAgZGY9cmVzdWx0X3NldCwKICAgICAgICAgICAgZGJfa2V5PXJlc3VsdF9zZXRfbmFtZSwKICAgICAgICAgICAgdGFnPWFydGlmYWN0c190YWcsCiAgICAgICAgKQoKICAgICMgQ2hlY2sgZm9yIHBlcmZvcm1pbmcgZHJpZnQgYW5hbHlzaXM6CiAgICBpZiAoCiAgICAgICAgcGVyZm9ybV9kcmlmdF9hbmFseXNpcyBpcyBOb25lCiAgICAgICAgYW5kIG1vZGVsX2hhbmRsZXIuX21vZGVsX2FydGlmYWN0LnNwZWMuZmVhdHVyZV9zdGF0cyBpcyBub3QgTm9uZQogICAgKToKICAgICAgICBwZXJmb3JtX2RyaWZ0X2FuYWx5c2lzID0gVHJ1ZQogICAgaWYgcGVyZm9ybV9kcmlmdF9hbmFseXNpczoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCJQZXJmb3JtaW5nIGRyaWZ0IGFuYWx5c2lzLi4uIikKICAgICAgICAjIEdldCB0aGUgc2FtcGxlIHNldCBzdGF0aXN0aWNzIChlaXRoZXIgZnJvbSB0aGUgc2FtcGxlIHNldCBvciBmcm9tIHRoZSBzdGF0aXN0aWNzIGxvZ2dlZCB3aXRoIHRoZSBtb2RlbCk6CiAgICAgICAgc2FtcGxlX3NldF9zdGF0aXN0aWNzID0gX2dldF9zYW1wbGVfc2V0X3N0YXRpc3RpY3MoCiAgICAgICAgICAgIHNhbXBsZV9zZXQ9c2FtcGxlX3NldCwKICAgICAgICAgICAgbW9kZWxfYXJ0aWZhY3RfZmVhdHVyZV9zdGF0cz1tb2RlbF9oYW5kbGVyLl9tb2RlbF9hcnRpZmFjdC5zcGVjLmZlYXR1cmVfc3RhdHMsCiAgICAgICAgKQogICAgICAgICMgUHJvZHVjZSB0aGUgYXJ0aWZhY3Q6CiAgICAgICAgKAogICAgICAgICAgICBkcmlmdF90YWJsZV9wbG90LAogICAgICAgICAgICBtZXRyaWNfcGVyX2ZlYXR1cmVfZGljdCwKICAgICAgICAgICAgYW5hbHlzaXNfcmVzdWx0cywKICAgICAgICApID0gX3BlcmZvcm1fZHJpZnRfYW5hbHlzaXMoCiAgICAgICAgICAgIHNhbXBsZV9zZXRfc3RhdGlzdGljcz1zYW1wbGVfc2V0X3N0YXRpc3RpY3MsCiAgICAgICAgICAgIGlucHV0cz1yZXN1bHRfc2V0LAogICAgICAgICAgICBkcmlmdF90aHJlc2hvbGQ9ZHJpZnRfdGhyZXNob2xkLAogICAgICAgICAgICBwb3NzaWJsZV9kcmlmdF90aHJlc2hvbGQ9cG9zc2libGVfZHJpZnRfdGhyZXNob2xkLAogICAgICAgICAgICBpbmZfY2FwcGluZz1pbmZfY2FwcGluZywKICAgICAgICApCiAgICAgICAgIyBMb2cgdGhlIGFydGlmYWN0IGFuZCByZXN1bHRzOgogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KGRyaWZ0X3RhYmxlX3Bsb3QsIHRhZz1hcnRpZmFjdHNfdGFnKQogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KG1ldHJpY19wZXJfZmVhdHVyZV9kaWN0LCB0YWc9YXJ0aWZhY3RzX3RhZykKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHRzKHJlc3VsdHM9YW5hbHlzaXNfcmVzdWx0cykK
    base_image: mlrun/ml-models
    commands:
    - python -m pip install scikit-learn
    code_origin: https://github.com/guy1992l/functions.git#c16f301b8bfadb28635dc11053fb6a91e03ae607:/Users/guyl/Projects/functions/batch_predict/batch_predict.py
    origin_filename: /Users/guyl/Projects/functions/batch_predict/batch_predict.py
    with_mlrun: false
    auto_build: true
  entry_points:
    predict:
      name: predict
      doc: 'Perform a prediction on a given dataset with the given model. Can perform
        drift analysis between the sample set

        statistics stored in the model to the current input data. The drift rule is
        the value per-feature mean of the TVD

        and Hellinger scores according to the thresholds configures here.'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context.
        default: ''
      - name: model
        type: str
        doc: The model Store path.
        default: ''
      - name: dataset
        type: DatasetType
        doc: The dataset to infer through the model. Can be passed in `inputs` as
          either a Dataset artifact / Feature vector URI. Or, in `parameters` as a
          list, dictionary or numpy array.
        default: ''
      - name: drop_columns
        type: Union[str, List[str], int, List[int]]
        doc: A string / integer or a list of strings / integers that represent the
          column names / indices to drop. When the dataset is a list or a numpy array
          this parameter must be represented by integers.
        default: null
      - name: label_columns
        type: Union[str, List[str]]
        doc: The target label(s) of the column(s) in the dataset for Regression or
          Classification tasks.
        default: null
      - name: log_result_set
        type: bool
        doc: Whether to log the result set - a DataFrame of the given inputs concatenated
          with the predictions. Defaulted to True.
        default: true
      - name: result_set_name
        type: str
        doc: The db key to set name of the prediction result and the filename. Defaulted
          to 'prediction'.
        default: prediction
      - name: perform_drift_analysis
        type: bool
        doc: Whether to perform drift analysis between the sample set of the model
          object to the dataset given. By default, None, which means it will perform
          drift analysis if the model has a sample set statistics. Perform drift analysis
          will produce a data drift table artifact.
        default: null
      - name: sample_set
        type: DatasetType
        doc: A sample dataset to give to compare the inputs in the drift analysis.
          The default chosen sample set will always be the one who is set in the model
          artifact itself.
        default: null
      - name: drift_threshold
        type: float
        doc: The threshold of which to mark drifts. Defaulted to 0.7.
        default: 0.7
      - name: possible_drift_threshold
        type: float
        doc: The threshold of which to mark possible drifts. Defaulted to 0.5.
        default: 0.5
      - name: inf_capping
        type: float
        doc: The value to set for when it reached infinity. Defaulted to 10.0.
        default: 10.0
      - name: artifacts_tag
        type: str
        doc: Tag to use for all the artifacts resulted from the function.
        default: ''
      outputs:
      - default: ''
      lineno: 298
  description: Batch prediction for the common ML frameworks (SciKit-Learn, XGBoost
    and LightGBM) while performing data drift analysis.
  default_handler: predict
  disable_auto_mount: false
  allow_empty_resources: true
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
