kind: job
metadata:
  name: speaker-diarization
  tag: ''
  hash: 0cbf8006c28b7814298b16e8de3254d869b69199
  project: ''
  labels:
    author: pgw
  categories:
  - data-preparation
  - machine-learning
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  build:
    functionSourceCode: IyBDb3B5cmlnaHQgMjAxOSBJZ3VhemlvCiMKIyBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiMgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0CiMKIyAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiMKIyBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlCiMgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKIyBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KIyBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kCiMgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiMKaW1wb3J0IG9zCmltcG9ydCBwYXRobGliCmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgbGlicm9zYQppbXBvcnQgbWxydW4KaW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIHRxZG0uYXV0byBpbXBvcnQgdHFkbQppbXBvcnQganNvbgppbXBvcnQgcHlkdWIKZnJvbSBweWFubm90ZS5jb3JlIGltcG9ydCBub3RlYm9vaywgU2VnbWVudCwgQW5ub3RhdGlvbgpmcm9tIGZ1bmN0b29scyBpbXBvcnQgcGFydGlhbApmcm9tIG9tZWdhY29uZiBpbXBvcnQgT21lZ2FDb25mCmZyb20gZGF0YWNsYXNzZXMgaW1wb3J0IGRhdGFjbGFzcywgZmllbGQsIGFzZGljdApmcm9tIHR5cGluZyBpbXBvcnQgTGlzdCwgRGljdCwgQW55LCBPcHRpb25hbCwgTGl0ZXJhbCwgVHVwbGUKZnJvbSBuZW1vLmNvbGxlY3Rpb25zLmFzci5tb2RlbHMgaW1wb3J0IENsdXN0ZXJpbmdEaWFyaXplcgpmcm9tIG5lbW8uY29sbGVjdGlvbnMuYXNyLnBhcnRzLnV0aWxzLnNwZWFrZXJfdXRpbHMgaW1wb3J0ICgKICAgIHJ0dG1fdG9fbGFiZWxzLAogICAgbGFiZWxzX3RvX3B5YW5ub3RlX29iamVjdCwKKQoKCiMgVXNpbmcgTmVtbyB0byBkbyBzcGVha2VyIGRpYXJpemF0aW9uIHdlIG5lZWQgdGhlIGZvbGxvd2luZyBzdGVwczoKIyAxLiBWb2ljZSBBY3Rpdml0eSBEZXRlY3Rpb24sIHdoaWNoIHBhcnQgb2YgdGhlIGF1ZGlvIGlzIHNwZWVjaCBhbmQgd2hpY2ggcGFydCBpcyBub3QKIyAyLiBTcGVha2VyIEVtYmVkZGluZyBpcyB1c2VkIHRvIGV4dHJhY3QgdGhlIGZlYXR1cmVzIG9mIHRoZSBzcGVlY2gKIyAzLiBDbHVzdGVyaW5nIHRoZSBlbWJlZGRpbmcgZ2V0IHRoZSBjbHVzdGVycyBvZiBzcGVha2VycwojIDQuIE11bHRpc2NhbGUgRGlhcml6YXRpb24gZGVjb2RlciBpcyB1c2VkIHRvIG9idGFpbiB0aGUgc3BlYWtlciBwcm9maWxlIGFuZCBlc3RpbWF0ZWQgbnVtYmVyIG9mIHNwZWFrZXJzCgoKQGRhdGFjbGFzcwpjbGFzcyBHZW5lcmFsQ29uZmlnOgogICAgbmFtZTogc3RyID0gIkNsdXN0ZXJEaWFyaXplciIKICAgIG51bV93b3JrZXJzOiBpbnQgPSAxCiAgICBzYW1wbGVfcmF0ZTogaW50ID0gMTYwMDAKICAgIGJhdGNoX3NpemU6IGludCA9IDY0CiAgICBkZXZpY2U6IE9wdGlvbmFsWwogICAgICAgIHN0cgogICAgXSA9IE5vbmUgICMgU2V0IHRvICdjdWRhOjEnLCAnY3VkYToyJywgZXRjLiwgZm9yIHNwZWNpZmljIGRldmljZXMKICAgIHZlcmJvc2U6IGJvb2wgPSBUcnVlCgoKIyBQYXJhbWV0ZXJzIGZvciBWQUQgKFZvaWNlIEFjdGl2aXR5IERldGVjdGlvbikKQGRhdGFjbGFzcwpjbGFzcyBWQURQYXJhbWV0ZXJzOgogICAgd2luZG93X2xlbmd0aF9pbl9zZWM6IGZsb2F0ID0gMC4xNSAgIyBXaW5kb3cgbGVuZ3RoIGluIHNlY29uZHMgZm9yIFZBRCBjb250ZXh0IGlucHV0CiAgICBzaGlmdF9sZW5ndGhfaW5fc2VjOiBmbG9hdCA9ICgKICAgICAgICAwLjAxICAjIFNoaWZ0IGxlbmd0aCBpbiBzZWNvbmRzIHRvIGdlbmVyYXRlIGZyYW1lLWxldmVsIFZBRCBwcmVkaWN0aW9uCiAgICApCiAgICBzbW9vdGhpbmc6IHN0ciA9ICJtZWRpYW4iICAjIFR5cGUgb2Ygc21vb3RoaW5nIG1ldGhvZCAoZS5nLiwgIm1lZGlhbiIpCiAgICBvdmVybGFwOiBmbG9hdCA9IDAuNSAgIyBPdmVybGFwIHJhdGlvIGZvciBvdmVybGFwcGVkIG1lYW4vbWVkaWFuIHNtb290aGluZyBmaWx0ZXIKICAgIG9uc2V0OiBmbG9hdCA9IDAuMSAgIyBPbnNldCB0aHJlc2hvbGQgZm9yIGRldGVjdGluZyB0aGUgYmVnaW5uaW5nIG9mIHNwZWVjaAogICAgb2Zmc2V0OiBmbG9hdCA9IDAuMSAgIyBPZmZzZXQgdGhyZXNob2xkIGZvciBkZXRlY3RpbmcgdGhlIGVuZCBvZiBzcGVlY2gKICAgIHBhZF9vbnNldDogZmxvYXQgPSAwLjEgICMgQWRkaXRpb25hbCBkdXJhdGlvbiBiZWZvcmUgZWFjaCBzcGVlY2ggc2VnbWVudAogICAgcGFkX29mZnNldDogZmxvYXQgPSAwICAjIEFkZGl0aW9uYWwgZHVyYXRpb24gYWZ0ZXIgZWFjaCBzcGVlY2ggc2VnbWVudAogICAgbWluX2R1cmF0aW9uX29uOiBmbG9hdCA9IDAgICMgVGhyZXNob2xkIGZvciBzbWFsbCBub24tc3BlZWNoIGRlbGV0aW9uCiAgICBtaW5fZHVyYXRpb25fb2ZmOiBmbG9hdCA9IDAuMiAgIyBUaHJlc2hvbGQgZm9yIHNob3J0IHNwZWVjaCBzZWdtZW50IGRlbGV0aW9uCiAgICBmaWx0ZXJfc3BlZWNoX2ZpcnN0OiBib29sID0gVHJ1ZSAgIyBXaGV0aGVyIHRvIGFwcGx5IGEgc3BlZWNoLWZpcnN0IGZpbHRlcgoKCiMgTWFpbiBWQUQgQ29uZmlndXJhdGlvbgpAZGF0YWNsYXNzCmNsYXNzIFZBRENvbmZpZzoKICAgIG1vZGVsX3BhdGg6IHN0ciA9ICJ2YWRfbXVsdGlsaW5ndWFsX21hcmJsZW5ldCIgICMgUGF0aCB0byB0aGUgVkFEIG1vZGVsCiAgICBleHRlcm5hbF92YWRfbWFuaWZlc3Q6IE9wdGlvbmFsWwogICAgICAgIHN0cgogICAgXSA9IE5vbmUgICMgT3B0aW9uYWwgcGF0aCB0byBhbiBleHRlcm5hbCBWQUQgbWFuaWZlc3QKICAgIHBhcmFtZXRlcnM6IFZBRFBhcmFtZXRlcnMgPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9VkFEUGFyYW1ldGVycwogICAgKSAgIyBOZXN0ZWQgVkFEIHBhcmFtZXRlcnMKCgojIFBhcmFtZXRlcnMgZm9yIFNwZWFrZXIgRW1iZWRkaW5ncwpAZGF0YWNsYXNzCmNsYXNzIFNwZWFrZXJFbWJlZGRpbmdzUGFyYW1ldGVyczoKICAgIHdpbmRvd19sZW5ndGhfaW5fc2VjOiBMaXN0W2Zsb2F0XSA9IGZpZWxkKAogICAgICAgIGRlZmF1bHRfZmFjdG9yeT1sYW1iZGE6IFsxLjUsIDEuMjUsIDEuMCwgMC43NSwgMC41XQogICAgKSAgIyBXaW5kb3cgbGVuZ3RocyBmb3Igc3BlYWtlciBlbWJlZGRpbmdzCiAgICBzaGlmdF9sZW5ndGhfaW5fc2VjOiBMaXN0W2Zsb2F0XSA9IGZpZWxkKAogICAgICAgIGRlZmF1bHRfZmFjdG9yeT1sYW1iZGE6IFswLjc1LCAwLjYyNSwgMC41LCAwLjM3NSwgMC4yNV0KICAgICkgICMgU2hpZnQgbGVuZ3RocyBmb3Igc3BlYWtlciBlbWJlZGRpbmdzCiAgICBtdWx0aXNjYWxlX3dlaWdodHM6IExpc3RbaW50XSA9IGZpZWxkKAogICAgICAgIGRlZmF1bHRfZmFjdG9yeT1sYW1iZGE6IFsxLCAxLCAxLCAxLCAxXQogICAgKSAgIyBXZWlnaHRzIGZvciBlYWNoIHNjYWxlCiAgICBzYXZlX2VtYmVkZGluZ3M6IGJvb2wgPSBUcnVlICAjIFdoZXRoZXIgdG8gc2F2ZSB0aGUgc3BlYWtlciBlbWJlZGRpbmdzCgoKIyBNYWluIFNwZWFrZXIgRW1iZWRkaW5ncyBDb25maWd1cmF0aW9uCkBkYXRhY2xhc3MKY2xhc3MgU3BlYWtlckVtYmVkZGluZ3NDb25maWc6CiAgICBtb2RlbF9wYXRoOiBzdHIgPSAidGl0YW5ldF9sYXJnZSIgICMgUGF0aCB0byB0aGUgc3BlYWtlciBlbWJlZGRpbmdzIG1vZGVsCiAgICBwYXJhbWV0ZXJzOiBTcGVha2VyRW1iZWRkaW5nc1BhcmFtZXRlcnMgPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9U3BlYWtlckVtYmVkZGluZ3NQYXJhbWV0ZXJzCiAgICApICAjIE5lc3RlZCBzcGVha2VyIGVtYmVkZGluZ3MgcGFyYW1ldGVycwoKCiMgUGFyYW1ldGVycyBmb3IgQ2x1c3RlcmluZwpAZGF0YWNsYXNzCmNsYXNzIENsdXN0ZXJpbmdQYXJhbWV0ZXJzOgogICAgb3JhY2xlX251bV9zcGVha2VyczogYm9vbCA9IEZhbHNlICAjIFdoZXRoZXIgdG8gdXNlIHRoZSBvcmFjbGUgbnVtYmVyIG9mIHNwZWFrZXJzCiAgICBtYXhfbnVtX3NwZWFrZXJzOiBpbnQgPSA4ICAjIE1heGltdW0gbnVtYmVyIG9mIHNwZWFrZXJzIHBlciByZWNvcmRpbmcKICAgIGVuaGFuY2VkX2NvdW50X3RocmVzOiBpbnQgPSA4MCAgIyBUaHJlc2hvbGQgZm9yIGVuaGFuY2VkIHNwZWFrZXIgY291bnRpbmcKICAgIG1heF9ycF90aHJlc2hvbGQ6IGZsb2F0ID0gMC4yNSAgIyBNYXggcmFuZ2Ugb2YgcC12YWx1ZSBzZWFyY2ggZm9yIHJlc2VnbWVudGF0aW9uCiAgICBzcGFyc2Vfc2VhcmNoX3ZvbHVtZTogaW50ID0gMzAgICMgTnVtYmVyIG9mIHZhbHVlcyB0byBleGFtaW5lIGZvciBzcGFyc2Ugc2VhcmNoCiAgICBtYWpfdm90ZV9zcGtfY291bnQ6IGJvb2wgPSAoCiAgICAgICAgRmFsc2UgICMgV2hldGhlciB0byB0YWtlIGEgbWFqb3JpdHkgdm90ZSBmb3Igc3BlYWtlciBjb3VudAogICAgKQoKCiMgTWFpbiBDbHVzdGVyaW5nIENvbmZpZ3VyYXRpb24KQGRhdGFjbGFzcwpjbGFzcyBDbHVzdGVyaW5nQ29uZmlnOgogICAgcGFyYW1ldGVyczogQ2x1c3RlcmluZ1BhcmFtZXRlcnMgPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9Q2x1c3RlcmluZ1BhcmFtZXRlcnMKICAgICkgICMgTmVzdGVkIGNsdXN0ZXJpbmcgcGFyYW1ldGVycwoKCiMgUGFyYW1ldGVycyBmb3IgTVNERCAoTXVsdGlzY2FsZSBEaWFyaXphdGlvbiBEZWNvZGVyKSBNb2RlbApAZGF0YWNsYXNzCmNsYXNzIE1TRERQYXJhbWV0ZXJzOgogICAgdXNlX3NwZWFrZXJfbW9kZWxfZnJvbV9ja3B0OiBib29sID0gKAogICAgICAgIFRydWUgICMgV2hldGhlciB0byB1c2UgdGhlIHNwZWFrZXIgbW9kZWwgZnJvbSB0aGUgY2hlY2twb2ludAogICAgKQogICAgaW5mZXJfYmF0Y2hfc2l6ZTogaW50ID0gMjUgICMgQmF0Y2ggc2l6ZSBmb3IgTVNERCBpbmZlcmVuY2UKICAgIHNpZ21vaWRfdGhyZXNob2xkOiBMaXN0W2Zsb2F0XSA9IGZpZWxkKAogICAgICAgIGRlZmF1bHRfZmFjdG9yeT1sYW1iZGE6IFswLjddCiAgICApICAjIFNpZ21vaWQgdGhyZXNob2xkIGZvciBiaW5hcml6ZWQgc3BlYWtlciBsYWJlbHMKICAgIHNlcV9ldmFsX21vZGU6IGJvb2wgPSAoCiAgICAgICAgRmFsc2UgICMgV2hldGhlciB0byB1c2Ugb3JhY2xlIG51bWJlciBvZiBzcGVha2VycyBmb3Igc2VxdWVuY2UgZXZhbHVhdGlvbgogICAgKQogICAgc3BsaXRfaW5mZXI6IGJvb2wgPSBUcnVlICAjIFdoZXRoZXIgdG8gc3BsaXQgdGhlIGlucHV0IGF1ZGlvIGZvciBpbmZlcmVuY2UKICAgIGRpYXJfd2luZG93X2xlbmd0aDogaW50ID0gKAogICAgICAgIDUwICAjIExlbmd0aCBvZiB0aGUgc3BsaXQgc2hvcnQgc2VxdWVuY2Ugd2hlbiBzcGxpdF9pbmZlciBpcyBUcnVlCiAgICApCiAgICBvdmVybGFwX2luZmVyX3Nwa19saW1pdDogaW50ID0gKAogICAgICAgIDUgICMgTGltaXQgZm9yIGVzdGltYXRlZCBudW1iZXIgb2Ygc3BlYWtlcnMgZm9yIG92ZXJsYXAgaW5mZXJlbmNlCiAgICApCgoKIyBNYWluIE1TREQgQ29uZmlndXJhdGlvbgpAZGF0YWNsYXNzCmNsYXNzIE1TRERDb25maWc6CiAgICBtb2RlbF9wYXRoOiBzdHIgPSAiZGlhcl9tc2RkX3RlbGVwaG9uaWMiICAjIFBhdGggdG8gdGhlIE1TREQgbW9kZWwKICAgIHBhcmFtZXRlcnM6IE1TRERQYXJhbWV0ZXJzID0gZmllbGQoCiAgICAgICAgZGVmYXVsdF9mYWN0b3J5PU1TRERQYXJhbWV0ZXJzCiAgICApICAjIE5lc3RlZCBNU0REIHBhcmFtZXRlcnMKCgojIE1haW4gRGlhcml6YXRpb24gQ29uZmlndXJhdGlvbgpAZGF0YWNsYXNzCmNsYXNzIERpYXJpemF0aW9uQ29uZmlnOgogICAgbWFuaWZlc3RfZmlsZXBhdGg6IHN0ciAgIyBQYXRoIHRvIHRoZSBtYW5pZmVzdCBmaWxlCiAgICBvdXRfZGlyOiBzdHIgICMgT3V0cHV0IGRpcmVjdG9yeQogICAgb3JhY2xlX3ZhZDogYm9vbCA9IEZhbHNlICAjIFdoZXRoZXIgdG8gdXNlIG9yYWNsZSBWQUQKICAgIGNvbGxhcjogZmxvYXQgPSAwLjI1ICAjIENvbGxhciB2YWx1ZSBmb3Igc2NvcmluZwogICAgaWdub3JlX292ZXJsYXA6IGJvb2wgPSBUcnVlICAjIFdoZXRoZXIgdG8gaWdub3JlIG92ZXJsYXAgc2VnbWVudHMKICAgIHZhZDogVkFEQ29uZmlnID0gZmllbGQoZGVmYXVsdF9mYWN0b3J5PVZBRENvbmZpZykgICMgTmVzdGVkIFZBRCBjb25maWd1cmF0aW9uCiAgICBzcGVha2VyX2VtYmVkZGluZ3M6IFNwZWFrZXJFbWJlZGRpbmdzQ29uZmlnID0gZmllbGQoCiAgICAgICAgZGVmYXVsdF9mYWN0b3J5PVNwZWFrZXJFbWJlZGRpbmdzQ29uZmlnCiAgICApICAjIE5lc3RlZCBzcGVha2VyIGVtYmVkZGluZ3MgY29uZmlndXJhdGlvbgogICAgY2x1c3RlcmluZzogQ2x1c3RlcmluZ0NvbmZpZyA9IGZpZWxkKAogICAgICAgIGRlZmF1bHRfZmFjdG9yeT1DbHVzdGVyaW5nQ29uZmlnCiAgICApICAjIE5lc3RlZCBjbHVzdGVyaW5nIGNvbmZpZ3VyYXRpb24KICAgIG1zZGRfbW9kZWw6IE1TRERDb25maWcgPSBmaWVsZCgKICAgICAgICBkZWZhdWx0X2ZhY3Rvcnk9TVNERENvbmZpZwogICAgKSAgIyBOZXN0ZWQgTVNERCBjb25maWd1cmF0aW9uCgoKIyBoZWxwZXIgZnVuY3Rpb24gdG8gZm9ybSB0aGUgY29uZmlncyB0byBnZXQgYSBkaWFyaXplciBvYmplY3QKZGVmIF9nZXRfY2x1c3RlcmluZ19kaWFyaXplcigKICAgIG1hbmlmZXN0X2ZpbGVwYXRoOiBzdHIsCiAgICBhdWRpb19maWxlcGF0aDogc3RyLAogICAgb3V0X2Rpcjogc3RyLAogICAgcnR0bV9maWxlcGF0aDogc3RyID0gTm9uZSwKICAgIG9mZnNldDogaW50ID0gMCwKICAgIGR1cmF0aW9uOiBPcHRpb25hbFtmbG9hdF0gPSBOb25lLAogICAgbGFiZWw6IHN0ciA9ICJpbmZlciIsCiAgICB0ZXh0OiBzdHIgPSAiLSIsCiAgICBudW1fc3BlYWtlcnM6IGludCA9IDIsCiAgICB1ZW1fZmlsZXBhdGg6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgbnVtX3dvcmtlcnM6IGludCA9IDEsCiAgICBzYW1wbGVfcmF0ZTogaW50ID0gMTYwMDAsCiAgICBiYXRjaF9zaXplOiBpbnQgPSA2NCwKICAgIGRldmljZTogT3B0aW9uYWxbCiAgICAgICAgc3RyCiAgICBdID0gTm9uZSwgICMgU2V0IHRvICdjdWRhOjEnLCAoZGVmYXVsdCBjdWRhIGlmIGN1ZGEgYXZhaWxhYmxlLCBlbHNlIGNwdSkKICAgIHZlcmJvc2U6IGJvb2wgPSBUcnVlLAogICAgKiprd2FyZ3MsCikgLT4gQ2x1c3RlcmluZ0RpYXJpemVyOgogICAgIiIiCiAgICBIZWxwZXIgZnVuY3Rpb24gdG8gZm9ybSB0aGUgY29uZmlncyB0byBnZXQgYSBkaWFyaXplciBvYmplY3QuCiAgICBUbyBvdmVycmlkZSBhIHBhcmFtZXRlciBuZXN0ZWQgaW5zaWRlIGEgY29uZmlndXJhdGlvbiwgdGhlIHBhdHRlcm4gaXMgPGNvbmZpZ19uYW1lPl9fPHBhcmFtZXRlcl9uYW1lPl9fPGF0dHJpYnV0ZV9uYW1lPi4KCiAgICA6cGFyYW0gbnVtX3dvcmtlcnM6ICAgICAgIE51bWJlciBvZiB3b3JrZXJzIGZvciBjb21wdXRpbmcKICAgIDpwYXJhbSBzYW1wbGVfcmF0ZTogICAgICAgU2FtcGxlIHJhdGUgb2YgdGhlIGF1ZGlvCiAgICA6cGFyYW0gYmF0Y2hfc2l6ZTogICAgICAgIEJhdGNoIHNpemUgZm9yIGNvbXB1dGluZwogICAgOnBhcmFtIGRldmljZTogICAgICAgICAgICBEZXZpY2UgdG8gdXNlIGZvciBjb21wdXRpbmcKICAgIDpwYXJhbSB2ZXJib3NlOiAgICAgICAgICAgV2hldGhlciB0byBwcmludCBpbnRlcm1lZGlhdGUgb3V0cHV0cwogICAgOnBhcmFtIG1hbmlmZXN0X2ZpbGVwYXRoOiBQYXRoIHRvIHRoZSBtYW5pZmVzdCBmaWxlCiAgICA6cGFyYW0gYXVkaW9fZmlsZXBhdGg6ICAgIFBhdGggdG8gdGhlIGF1ZGlvIGZpbGUKICAgIDpwYXJhbSBydHRtX2ZpbGVwYXRoOiAgICAgUGF0aCB0byB0aGUgUlRUTSBmaWxlIGlmIGl0J3MgYSBncm91ZCB0cnV0aCBpbmZlcmVuY2UKICAgIDpwYXJhbSBvZmZzZXQ6ICAgICAgICAgICAgT2Zmc2V0IHZhbHVlCiAgICA6cGFyYW0gZHVyYXRpb246ICAgICAgICAgIER1cmF0aW9uIG9mIHRoZSBhdWRpbwogICAgOnBhcmFtIGxhYmVsOiAgICAgICAgICAgICBMYWJlbCBmb3IgdGhlIGF1ZGlvCiAgICA6cGFyYW0gdGV4dDogICAgICAgICAgICAgIFRleHQgcmVwcmVzZW50YXRpb24gb2YgdGhlIGF1ZGlvCiAgICA6cGFyYW0gbnVtX3NwZWFrZXJzOiAgICAgIE51bWJlciBvZiBzcGVha2VycyBpbiB0aGUgYXVkaW8KICAgIDpwYXJhbSB1ZW1fZmlsZXBhdGg6ICAgICAgUGF0aCB0byB0aGUgVUVNIGZpbGUKICAgIDpwYXJhbSBvdXRfZGlyOiAgICAgICAgICAgRGlyZWN0b3J5IHRvIHN0b3JlIGludGVybWVkaWF0ZSBmaWxlcyBhbmQgcHJlZGljdGlvbiBvdXRwdXRzCiAgICA6cGFyYW0ga3dhcmdzOiAgICAgICAgICAgIEFkZGl0aW9uYWwgYXJndW1lbnRzIHRvIG92ZXJyaWRlIGRlZmF1bHQgY29uZmlnIHZhbHVlcwoKICAgIDpyZXR1cm5zOiBDbHVzdGVyaW5nRGlhcml6ZXIgb2JqZWN0CiAgICAiIiIKICAgICMgQ3JlYXRlIHRoZSBnZW5lcmFsIGNvbmZpZwogICAgZ2VuZXJhbF9jb25maWcgPSBHZW5lcmFsQ29uZmlnKAogICAgICAgIG51bV93b3JrZXJzPW51bV93b3JrZXJzLAogICAgICAgIHNhbXBsZV9yYXRlPXNhbXBsZV9yYXRlLAogICAgICAgIGJhdGNoX3NpemU9YmF0Y2hfc2l6ZSwKICAgICAgICBkZXZpY2U9ZGV2aWNlLAogICAgICAgIHZlcmJvc2U9dmVyYm9zZSwKICAgICkKCiAgICAjIENyZWF0ZSB0aGUgbWFuaWZlc3QgZmlsZQogICAgbWV0YSA9IHsKICAgICAgICAiYXVkaW9fZmlsZXBhdGgiOiBhdWRpb19maWxlcGF0aCwKICAgICAgICAib2Zmc2V0Ijogb2Zmc2V0LAogICAgICAgICJkdXJhdGlvbiI6IGR1cmF0aW9uLAogICAgICAgICJsYWJlbCI6IGxhYmVsLAogICAgICAgICJ0ZXh0IjogdGV4dCwKICAgICAgICAibnVtX3NwZWFrZXJzIjogbnVtX3NwZWFrZXJzLAogICAgICAgICJydHRtX2ZpbGVwYXRoIjogcnR0bV9maWxlcGF0aCwKICAgICAgICAidWVtX2ZpbGVwYXRoIjogdWVtX2ZpbGVwYXRoLAogICAgfQoKICAgIHdpdGggb3BlbihtYW5pZmVzdF9maWxlcGF0aCwgInciKSBhcyBmcDoKICAgICAgICBqc29uLmR1bXAobWV0YSwgZnApCiAgICAgICAgZnAud3JpdGUoIlxuIikKCiAgICAjIEV4dHJhY3Rpbmcgc3BlY2lmaWMga3dhcmdzIGZvciBlYWNoIGNvbmZpZyBhbmQgdXBkYXRpbmcgdGhlbQogICAgdmFkX2t3YXJncyA9IHsKICAgICAgICBrLnNwbGl0KCJ2YWRfXyIpWzFdOiB2IGZvciBrLCB2IGluIGt3YXJncy5pdGVtcygpIGlmIGsuc3RhcnRzd2l0aCgidmFkX18iKQogICAgfQogICAgdmFkX3BhcmFtZXRlcnNfa3dhcmdzID0gewogICAgICAgIGsuc3BsaXQoInZhZF9fcGFyYW1ldGVyc19fIilbMV06IHYKICAgICAgICBmb3IgaywgdiBpbiBrd2FyZ3MuaXRlbXMoKQogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgidmFkX19wYXJhbWV0ZXJzX18iKQogICAgfQoKICAgIHNwZWFrZXJfZW1iZWRkaW5nc19rd2FyZ3MgPSB7CiAgICAgICAgay5zcGxpdCgic3BlYWtlcl9lbWJlZGRpbmdzX18iKVsxXTogdgogICAgICAgIGZvciBrLCB2IGluIGt3YXJncy5pdGVtcygpCiAgICAgICAgaWYgay5zdGFydHN3aXRoKCJzcGVha2VyX2VtYmVkZGluZ3NfXyIpCiAgICB9CiAgICBzcGVha2VyX3BhcmFtZXRlcnNfa3dhcmdzID0gewogICAgICAgIGsuc3BsaXQoInNwZWFrZXJfZW1iZWRkaW5nc19fcGFyYW1ldGVyc19fIilbMV06IHYKICAgICAgICBmb3IgaywgdiBpbiBrd2FyZ3MuaXRlbXMoKQogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgic3BlYWtlcl9lbWJlZGRpbmdzX19wYXJhbWV0ZXJzX18iKQogICAgfQoKICAgIGNsdXN0ZXJpbmdfa3dhcmdzID0gewogICAgICAgIGsuc3BsaXQoImNsdXN0ZXJpbmdfXyIpWzFdOiB2CiAgICAgICAgZm9yIGssIHYgaW4ga3dhcmdzLml0ZW1zKCkKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoImNsdXN0ZXJpbmdfXyIpCiAgICB9CiAgICBjbHVzdGVyaW5nX3BhcmFtZXRlcnNfa3dhcmdzID0gewogICAgICAgIGsuc3BsaXQoImNsdXN0ZXJpbmdfX3BhcmFtZXRlcnNfXyIpWzFdOiB2CiAgICAgICAgZm9yIGssIHYgaW4ga3dhcmdzLml0ZW1zKCkKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoImNsdXN0ZXJpbmdfX3BhcmFtZXRlcnNfXyIpCiAgICB9CgogICAgbXNkZF9tb2RlbF9rd2FyZ3MgPSB7CiAgICAgICAgay5zcGxpdCgibXNkZF9tb2RlbF9fIilbMV06IHYKICAgICAgICBmb3IgaywgdiBpbiBrd2FyZ3MuaXRlbXMoKQogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgibXNkZF9tb2RlbF9fIikKICAgIH0KICAgIG1zZGRfcGFyYW1ldGVyc19rd2FyZ3MgPSB7CiAgICAgICAgay5zcGxpdCgibXNkZF9tb2RlbF9fcGFyYW1ldGVyc19fIilbMV06IHYKICAgICAgICBmb3IgaywgdiBpbiBrd2FyZ3MuaXRlbXMoKQogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgibXNkZF9tb2RlbF9fcGFyYW1ldGVyc19fIikKICAgIH0KCiAgICAjIENvbnN0cnVjdGluZyB0aGUgbmVzdGVkIHBhcmFtZXRlciBjb25maWdzCiAgICB2YWRfcGFyYW1ldGVycyA9IFZBRFBhcmFtZXRlcnMoKip2YWRfcGFyYW1ldGVyc19rd2FyZ3MpCiAgICBzcGVha2VyX3BhcmFtZXRlcnMgPSBTcGVha2VyRW1iZWRkaW5nc1BhcmFtZXRlcnMoKipzcGVha2VyX3BhcmFtZXRlcnNfa3dhcmdzKQogICAgY2x1c3RlcmluZ19wYXJhbWV0ZXJzID0gQ2x1c3RlcmluZ1BhcmFtZXRlcnMoKipjbHVzdGVyaW5nX3BhcmFtZXRlcnNfa3dhcmdzKQogICAgbXNkZF9wYXJhbWV0ZXJzID0gTVNERFBhcmFtZXRlcnMoKiptc2RkX3BhcmFtZXRlcnNfa3dhcmdzKQoKICAgICMgQ29uc3RydWN0aW5nIHRoZSBjb25maWdzIHVzaW5nIHRoZSBuZXN0ZWQgcGFyYW1ldGVyIGNvbmZpZ3MKICAgIHZhZF9jb25maWcgPSBWQURDb25maWcocGFyYW1ldGVycz12YWRfcGFyYW1ldGVycywgKip2YWRfa3dhcmdzKQogICAgc3BlYWtlcl9lbWJlZGRpbmdzX2NvbmZpZyA9IFNwZWFrZXJFbWJlZGRpbmdzQ29uZmlnKAogICAgICAgIHBhcmFtZXRlcnM9c3BlYWtlcl9wYXJhbWV0ZXJzLCAqKnNwZWFrZXJfZW1iZWRkaW5nc19rd2FyZ3MKICAgICkKICAgIGNsdXN0ZXJpbmdfY29uZmlnID0gQ2x1c3RlcmluZ0NvbmZpZygKICAgICAgICBwYXJhbWV0ZXJzPWNsdXN0ZXJpbmdfcGFyYW1ldGVycywgKipjbHVzdGVyaW5nX2t3YXJncwogICAgKQogICAgbXNkZF9jb25maWcgPSBNU0REQ29uZmlnKHBhcmFtZXRlcnM9bXNkZF9wYXJhbWV0ZXJzLCAqKm1zZGRfbW9kZWxfa3dhcmdzKQoKICAgICMgQ29uc3RydWN0aW5nIHRoZSBtYWluIERpYXJpemF0aW9uQ29uZmlnCiAgICBkaWFyaXphdGlvbl9jb25maWcgPSBEaWFyaXphdGlvbkNvbmZpZygKICAgICAgICBtYW5pZmVzdF9maWxlcGF0aD1tYW5pZmVzdF9maWxlcGF0aCwKICAgICAgICBvdXRfZGlyPWt3YXJncy5nZXQoIm91dF9kaXIiLCAiIikgb3Igb3V0X2RpciwKICAgICAgICBvcmFjbGVfdmFkPWt3YXJncy5nZXQoIm9yYWNsZV92YWQiLCBGYWxzZSksCiAgICAgICAgY29sbGFyPWt3YXJncy5nZXQoImNvbGxhciIsIDAuMjUpLAogICAgICAgIGlnbm9yZV9vdmVybGFwPWt3YXJncy5nZXQoImlnbm9yZV9vdmVybGFwIiwgVHJ1ZSksCiAgICAgICAgdmFkPXZhZF9jb25maWcsCiAgICAgICAgc3BlYWtlcl9lbWJlZGRpbmdzPXNwZWFrZXJfZW1iZWRkaW5nc19jb25maWcsCiAgICAgICAgY2x1c3RlcmluZz1jbHVzdGVyaW5nX2NvbmZpZywKICAgICAgICBtc2RkX21vZGVsPW1zZGRfY29uZmlnLAogICAgKQoKICAgIGRpYXJpemF0aW9uX2NvbmZpZ19kaWN0ID0geyJkaWFyaXplciI6IGFzZGljdChkaWFyaXphdGlvbl9jb25maWcpfQogICAgZGlhcml6YXRpb25fY29uZmlnX2RpY3QudXBkYXRlKGFzZGljdChnZW5lcmFsX2NvbmZpZykpCiAgICBvbWVnYV9jb25maWcgPSBPbWVnYUNvbmYuY3JlYXRlKGRpYXJpemF0aW9uX2NvbmZpZ19kaWN0KQoKICAgIHJldHVybiBDbHVzdGVyaW5nRGlhcml6ZXIob21lZ2FfY29uZmlnKQoKCiMgSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnZlcnQgdGhlIGF1ZGlvIGZpbGUgdG8gMTZrIHNpbmdsZSBjaGFubmVsIHdhdiBmaWxlCmRlZiBfY29udmVydF90b19zdXBwb3J0X2Zvcm1hdChhdWRpb19maWxlX3BhdGg6IHN0cikgLT4gc3RyOgogICAgIiIiCiAgICBDb252ZXJ0cyB0aGUgYXVkaW8gZmlsZSB0byB3YXYgZm9ybWF0LiBDbHVzdGVyaW5nRGlhcml6ZXIgZXhwZWN0cyBzaWdubGUgY2hhbm5lbCAxNmsgd2F2IGZpbGUuCgogICAgOnBhcmFtIGF1ZGlvX2ZpbGVfcGF0aDogICBQYXRoIHRvIHRoZSBhdWRpbyBmaWxlCiAgICA6cmV0dXJucyBhdWRpb19maWxlX3BhdGg6IFBhdGggdG8gdGhlIGNvbnZlcnRlZCBhdWRpbyBmaWxlCiAgICAiIiIKICAgIGF1ZGlvX2ZpbGVfb2JqID0gcGF0aGxpYi5QYXRoKGF1ZGlvX2ZpbGVfcGF0aCkKICAgIHJlYWRfZnVuY19kaWN0ID0gewogICAgICAgICIubXAzIjogcHlkdWIuQXVkaW9TZWdtZW50LmZyb21fbXAzLAogICAgICAgICIuZmx2IjogcHlkdWIuQXVkaW9TZWdtZW50LmZyb21fZmx2LAogICAgICAgICIubXA0IjogcGFydGlhbChweWR1Yi5BdWRpb1NlZ21lbnQuZnJvbV9maWxlLCBmb3JtYXQ9Im1wNCIpLAogICAgICAgICIud21hIjogcGFydGlhbChweWR1Yi5BdWRpb1NlZ21lbnQuZnJvbV9maWxlLCBmb3JtYXQ9IndtYSIpLAogICAgfQogICAgIyBDaGVjayBpZiB0aGUgZmlsZSBpcyBhbHJlYWR5IGluIHN1cHBvcnRlZCBmb3JtYXQKICAgIGlmIGF1ZGlvX2ZpbGVfb2JqLnN1ZmZpeCA9PSAiLndhdiI6CiAgICAgICAgYXVkaW8gPSBBdWRpb1NlZ21lbnQuZnJvbV93YXYoYXVkaW9fZmlsZV9wYXRoLCBmb3JtYXQ9IndhdiIpCiAgICAgICAgaWYgYXVkaW8uY2hhbm5lbHMgIT0gMToKICAgICAgICAgICAgYXVkaW8gPSBhdWRpby5zZXRfY2hhbm5lbHMoMSkKICAgICAgICBpZiBhdWRpby5mcmFtZV9yYXRlICE9IDE2MDAwOgogICAgICAgICAgICBhdWRpbyA9IGF1ZGlvLnNldF9mcmFtZV9yYXRlKDE2MDAwKQogICAgICAgIGF1ZGlvLmV4cG9ydChhdWRpb19maWxlX3BhdGgsIGZvcm1hdD0id2F2IikKICAgICAgICByZXR1cm4gYXVkaW9fZmlsZV9wYXRoCiAgICBlbHNlOgogICAgICAgIHdhdl9maWxlID0gdGVtcGZpbGUubWtzdGVtcChwcmVmaXg9ImNvbnZlcnRlZF9hdWRpb18iLCBzdWZmaXg9Ii53YXYiKQogICAgICAgIGlmIGF1ZGlvX2ZpbGVfb2JqLnN1ZmZpeCBpbiByZWFkX2Z1bmNfZGljdC5rZXlzKCk6CiAgICAgICAgICAgIGF1ZGlvID0gcmVhZF9mdW5jX2RpY3RbYXVkaW9fZmlsZV9vYmouc3VmZml4XShhdWRpb19maWxlX3BhdGgpCiAgICAgICAgICAgIGlmIGF1ZGlvLmNoYW5uZWxzICE9IDE6CiAgICAgICAgICAgICAgICBhdWRpbyA9IGF1ZGlvLnNldF9jaGFubmVscygxKQogICAgICAgICAgICBpZiBhdWRpby5mcmFtZV9yYXRlICE9IDE2MDAwOgogICAgICAgICAgICAgICAgYXVkaW8gPSBhdWRpby5zZXRfZnJhbWVfcmF0ZSgxNjAwMCkKICAgICAgICAgICAgYXVkaW8uZXhwb3J0KHdhdl9maWxlWzFdLCBmb3JtYXQ9IndhdiIpCiAgICAgICAgICAgIHJldHVybiB3YXZfZmlsZVsxXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJVbnN1cHBvcnRlZCBhdWRpbyBmb3JtYXQge2F1ZGlvX2ZpbGVfb2JqLnN1ZmZpeH0iKQoKCmRlZiBfZGlhcml6ZV9zaW5nbGVfYXVkaW8oCiAgICBhdWRpb19maWxlX3BhdGg6IHN0ciwKICAgIG91dHB1dF9kaXI6IHN0ciwKICAgIG51bV9zcGVha2VyczogaW50ID0gMiwKICAgIHZhZF9tb2RlbDogc3RyID0gInZhZF9tdWx0aWxpbmd1YWxfbWFyYmxlbmV0IiwKICAgIHNwZWFrZXJfZW1iZWRkaW5nc19tb2RlbDogc3RyID0gInRpdGFuZXRfbGFyZ2UiLAogICAgbXNkZF9tb2RlbDogc3RyID0gImRpYXJfbXNkZF90ZWxlcGhvbmljIiwKICAgIGRldmljZTogT3B0aW9uYWxbCiAgICAgICAgc3RyCiAgICBdID0gTm9uZSwgICMgU2V0IHRvICdjdWRhOjEnLCAoZGVmYXVsdCBjdWRhIGlmIGN1ZGEgYXZhaWxhYmxlLCBlbHNlIGNwdSkKICAgICoqa3dhcmdzLAopIC0+IFR1cGxlW3N0ciwgc3RyXToKICAgICIiIgogICAgRGlhcml6ZXMgYSBzaW5nbGUgYXVkaW8gZmlsZSBhbmQgcmV0dXJucyB0aGUgZGlhcml6YXRpb24gcmVzdWx0cy4KCiAgICA6cGFyYW0gYXVkaW9fZmlsZV9wYXRoOiBQYXRoIHRvIHRoZSBhdWRpbyBmaWxlCiAgICA6cGFyYW0gb3V0cHV0X2RpcjogICAgICBQYXRoIHRvIHRoZSBvdXRwdXQgZGlyZWN0b3J5CiAgICA6cGFyYW0gbnVtX3NwZWFrZXJzOiAgICBOdW1iZXIgb2Ygc3BlYWtlcnMgaW4gdGhlIGF1ZGlvIGZpbGUKICAgIDpwYXJhbSB2YWRfbW9kZWw6ICAgICAgIE5hbWUgb2YgdGhlIFZBRCBtb2RlbCB0byB1c2UKICAgIDpwYXJhbSBzcGVha2VyX2VtYmVkZGluZ3NfbW9kZWw6IE5hbWUgb2YgdGhlIHNwZWFrZXIgZW1iZWRkaW5ncyBtb2RlbCB0byB1c2UKICAgIDpwYXJhbSBtc2RkX21vZGVsOiAgICAgIE5hbWUgb2YgdGhlIG1zZGQgbW9kZWwgdG8gdXNlCiAgICA6cGFyYW0gZGV2aWNlOiAgICAgICAgICBEZXZpY2UgdG8gdXNlIGZvciBkaWFyaXphdGlvbgogICAgOnBhcmFtIGt3YXJnczogICAgICAgICAgQWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgZGlhcml6ZXIgZm9sbG93aW5nIHRoZSBmb3JtYXQgPGNvbmZpZ19uYW1lPl9fPHBhcmFtZXRlcl9uYW1lPl9fPGF0dHJpYnV0ZV9uYW1lPi4KCiAgICA6cmV0dXJuczogVHVwbGUgb2YgdHdvIHBhdGhzOgogICAgICAgICAgICAgKiBwYXRoIG9mIHRoZSByZXN1bHQgb2YgdGhlIHBpcGVsaW5lCiAgICAgICAgICAgICAqIHBhdGggb2YgdGhlIGNvbnZlcnRlZCBhdWRpbyBmaWxlCgogICAgIiIiCiAgICAjIENvbnZlcnQgdGhlIGF1ZGlvIGZpbGUgdG8gc3VwcG9ydGVkIGZvcm1hdAogICAgYXVkaW9fZmlsZV9wYXRoID0gX2NvbnZlcnRfdG9fc3VwcG9ydF9mb3JtYXQoYXVkaW9fZmlsZV9wYXRoKQoKICAgICMgQ3JlYXRlIHRlbXBvcmFyeSBtYW5pZmVzdCBmaWxlCiAgICB3aXRoIHRlbXBmaWxlLk5hbWVkVGVtcG9yYXJ5RmlsZShzdWZmaXg9Ii5qc29uIiwgbW9kZT0idyIpIGFzIHRlbXBfbWFuaWZlc3Q6CiAgICAgICAgbWFuaWZlc3RfZGF0YSA9IHsKICAgICAgICAgICAgImF1ZGlvX2ZpbGVwYXRoIjogYXVkaW9fZmlsZV9wYXRoLAogICAgICAgICAgICAib2Zmc2V0IjogMCwKICAgICAgICAgICAgImR1cmF0aW9uIjogTm9uZSwKICAgICAgICAgICAgImxhYmVsIjogImluZmVyIiwKICAgICAgICAgICAgInRleHQiOiAiLSIsCiAgICAgICAgICAgICJudW1fc3BlYWtlcnMiOiBudW1fc3BlYWtlcnMsCiAgICAgICAgICAgICJ1ZW1fZmlsZXBhdGgiOiBOb25lLAogICAgICAgIH0KICAgICAgICBqc29uLmR1bXAobWFuaWZlc3RfZGF0YSwgdGVtcF9tYW5pZmVzdCkKICAgICAgICB0ZW1wX21hbmlmZXN0X3BhdGggPSB0ZW1wX21hbmlmZXN0Lm5hbWUKCiAgICAgICAgIyBDYWxsIHRoZSBfZ2V0X2NsdXN0ZXJpbmdfZGlhcml6ZXIgZnVuY3Rpb24KICAgICAgICBkaWFyaXplciA9IF9nZXRfY2x1c3RlcmluZ19kaWFyaXplcigKICAgICAgICAgICAgbWFuaWZlc3RfZmlsZXBhdGg9dGVtcF9tYW5pZmVzdF9wYXRoLAogICAgICAgICAgICBvdXRfZGlyPW91dHB1dF9kaXIsCiAgICAgICAgICAgIHZhZF9tb2RlbF9wYXRoPXZhZF9tb2RlbCwKICAgICAgICAgICAgc3BlYWtlcl9lbWJlZGRpbmdzX21vZGVsX3BhdGg9c3BlYWtlcl9lbWJlZGRpbmdzX21vZGVsLAogICAgICAgICAgICBtc2RkX21vZGVsX3BhdGg9bXNkZF9tb2RlbCwKICAgICAgICAgICAgYXVkaW9fZmlsZXBhdGg9YXVkaW9fZmlsZV9wYXRoLAogICAgICAgICAgICBkZXZpY2U9ZGV2aWNlLAogICAgICAgICAgICAqKmt3YXJncywKICAgICAgICApCgogICAgICAgICMgRGlhcml6ZSB0aGUgYXVkaW8gZmlsZQogICAgICAgIGRpYXJpemVyLmRpYXJpemUoKQogICAgcmV0dXJuIG91dHB1dF9kaXIsIGF1ZGlvX2ZpbGVfcGF0aAoKCmRlZiBfY29udmVydF9ydHRtX3RvX2Fubm90YXRpb25fZGYob3V0cHV0X2Rpcjogc3RyKSAtPiBUdXBsZVtwZC5EYXRhRnJhbWUsIEFubm90YXRpb25dOgogICAgIiIiCiAgICBDb252ZXJ0cyB0aGUgcnR0bSBmaWxlIHRvIGEgcHlhbm5vdGUuQW5ub3RhdGlvbiBhbmQgYSBwYW5kYXMgZGF0YWZyYW1lLgoKICAgIDpwYXJhbSBvdXRwdXRfZGlyOiAgIFBhdGggdG8gdGhlIG91dHB1dCBkaXJlY3RvcnkKICAgIDpyZXR1cm5zIGRmOiAgICAgICAgIFBhbmRhcyBkYXRhZnJhbWUgY29udGFpbmluZyB0aGUgZGlhcml6YXRpb24gcmVzdWx0cwogICAgOnJldHVybnMgYW5ub3RhdGlvbjogcHlhbm5vdGUuQW5ub3RhdGlvbiBjb250YWluaW5nIHRoZSBkaWFyaXphdGlvbiByZXN1bHRzCiAgICAiIiIKICAgIGZvciByb290LCBfLCBmaWxlcyBpbiBvcy53YWxrKG91dHB1dF9kaXIpOgogICAgICAgIGZvciBmaWxlIGluIGZpbGVzOgogICAgICAgICAgICBpZiBmaWxlLmVuZHN3aXRoKCIucnR0bSIpOgogICAgICAgICAgICAgICAgcnR0bV9maWxlID0gb3MucGF0aC5qb2luKHJvb3QsIGZpbGUpCiAgICAgICAgICAgICAgICBicmVhawogICAgcHJlZF9sYWJlbHMgPSBydHRtX3RvX2xhYmVscyhydHRtX2ZpbGUpCiAgICBhbm5vdGF0aW9uID0gbGFiZWxzX3RvX3B5YW5ub3RlX29iamVjdChwcmVkX2xhYmVscykKICAgIGxzdCA9IFtpdGVtLnNwbGl0KCIgIikgZm9yIGl0ZW0gaW4gcHJlZF9sYWJlbHNdCiAgICBsc3QgPSBbaXRlbSBmb3IgaXRlbSBpbiBsc3QgaWYgaXRlbV0KICAgIGRmID0gcGQuRGF0YUZyYW1lKGxzdCwgY29sdW1ucz1bInN0YXJ0IiwgImVuZCIsICJzcGVha2VyIl0pCiAgICByZXR1cm4gZGYsIGFubm90YXRpb24KCgpkZWYgZGlhcml6ZSgKICAgIGNvbnRleHQ6IG1scnVuLk1MQ2xpZW50Q3R4LAogICAgaW5wdXRfcGF0aDogc3RyLAogICAgb3V0cHV0X2Rpcjogc3RyLAogICAgY29uZGl0aW9uX3Nob3dfcGxvdDogYm9vbCA9IEZhbHNlLAogICAgbnVtX3NwZWFrZXJzOiBpbnQgPSAyLAogICAgdmFkX21vZGVsOiBzdHIgPSAidmFkX211bHRpbGluZ3VhbF9tYXJibGVuZXQiLAogICAgc3BlYWtlcl9lbWJlZGRpbmdzX21vZGVsOiBzdHIgPSAidGl0YW5ldF9sYXJnZSIsCiAgICBtc2RkX21vZGVsOiBzdHIgPSAiZGlhcl9tc2RkX3RlbGVwaG9uaWMiLAogICAgZGV2aWNlOiBPcHRpb25hbFsKICAgICAgICBzdHIKICAgIF0gPSBOb25lLCAgIyBTZXQgdG8gJ2N1ZGE6MScsIChkZWZhdWx0IGN1ZGEgaWYgY3VkYSBhdmFpbGFibGUsIGVsc2UgY3B1KQogICAgKiprd2FyZ3MsCik6CiAgICAiIiIKICAgIERpYXJpemUgYXVkaW8gZmlsZXMgaW50byBzcGVha2VyIHNlZ21lbnRzCiAgICBUaGUgZmluYWwgcmVzdWx0IGlzIGEgZGlyZWN0b3J5IGNvbnRhaW5pbmcgdGhlIGRpYXJpemF0aW9uIHJlc3VsdHMgaW4gdGhlIGZvcm0gY3N2IGZpbGVzLCBhIGRhdGFmcmFtZSB0aGF0IGhhcyB0aGUgbWFwcGluZyB3aXRoIHRoZSBhdWRpbyBmaWxlIHRvIHRoZSBjc3YgZmlsZXMKICAgIGFuZCBhIHBsb3Qgb2YgdGhlIGRpYXJpemF0aW9uIHJlc3VsdHMgaWYgY29uZGl0aW9uX3Nob3dfcGxvdCBpcyBzZXQgdG8gVHJ1ZS4gVGhlIGRhdGFmcmFtZSAoY3N2KSB3aWxsIGhhdmUgdGhlIGZvbGxvd2luZyBjb2x1bW5zOgoKICAgICogc3RhcnQ6IFN0YXJ0IHRpbWUgb2YgdGhlIHNwZWFrZXIgc2VnbWVudAogICAgKiBlbmQ6IEVuZCB0aW1lIG9mIHRoZSBzcGVha2VyIHNlZ21lbnQKICAgICogc3BlYWtlcjogU3BlYWtlciBsYWJlbAoKICAgIFRoZSBwYW5kYXMgZGF0YWZyYW1lIHdpbGwgaGF2ZSB0aGUgZm9sbG93aW5nIGZvcm1hdDoKCiAgICAqIG9yaWdpbmFsX2F1ZGlvX2ZpbGU6IFBhdGggdG8gdGhlIG9yaWdpbmFsIGF1ZGlvIGZpbGUKICAgICogcmVzdWx0IG9mIG1vZGVsOiBkaXJlY3Rvcnkgb2YgdGhlIGRpYXJpemF0aW9uIHJlc3VsdHMKICAgICogY29udmVydGVkX2F1ZGlvX2ZpbGU6IFBhdGggdG8gdGhlIGNvbnZlcnRlZCBhdWRpbyBmaWxlCiAgICAqIHNwZWFrZXJfc2VnbWVudHM6IFBhdGggdG8gdGhlIGRhdGFpdGVtIHRoYXQgaGFzIHRoZSBzcGVha2VyIGxhYmVscywgc3RhcnQsIGVuZAoKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgICAgICAgICAgIE1MUnVuIGNvbnRleHQKICAgIDpwYXJhbSBpbnB1dF9wYXRoOiAgICAgICAgICAgICAgIEEgZGlyZWN0b3J5IG9mIHRoZSBhdWRpbyBmaWxlcyBvciBhIHNpbmdsZSBmaWxlIHRvIGRpYXJpemUKICAgIDpwYXJhbSBvdXRwdXRfZGlyOiAgICAgICAgICAgICAgIFBhdGggdG8gdGhlIG91dHB1dCBkaXJlY3RvcnkgdGhpcyBpcyB3aGVyZSBuZW1vIHdpbGwgc3RvcmUgdGhlIGRpYXJpemF0aW9uIHJlc3VsdHMKICAgIDpwYXJhbSBjb25kaXRpb25fc2hvd19wbG90OiAgICAgIElmIHNldCB0byBUcnVlLCB0aGUgZGlhcml6YXRpb24gcmVzdWx0cyB3aWxsIGJlIHBsb3R0ZWQKICAgIDpwYXJhbSBudW1fc3BlYWtlcnM6ICAgICAgICAgICAgIE51bWJlciBvZiBzcGVha2VycyBpbiB0aGUgYXVkaW8gZmlsZQogICAgOnBhcmFtIHZhZF9tb2RlbDogICAgICAgICAgICAgICAgTmFtZSBvZiB0aGUgVkFEIG1vZGVsIHRvIHVzZQogICAgOnBhcmFtIHNwZWFrZXJfZW1iZWRkaW5nc19tb2RlbDogTmFtZSBvZiB0aGUgc3BlYWtlciBlbWJlZGRpbmdzIG1vZGVsIHRvIHVzZQogICAgOnBhcmFtIG1zZGRfbW9kZWw6ICAgICAgICAgICAgICAgTmFtZSBvZiB0aGUgbXNkZCBtb2RlbCB0byB1c2UKICAgIDpwYXJhbSBkZXZpY2U6ICAgICAgICAgICAgICAgICAgIERldmljZSB0byB1c2UgZm9yIGRpYXJpemF0aW9uIChkZWZhdWx0IGN1ZGEgaWYgY3VkYSBhdmFpbGFibGUsIGVsc2UgY3B1KQogICAgOnBhcmFtIGt3YXJnczogICAgICAgICAgICAgICAgICAgQWRkaXRpb25hbCBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgZGlhcml6ZXIgZm9sbG93aW5nIHRoZSBmb3JtYXQgPGNvbmZpZ19uYW1lPl9fPHBhcmFtZXRlcl9uYW1lPl9fPGF0dHJpYnV0ZV9uYW1lPi4KCiAgICA6cmV0dXJuczogQSB0dXBsZSBvZjoKICAgICAgICAgICAgICAqIFBhdGggdG8gdGhlIGRpYXJpemF0aW9uIHJlc3VsdHMgKHBhbmRhcyBkYXRhZnJhbWUpCiAgICAgICAgICAgICAgKiBBIGRpY3Rpb25hcnkgb2YgZXJyb3JlZCBmaWxlcyB0aGF0IHdlcmUgbm90IGRpYXJpemVkCiAgICAiIiIKICAgICMgU2V0IG91dHB1dCBkaXJlY3Rvcnk6CiAgICBpZiBvdXRwdXRfZGlyZWN0b3J5IGlzIE5vbmU6CiAgICAgICAgb3V0cHV0X2RpcmVjdG9yeSA9IHRlbXBmaWxlLm1rZHRlbXAoKQoKICAgICMgUHJlcGFyZSB0aGUgZGF0YWZyYW1lIGFuZCBlcnJvcnMgdG8gYmUgcmV0dXJuZWQ6CiAgICBkZiA9IHBkLkRhdGFGcmFtZSgKICAgICAgICBjb2x1bW5zPVsKICAgICAgICAgICAgImF1ZGlvX2ZpbGUiLAogICAgICAgICAgICAiZGlhcml6YXRpb25fcmVzdWx0cyIsCiAgICAgICAgICAgICJjb252ZXJ0ZWRfYXVkaW9fZmlsZSIsCiAgICAgICAgICAgICJzcGVha2VyX3NlZ21lbnRzIiwKICAgICAgICBdCiAgICApCgogICAgZXJyb3JzID0ge30KCiAgICAjIENyZWF0ZSB0aGUgb3V0cHV0IGRpcmVjdG9yeToKICAgIG91dHB1dF9kaXJlY3RvcnkgPSBwYXRobGliLlBhdGgob3V0cHV0X2RpcmVjdG9yeSkKICAgIGlmIG5vdCBvdXRwdXRfZGlyZWN0b3J5LmV4aXN0cygpOgogICAgICAgIG91dHB1dF9kaXJlY3RvcnkubWtkaXIoKQoKICAgICMgR28gb3ZlciB0aGUgYXVkaW8gZmlsZXMgYW5kIHRyYW5zY3JpYmU6CiAgICBhdWRpb19maWxlc19wYXRoID0gcGF0aGxpYi5QYXRoKGlucHV0X3BhdGgpLmFic29sdXRlKCkKICAgIGlzX2RpciA9IFRydWUKICAgIGlmIGF1ZGlvX2ZpbGVzX3BhdGguaXNfZGlyKCk6CiAgICAgICAgYXVkaW9fZmlsZXMgPSBsaXN0KGF1ZGlvX2ZpbGVzX3BhdGgucmdsb2IoIiouKiIpKQogICAgZWxpZiBhdWRpb19maWxlc19wYXRoLmlzX2ZpbGUoKToKICAgICAgICBpc19kaXIgPSBGYWxzZQogICAgICAgIGF1ZGlvX2ZpbGVzID0gW2F1ZGlvX2ZpbGVzX3BhdGhdCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoCiAgICAgICAgICAgIGYiYXVkaW9fZmlsZXMge3N0cihhdWRpb19maWxlc19wYXRoKX0gbXVzdCBiZSBlaXRoZXIgYSBkaXJlY3RvcnkgcGF0aCBvciBhIGZpbGUgcGF0aCIKICAgICAgICApCgogICAgZm9yIGksIGF1ZGlvX2ZpbGUgaW4gZW51bWVyYXRlKHRxZG0oYXVkaW9fZmlsZXMsIGRlc2M9IkRpYXJpemluZyIsIHVuaXQ9ImZpbGUiKSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBvdXRwdXRfZGlyID0gb3V0cHV0X2RpcmVjdG9yeSAvIGYie2F1ZGlvX2ZpbGUuc3RlbX1fe2l9IgogICAgICAgICAgICBvdXRwdXRfZGlyLCBjb252ZXJ0ZWRfYXVkaW9fZmlsZV9wYXRoID0gX2RpYXJpemVfc2luZ2xlX2ZpbGUoCiAgICAgICAgICAgICAgICBhdWRpb19maWxlPWF1ZGlvX2ZpbGUsCiAgICAgICAgICAgICAgICBvdXRwdXRfZGlyPW91dHB1dF9kaXIsCiAgICAgICAgICAgICAgICBudW1fc3BlYWtlcnM9bnVtX3NwZWFrZXJzLAogICAgICAgICAgICAgICAgdmFkX21vZGVsPXZhZF9tb2RlbCwKICAgICAgICAgICAgICAgIHNwZWFrZXJfZW1iZWRkaW5nc19tb2RlbD1zcGVha2VyX2VtYmVkZGluZ3NfbW9kZWwsCiAgICAgICAgICAgICAgICBtc2RkX21vZGVsPW1zZGRfbW9kZWwsCiAgICAgICAgICAgICAgICBkZXZpY2U9ZGV2aWNlLAogICAgICAgICAgICAgICAgKiprd2FyZ3MsCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4Y2VwdGlvbjoKICAgICAgICAgICAgIyBDb2xsZWN0IHRoZSBleGNlcHRpb246CiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLndhcm4oZiJFcnJvciBpbiBmaWxlOiAne2F1ZGlvX2ZpbGV9JyIpCiAgICAgICAgICAgIGVycm9yc1tzdHIoYXVkaW9fZmlsZSldID0gc3RyKGV4Y2VwdGlvbikKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIENvbnZlcnQgdGhlIHJ0dG0gZmlsZSB0byBhIHBhbmRhcyBkYXRhZnJhbWUgYW5kIGEgcHlhbm5vdGUuQW5ub3RhdGlvbjoKICAgICAgICAgICAgZGYsIGFubm90YXRpb24gPSBfY29udmVydF9ydHRtX3RvX2Fubm90YXRpb25fZGYob3V0cHV0X2RpcikKICAgICAgICAgICAgbG9jYWxzKClbZiJ7YXVkaW9fZmlsZS5zdGVtfV9zZWdtZW50c19kZiJdID0gZGYKCiAgICAgICAgICAgIGNvbnRleHQubG9nX2RhdGFzZXQoCiAgICAgICAgICAgICAgICBmInthdWRpb19maWxlLnN0ZW19X3NlZ21lbnRzX2RmIiwKICAgICAgICAgICAgICAgIGRmPWxvY2FscygpW2Yie2F1ZGlvX2ZpbGUuc3RlbX1fc2VnbWVudHNfZGYiXSwKICAgICAgICAgICAgICAgIGluZGV4PUZhbHNlLAogICAgICAgICAgICAgICAgZm9ybWF0PSJjc3YiLAogICAgICAgICAgICApCgogICAgICAgICAgICAjIE5vdGUgaW4gdGhlIGRhdGFmcmFtZToKICAgICAgICAgICAgZGYubG9jW2kgLSBsZW4oZXJyb3JzKV0gPSBbCiAgICAgICAgICAgICAgICBzdHIoYXVkaW9fZmlsZS5yZWxhdGl2ZV90byhhdWRpb19maWxlc19wYXRoKSksCiAgICAgICAgICAgICAgICBzdHIob3V0cHV0X2Rpci5yZWxhdGl2ZV90byhvdXRwdXRfZGlyZWN0b3J5KSksCiAgICAgICAgICAgICAgICBjb252ZXJ0ZWRfYXVkaW9fZmlsZV9wYXRoLAogICAgICAgICAgICAgICAgY29udGV4dC5nZXRfZGF0YWl0ZW0oZiJ7YXVkaW9fZmlsZS5zdGVtfV9zZWdtZW50c19kZiIpLmFydGlmYWN0X3VybCwKICAgICAgICAgICAgXQoKICAgICMgUmV0dXJuIHRoZSBkYXRhZnJhbWU6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYiRG9uZTpcbntkZi5oZWFkKCl9IikKCiAgICByZXR1cm4gb3V0cHV0X2RpcmVjdG9yeSwgZGYsIGVycm9ycwo=
    commands:
    - python -m pip install tqdm librora Cython Cmake 'pyannote.core[notebook]' torch
      torchaudio pydub 'nemo_toolkit[all]'
    code_origin: git@github.com-personal:pengwei715/functions.git#0fb3569e10c813297f7873521cf1b5cfd14f6250:/Users/Peng_Wei/work/mlrun_related/functions/speaker_diarization/speaker_diarization.py
    origin_filename: /Users/Peng_Wei/work/mlrun_related/functions/speaker_diarization/speaker_diarization.py
  entry_points:
    diarize:
      name: diarize
      doc: 'Diarize audio files into speaker segments

        The final result is a directory containing the diarization results in the
        form csv files, a dataframe that has the mapping with the audio file to the
        csv files

        and a plot of the diarization results if condition_show_plot is set to True.
        The dataframe (csv) will have the following columns:


        * start: Start time of the speaker segment

        * end: End time of the speaker segment

        * speaker: Speaker label


        The pandas dataframe will have the following format:


        * original_audio_file: Path to the original audio file

        * result of model: directory of the diarization results

        * converted_audio_file: Path to the converted audio file

        * speaker_segments: Path to the dataitem that has the speaker labels, start,
        end'
      parameters:
      - name: context
        type: MLClientCtx
        doc: MLRun context
        default: ''
      - name: input_path
        type: str
        doc: A directory of the audio files or a single file to diarize
        default: ''
      - name: output_dir
        type: str
        doc: Path to the output directory this is where nemo will store the diarization
          results
        default: ''
      - name: condition_show_plot
        type: bool
        doc: If set to True, the diarization results will be plotted
        default: false
      - name: num_speakers
        type: int
        doc: Number of speakers in the audio file
        default: 2
      - name: vad_model
        type: str
        doc: Name of the VAD model to use
        default: vad_multilingual_marblenet
      - name: speaker_embeddings_model
        type: str
        doc: Name of the speaker embeddings model to use
        default: titanet_large
      - name: msdd_model
        type: str
        doc: Name of the msdd model to use
        default: diar_msdd_telephonic
      - name: device
        type: Optional[str]
        doc: Device to use for diarization (default cuda if cuda available, else cpu)
        default: null
      outputs:
      - default: ''
        doc: 'A tuple of: * Path to the diarization results (pandas dataframe) * A
          dictionary of errored files that were not diarized'
      lineno: 451
  description: speaker diarization on the audio file
  default_handler: diarize
  disable_auto_mount: false
  env: []
  priority_class_name: ''
  preemption_mode: prevent
  affinity: null
  tolerations: null
  security_context: {}
verbose: false
